# QAS-105 Organization Structure Setup Guide

## Overview

This guide provides data migration scripts to populate Department and Position models based on the official QAS-105 organizational structure document.

**Status:** Models verified, migration scripts ready to execute
**Created:** 2025-11-21
**Part of:** Model Ownership Refactoring - Part 2

---

## Models Verified

All required models already exist and are properly configured:

### 1. Department Model ✅
**Location:** `floor_app/operations/hr/models/department.py`

**Key Fields:**
- `name` - Department name (unique)
- `description` - Department description
- `department_type` - Category (PRODUCTION, SUPPORT, MANAGEMENT, OTHER)
- `cost_center` - FK to core.CostCenter
- `erp_department_code` - ERP integration
- Timestamps: `created_at`, `updated_at`

### 2. Position Model ✅
**Location:** `floor_app/operations/hr/models/position.py`

**Key Fields:**
- `name` - Position title (unique)
- `description` - Position description
- `department` - FK to Department (PROTECT, related_name='positions')
- `position_level` - Seniority level (ENTRY, JUNIOR, SENIOR, SUPERVISOR, MANAGER, DIRECTOR)
- `salary_grade` - Salary grade (GRADE_A through GRADE_E, EXECUTIVE)
- `is_active` - Active status
- `auth_group` - Django auth Group for RBAC
- Mixins: HRAuditMixin, HRSoftDeleteMixin

### 3. Employee Model ✅
**Location:** `floor_app/operations/hr/models/employee.py`

**Key Relationships:**
- `position` - FK to Position (SET_NULL, related_name='employees')
- `department` - FK to Department (SET_NULL, related_name='employees')
- Both fields nullable for migration safety

---

## QAS-105 Organizational Structure

### Top-Level Departments

1. **General Management (GM)** - Executive leadership
2. **Technology (TECH)** - Engineering & R&D
3. **Sales & Field Operations (SALES)** - Sales and field services
4. **Supply Chain & Logistics (SUPPLY)** - Procurement and inventory
5. **Operations / Manufacturing (OPS)** - Production operations
6. **Quality Assurance/Quality Control (QA)** - Quality management
7. **Health, Safety, Security & Environment (HSSE)** - HSE compliance
8. **Human Resources & Administration (HR)** - HR management
9. **Finance & Accounting (FIN)** - Financial management
10. **IT & ERP Systems (IT_ERP)** - IT infrastructure

### Sub-Departments (Under Operations)

- **FC Repair & Refurbishment (FC_REPAIR)** - Fixed cutter repair operations
- **New Bit Manufacturing (NEW_BIT)** - New bit production
- **Maintenance (MAINT)** - Equipment and facility maintenance

---

## Migration Scripts

### Part 1: Create Departments Data Migration

**File to create:** `floor_app/operations/hr/migrations/XXXX_create_qas105_departments.py`

**How to create:**
```bash
# Create empty data migration
python manage.py makemigrations hr --empty --name create_qas105_departments
```

**Migration script:**

```python
# Generated by Django - Update dependency number
from django.db import migrations


def create_qas105_departments(apps, schema_editor):
    """
    Create departments based on QAS-105 organizational structure.
    """
    Department = apps.get_model('hr', 'Department')

    # Top-level departments
    departments = [
        {
            'name': 'General Management',
            'description': 'Executive leadership and overall company management',
            'department_type': 'MANAGEMENT',
            'erp_department_code': 'GM'
        },
        {
            'name': 'Technology (Engineering)',
            'description': 'Engineering, R&D, product development, and technical innovation',
            'department_type': 'PRODUCTION',
            'erp_department_code': 'TECH'
        },
        {
            'name': 'Sales & Field Operations',
            'description': 'Sales, marketing, and field service operations',
            'department_type': 'SUPPORT',
            'erp_department_code': 'SALES'
        },
        {
            'name': 'Supply Chain & Logistics',
            'description': 'Procurement, purchasing, inventory control, and logistics',
            'department_type': 'SUPPORT',
            'erp_department_code': 'SUPPLY'
        },
        {
            'name': 'Operations / Manufacturing',
            'description': 'Production operations and manufacturing',
            'department_type': 'PRODUCTION',
            'erp_department_code': 'OPS'
        },
        {
            'name': 'Quality Assurance/Quality Control',
            'description': 'Quality management, inspection, and compliance',
            'department_type': 'SUPPORT',
            'erp_department_code': 'QA'
        },
        {
            'name': 'Health, Safety, Security & Environment',
            'description': 'HSE compliance, safety management, and environmental protection',
            'department_type': 'SUPPORT',
            'erp_department_code': 'HSSE'
        },
        {
            'name': 'Human Resources & Administration',
            'description': 'HR management, recruitment, training, and administration',
            'department_type': 'SUPPORT',
            'erp_department_code': 'HR'
        },
        {
            'name': 'Finance & Accounting',
            'description': 'Financial management, accounting, and reporting',
            'department_type': 'SUPPORT',
            'erp_department_code': 'FIN'
        },
        {
            'name': 'IT & ERP Systems',
            'description': 'Information technology infrastructure and ERP system management',
            'department_type': 'SUPPORT',
            'erp_department_code': 'IT_ERP'
        },
    ]

    # Create top-level departments
    created_count = 0
    for dept_data in departments:
        dept, created = Department.objects.get_or_create(
            name=dept_data['name'],
            defaults=dept_data
        )
        if created:
            created_count += 1
            print(f"Created department: {dept.name}")
        else:
            print(f"Department already exists: {dept.name}")

    # Sub-departments (under Operations)
    try:
        ops_dept = Department.objects.get(name='Operations / Manufacturing')

        sub_departments = [
            {
                'name': 'FC Repair & Refurbishment',
                'description': 'Fixed cutter repair, refurbishment, and retrofit operations',
                'department_type': 'PRODUCTION',
                'erp_department_code': 'FC_REPAIR',
                'parent': ops_dept
            },
            {
                'name': 'New Bit Manufacturing',
                'description': 'New bit production and assembly operations',
                'department_type': 'PRODUCTION',
                'erp_department_code': 'NEW_BIT',
                'parent': ops_dept
            },
            {
                'name': 'Maintenance',
                'description': 'Equipment and facility maintenance',
                'department_type': 'SUPPORT',
                'erp_department_code': 'MAINT',
                'parent': ops_dept
            },
        ]

        # Note: Parent field doesn't exist in current Department model
        # These will be created as independent departments for now
        for sub_dept_data in sub_departments:
            parent = sub_dept_data.pop('parent', None)  # Remove parent if exists
            sub_dept, created = Department.objects.get_or_create(
                name=sub_dept_data['name'],
                defaults=sub_dept_data
            )
            if created:
                created_count += 1
                print(f"Created sub-department: {sub_dept.name}")
            else:
                print(f"Sub-department already exists: {sub_dept.name}")

    except Department.DoesNotExist:
        print("Warning: Operations department not found. Skipping sub-departments.")

    print(f"\nTotal departments created: {created_count}")
    print(f"Total departments in system: {Department.objects.count()}")


def reverse_qas105_departments(apps, schema_editor):
    """
    Reverse migration - delete QAS-105 departments.
    """
    Department = apps.get_model('hr', 'Department')

    department_names = [
        'General Management',
        'Technology (Engineering)',
        'Sales & Field Operations',
        'Supply Chain & Logistics',
        'Operations / Manufacturing',
        'Quality Assurance/Quality Control',
        'Health, Safety, Security & Environment',
        'Human Resources & Administration',
        'Finance & Accounting',
        'IT & ERP Systems',
        'FC Repair & Refurbishment',
        'New Bit Manufacturing',
        'Maintenance',
    ]

    deleted_count, _ = Department.objects.filter(name__in=department_names).delete()
    print(f"Deleted {deleted_count} QAS-105 departments")


class Migration(migrations.Migration):

    dependencies = [
        ('hr', '0001_initial'),  # Update to actual last migration
    ]

    operations = [
        migrations.RunPython(
            create_qas105_departments,
            reverse_qas105_departments
        ),
    ]
```

---

### Part 2: Create Positions Data Migration

**File to create:** `floor_app/operations/hr/migrations/XXXX_create_qas105_positions.py`

**How to create:**
```bash
# Create empty data migration
python manage.py makemigrations hr --empty --name create_qas105_positions
```

**Migration script:**

```python
# Generated by Django - Update dependency number
from django.db import migrations


def create_qas105_positions(apps, schema_editor):
    """
    Create positions based on QAS-105 Job Titles, Responsibilities, Authorities & Accountabilities.
    """
    Department = apps.get_model('hr', 'Department')
    Position = apps.get_model('hr', 'Position')

    # Define positions by department
    positions_data = []

    # Get departments (with error handling)
    def get_dept(name):
        try:
            return Department.objects.get(name=name)
        except Department.DoesNotExist:
            print(f"Warning: Department '{name}' not found. Skipping positions for this department.")
            return None

    gm_dept = get_dept('General Management')
    tech_dept = get_dept('Technology (Engineering)')
    sales_dept = get_dept('Sales & Field Operations')
    supply_dept = get_dept('Supply Chain & Logistics')
    ops_dept = get_dept('Operations / Manufacturing')
    fc_repair_dept = get_dept('FC Repair & Refurbishment')
    qa_dept = get_dept('Quality Assurance/Quality Control')
    hsse_dept = get_dept('Health, Safety, Security & Environment')
    hr_dept = get_dept('Human Resources & Administration')
    fin_dept = get_dept('Finance & Accounting')
    it_erp_dept = get_dept('IT & ERP Systems')

    # General Management Positions
    if gm_dept:
        positions_data.extend([
            {
                'name': 'General Manager (GM)',
                'description': 'Overall company leadership and strategic direction',
                'department': gm_dept,
                'position_level': 'DIRECTOR',
                'salary_grade': 'EXECUTIVE',
            },
        ])

    # Technology / Engineering Positions
    if tech_dept:
        positions_data.extend([
            {
                'name': 'Technology Manager (TM)',
                'description': 'Manages engineering team, R&D initiatives, and technical innovation',
                'department': tech_dept,
                'position_level': 'MANAGER',
                'salary_grade': 'GRADE_A',
            },
            {
                'name': 'Application Design Engineer (ADE)',
                'description': 'Designs bit applications for specific drilling conditions and customer requirements',
                'department': tech_dept,
                'position_level': 'SENIOR',
                'salary_grade': 'GRADE_B',
            },
            {
                'name': 'Application Engineer (AE)',
                'description': 'Provides technical support for bit selection and application',
                'department': tech_dept,
                'position_level': 'SENIOR',
                'salary_grade': 'GRADE_B',
            },
            {
                'name': 'Product Engineer (PE)',
                'description': 'Develops and improves bit designs and manufacturing processes',
                'department': tech_dept,
                'position_level': 'SENIOR',
                'salary_grade': 'GRADE_B',
            },
            {
                'name': 'Manufacturing Engineer (ME)',
                'description': 'Optimizes manufacturing processes and production efficiency',
                'department': tech_dept,
                'position_level': 'SENIOR',
                'salary_grade': 'GRADE_B',
            },
        ])

    # Sales & Field Operations Positions
    if sales_dept:
        positions_data.extend([
            {
                'name': 'Sales Manager',
                'description': 'Manages sales team, customer relationships, and revenue targets',
                'department': sales_dept,
                'position_level': 'MANAGER',
                'salary_grade': 'GRADE_A',
            },
            {
                'name': 'Field Service Engineer (FSE)',
                'description': 'Provides field technical support, bit performance analysis, and customer training',
                'department': sales_dept,
                'position_level': 'SENIOR',
                'salary_grade': 'GRADE_B',
            },
            {
                'name': 'Sales Representative',
                'description': 'Develops customer relationships and drives sales',
                'department': sales_dept,
                'position_level': 'SENIOR',
                'salary_grade': 'GRADE_C',
            },
        ])

    # Supply Chain & Logistics Positions
    if supply_dept:
        positions_data.extend([
            {
                'name': 'Supply Chain Manager',
                'description': 'Manages procurement, purchasing, and logistics operations',
                'department': supply_dept,
                'position_level': 'MANAGER',
                'salary_grade': 'GRADE_A',
            },
            {
                'name': 'Buyer / Purchasing Agent',
                'description': 'Purchases materials, components, and services',
                'department': supply_dept,
                'position_level': 'JUNIOR',
                'salary_grade': 'GRADE_D',
            },
            {
                'name': 'Inventory Controller',
                'description': 'Manages inventory levels, stock tracking, and warehouse operations',
                'department': supply_dept,
                'position_level': 'JUNIOR',
                'salary_grade': 'GRADE_D',
            },
        ])

    # Operations / Manufacturing Positions
    if ops_dept:
        positions_data.extend([
            {
                'name': 'Operations Manager',
                'description': 'Oversees all manufacturing and production operations',
                'department': ops_dept,
                'position_level': 'MANAGER',
                'salary_grade': 'GRADE_A',
            },
            {
                'name': 'Production Supervisor',
                'description': 'Supervises production floor operations and personnel',
                'department': ops_dept,
                'position_level': 'SUPERVISOR',
                'salary_grade': 'GRADE_C',
            },
        ])

    # FC Repair & Refurbishment Positions (Critical for user's role)
    if fc_repair_dept:
        positions_data.extend([
            {
                'name': 'FC Refurbish Supervisor',
                'description': 'Current title for FC repair and new bit production supervision. '
                              'Oversees FC repair operations, coordinates repair schedules, and ensures quality standards. '
                              'Functionally equivalent to Repair Coordinator role from QAS-105.',
                'department': fc_repair_dept,
                'position_level': 'SUPERVISOR',
                'salary_grade': 'GRADE_C',
            },
            {
                'name': 'Repair Coordinator',
                'description': 'From QAS-105. Coordinates repair activities and schedules. '
                              'This may be a legacy position title, now typically called FC Refurbish Supervisor.',
                'department': fc_repair_dept,
                'position_level': 'SUPERVISOR',
                'salary_grade': 'GRADE_C',
            },
            {
                'name': 'Repair Supervisor',
                'description': 'Supervises repair technicians and repair operations',
                'department': fc_repair_dept,
                'position_level': 'SUPERVISOR',
                'salary_grade': 'GRADE_C',
            },
            {
                'name': 'Repair Technician',
                'description': 'Performs FC bit repair, refurbishment, and quality checks',
                'department': fc_repair_dept,
                'position_level': 'JUNIOR',
                'salary_grade': 'GRADE_D',
            },
        ])

    # Quality Assurance/QC Positions
    if qa_dept:
        positions_data.extend([
            {
                'name': 'Quality Assurance Manager',
                'description': 'Manages quality systems, compliance, and continuous improvement',
                'department': qa_dept,
                'position_level': 'MANAGER',
                'salary_grade': 'GRADE_A',
            },
            {
                'name': 'QA/QC Coordinator',
                'description': 'Coordinates quality control activities and documentation',
                'department': qa_dept,
                'position_level': 'SUPERVISOR',
                'salary_grade': 'GRADE_C',
            },
            {
                'name': 'QC Inspector',
                'description': 'Performs quality inspections and testing',
                'department': qa_dept,
                'position_level': 'JUNIOR',
                'salary_grade': 'GRADE_D',
            },
        ])

    # HSSE Positions
    if hsse_dept:
        positions_data.extend([
            {
                'name': 'HSE Manager',
                'description': 'Manages health, safety, security, and environmental compliance',
                'department': hsse_dept,
                'position_level': 'MANAGER',
                'salary_grade': 'GRADE_A',
            },
            {
                'name': 'Safety Coordinator',
                'description': 'Coordinates safety programs, training, and incident investigations',
                'department': hsse_dept,
                'position_level': 'SUPERVISOR',
                'salary_grade': 'GRADE_C',
            },
        ])

    # Human Resources Positions
    if hr_dept:
        positions_data.extend([
            {
                'name': 'HR Manager',
                'description': 'Manages HR operations, recruitment, and employee relations',
                'department': hr_dept,
                'position_level': 'MANAGER',
                'salary_grade': 'GRADE_A',
            },
            {
                'name': 'HR Coordinator',
                'description': 'Coordinates HR activities, onboarding, and documentation',
                'department': hr_dept,
                'position_level': 'JUNIOR',
                'salary_grade': 'GRADE_D',
            },
        ])

    # Finance & Accounting Positions
    if fin_dept:
        positions_data.extend([
            {
                'name': 'Financial Controller',
                'description': 'Manages financial operations, reporting, and controls',
                'department': fin_dept,
                'position_level': 'MANAGER',
                'salary_grade': 'GRADE_A',
            },
            {
                'name': 'Accountant',
                'description': 'Performs accounting, bookkeeping, and financial reporting',
                'department': fin_dept,
                'position_level': 'JUNIOR',
                'salary_grade': 'GRADE_D',
            },
        ])

    # IT & ERP Positions
    if it_erp_dept:
        positions_data.extend([
            {
                'name': 'IT/ERP Manager',
                'description': 'Manages IT infrastructure, ERP systems, and digital transformation',
                'department': it_erp_dept,
                'position_level': 'MANAGER',
                'salary_grade': 'GRADE_A',
            },
            {
                'name': 'System Administrator',
                'description': 'Manages IT systems, networks, and infrastructure',
                'department': it_erp_dept,
                'position_level': 'JUNIOR',
                'salary_grade': 'GRADE_D',
            },
            {
                'name': 'ERP Administrator',
                'description': 'Administers and maintains ERP system',
                'department': it_erp_dept,
                'position_level': 'JUNIOR',
                'salary_grade': 'GRADE_D',
            },
        ])

    # Create positions
    created_count = 0
    for pos_data in positions_data:
        pos, created = Position.objects.get_or_create(
            name=pos_data['name'],
            defaults=pos_data
        )
        if created:
            created_count += 1
            print(f"Created position: {pos.name} ({pos.department.name})")
        else:
            print(f"Position already exists: {pos.name}")

    print(f"\nTotal positions created: {created_count}")
    print(f"Total positions in system: {Position.objects.count()}")


def reverse_qas105_positions(apps, schema_editor):
    """
    Reverse migration - delete all positions (be careful with this in production!).
    """
    Position = apps.get_model('hr', 'Position')

    # Only delete positions we created
    position_names = [
        'General Manager (GM)',
        'Technology Manager (TM)',
        'Application Design Engineer (ADE)',
        'Application Engineer (AE)',
        'Product Engineer (PE)',
        'Manufacturing Engineer (ME)',
        'Sales Manager',
        'Field Service Engineer (FSE)',
        'Sales Representative',
        'Supply Chain Manager',
        'Buyer / Purchasing Agent',
        'Inventory Controller',
        'Operations Manager',
        'Production Supervisor',
        'FC Refurbish Supervisor',
        'Repair Coordinator',
        'Repair Supervisor',
        'Repair Technician',
        'Quality Assurance Manager',
        'QA/QC Coordinator',
        'QC Inspector',
        'HSE Manager',
        'Safety Coordinator',
        'HR Manager',
        'HR Coordinator',
        'Financial Controller',
        'Accountant',
        'IT/ERP Manager',
        'System Administrator',
        'ERP Administrator',
    ]

    deleted_count, _ = Position.objects.filter(name__in=position_names).delete()
    print(f"Deleted {deleted_count} QAS-105 positions")


class Migration(migrations.Migration):

    dependencies = [
        ('hr', 'XXXX_create_qas105_departments'),  # Update to actual department migration
    ]

    operations = [
        migrations.RunPython(
            create_qas105_positions,
            reverse_qas105_positions
        ),
    ]
```

---

## Execution Instructions

### Step 1: Create Migration Files

Once Python environment is available:

```bash
# Navigate to project directory
cd /home/user/Floor-Management-System

# Activate virtual environment
source .venv/bin/activate  # or your venv path

# Create department migration
python manage.py makemigrations hr --empty --name create_qas105_departments

# Copy the department migration script from above into the generated file

# Create position migration
python manage.py makemigrations hr --empty --name create_qas105_positions

# Copy the position migration script from above into the generated file
```

### Step 2: Update Migration Dependencies

Edit the generated migration files and update the `dependencies` list:
- Department migration: Update to reference the actual last HR migration
- Position migration: Update to reference the department migration you just created

### Step 3: Apply Migrations

```bash
# Apply department migration
python manage.py migrate hr

# Verify departments were created
python manage.py shell
>>> from floor_app.operations.hr.models import Department
>>> Department.objects.count()
>>> Department.objects.values_list('name', flat=True)

# Apply position migration
python manage.py migrate hr

# Verify positions were created
>>> from floor_app.operations.hr.models import Position
>>> Position.objects.count()
>>> Position.objects.select_related('department').values('name', 'department__name', 'position_level')
```

### Step 4: Verify in Admin

```bash
# Run development server
python manage.py runserver

# Navigate to admin:
# http://localhost:8000/admin/hr/department/
# http://localhost:8000/admin/hr/position/
```

Verify:
- All 13 departments are created
- All 31 positions are created
- Each position is linked to correct department
- Position levels and salary grades are correct

---

## Summary Statistics

**Departments:** 13 total
- Top-level: 10 departments
- Sub-departments: 3 (under Operations)

**Positions:** 31 total
- Executive Level: 1
- Manager Level: 11
- Supervisor/Coordinator Level: 8
- Engineer/Specialist Level: 5
- Junior/Staff Level: 6

**Department Breakdown:**
- General Management: 1 position
- Technology (Engineering): 5 positions
- Sales & Field Operations: 3 positions
- Supply Chain & Logistics: 3 positions
- Operations / Manufacturing: 2 positions
- FC Repair & Refurbishment: 4 positions
- Quality Assurance/QC: 3 positions
- HSSE: 2 positions
- Human Resources & Administration: 2 positions
- Finance & Accounting: 2 positions
- IT & ERP Systems: 3 positions

---

## Important Notes

1. **Current vs. QAS-105 Titles:**
   - "FC Refurbish Supervisor" is the current/real title
   - "Repair Coordinator" is from QAS-105 documentation
   - Both positions are created to maintain flexibility
   - They are functionally equivalent

2. **Parent Department Field:**
   - Current Department model doesn't have parent field
   - Sub-departments (FC_REPAIR, NEW_BIT, MAINT) are created as independent departments
   - If parent field is added later, relationships can be established via migration

3. **Cost Center Integration:**
   - Department model has cost_center FK ready for ERP integration
   - Can be linked after departments are created

4. **Employee Linking:**
   - Employees can now be assigned to positions
   - Department is automatically derived from position
   - Use admin or bulk update to assign existing employees

---

## Rollback Procedure

If issues are encountered:

```bash
# Reverse position migration
python manage.py migrate hr XXXX  # Migration before create_qas105_positions

# Reverse department migration
python manage.py migrate hr XXXX  # Migration before create_qas105_departments
```

---

## Related Documentation

- Task File: `TASK_OWNERSHIP_AND_ORG_STRUCTURE.md`
- Progress: `PROGRESS_MODEL_OWNERSHIP.md`
- QAS-105 Document: Official ARDT Job Titles, Responsibilities, Authorities & Accountabilities

---

**Status:** Ready for execution
**Last Updated:** 2025-11-21
**Requires:** Python virtual environment for migration execution
