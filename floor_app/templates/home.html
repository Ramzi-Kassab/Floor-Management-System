{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - Floor Management System{% endblock %}

{% block extra_css %}
<style>
    .welcome-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .welcome-banner::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: float 6s ease-in-out infinite;
    }
    
    .weather-widget {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px;
        padding: 1.5rem;
    }
    
    .calendar-widget {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }
    
    /* Fixed chart containers */
    .chart-container-wrapper {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    .chart-container-pie {
        position: relative;
        height: 250px;
        width: 100%;
        max-width: 250px;
        margin: 0 auto;
    }
    
    /* Prevent sparkline overflow */
    .metric-sparkline {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 40px;
        opacity: 0.1;
        overflow: hidden;
        pointer-events: none;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(10deg); }
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid pt-3 pb-2 border-bottom bg-light bg-opacity-50">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item active">
                <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Banner with Gradient -->
    <div class="welcome-banner fade-in">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="mb-2 fw-bold">Welcome back, {{ user.get_full_name|default:user.username }}! ðŸ‘‹</h1>
                <p class="mb-0 fs-5 opacity-90">Here's what's happening in your floor management system today.</p>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                <div class="d-inline-flex flex-column align-items-lg-end">
                    <div class="fs-3 fw-bold">{% now "l" %}</div>
                    <div class="fs-5">{% now "F j, Y" %}</div>
                    <div class="fs-6 opacity-75" id="live-clock">{% now "g:i A" %}</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Performance Metrics -->
    <div class="row g-4 mb-4">
        <!-- Total Employees Card -->
        <div class="col-12 col-sm-6 col-xl-3 fade-in">
            <div class="metric-card hover-lift">
                <div class="metric-icon bg-primary-soft text-primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Total Employees</div>
                    <div class="metric-value" data-count="{{ total_employees|default:0 }}">0</div>
                    {% if new_employees_this_month > 0 %}
                    <div class="metric-change positive">
                        <i class="bi bi-arrow-up-short"></i>
                        <span>{{ new_employees_this_month }} this month</span>
                    </div>
                    {% else %}
                    <div class="metric-change">
                        <i class="bi bi-dash"></i>
                        <span>No change</span>
                    </div>
                    {% endif %}
                </div>
                <div class="metric-sparkline">
                    <canvas id="sparkline1" height="40"></canvas>
                </div>
            </div>
        </div>

        <!-- Active Employees Card -->
        <div class="col-12 col-sm-6 col-xl-3 fade-in">
            <div class="metric-card hover-lift">
                <div class="metric-icon bg-success-soft text-success">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Active Status</div>
                    <div class="metric-value" data-count="{{ active_employees|default:0 }}">0</div>
                    <div class="metric-change">
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar" style="width: {% if total_employees > 0 %}{% widthratio active_employees total_employees 100 %}{% else %}0{% endif %}%"></div>
                        </div>
                        <small>{{ active_employees|default:0 }}/{{ total_employees|default:0 }} active</small>
                    </div>
                </div>
                <div class="metric-sparkline">
                    <canvas id="sparkline2" height="40"></canvas>
                </div>
            </div>
        </div>

        <!-- Department Stats -->
        <div class="col-12 col-sm-6 col-xl-3 fade-in">
            <div class="metric-card hover-lift">
                <div class="metric-icon bg-info-soft text-info">
                    <i class="fas fa-sitemap"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Departments</div>
                    <div class="metric-value">12</div>
                    <div class="metric-change positive">
                        <i class="bi bi-graph-up-arrow"></i>
                        <span>All operational</span>
                    </div>
                </div>
                <div class="metric-sparkline">
                    <canvas id="sparkline3" height="40"></canvas>
                </div>
            </div>
        </div>

        <!-- Performance Score -->
        <div class="col-12 col-sm-6 col-xl-3 fade-in">
            <div class="metric-card hover-lift">
                <div class="metric-icon bg-warning-soft text-warning">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-label">Performance</div>
                    <div class="metric-value">94.5%</div>
                    <div class="metric-change positive">
                        <i class="bi bi-arrow-up-short"></i>
                        <span>+5.2% vs last month</span>
                    </div>
                </div>
                <div class="metric-sparkline">
                    <canvas id="sparkline4" height="40"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Employee Growth Chart -->
        <div class="col-12 col-lg-8">
            <div class="card glassmorphism">
                <div class="card-header bg-transparent">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-area text-primary"></i>
                            Employee Growth Trend
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active">Month</button>
                            <button type="button" class="btn btn-outline-primary">Quarter</button>
                            <button type="button" class="btn btn-outline-primary">Year</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container-wrapper">
                        <canvas id="employeeGrowthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Department Distribution -->
        <div class="col-12 col-lg-4">
            <div class="card glassmorphism">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie text-info"></i>
                        Department Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container-pie">
                        <canvas id="departmentChart"></canvas>
                    </div>
                    <div class="chart-legend mt-3">
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="legend-item">
                                    <span class="legend-color" style="background: #6366f1;"></span>
                                    <span>Engineering</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="legend-item">
                                    <span class="legend-color" style="background: #10b981;"></span>
                                    <span>Sales</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="legend-item">
                                    <span class="legend-color" style="background: #f59e0b;"></span>
                                    <span>Marketing</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="legend-item">
                                    <span class="legend-color" style="background: #ef4444;"></span>
                                    <span>HR</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions and Recent Activities -->
    <div class="row g-4 mb-4">
        <!-- Quick Actions -->
        <div class="col-12 col-lg-8">
            <div class="card glassmorphism">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt text-warning"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <a href="{% url 'hr:employee_create' %}" class="quick-action-btn w-100">
                                <div class="quick-action-icon bg-primary-soft text-primary">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">Add Employee</div>
                                    <div class="quick-action-desc">Create new employee record</div>
                                </div>
                                <i class="bi bi-chevron-right quick-action-arrow"></i>
                            </a>
                        </div>

                        <div class="col-12 col-md-6">
                            <a href="{% url 'employee_list' %}" class="quick-action-btn w-100">
                                <div class="quick-action-icon bg-success-soft text-success">
                                    <i class="fas fa-users-cog"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">Manage Team</div>
                                    <div class="quick-action-desc">View and edit employees</div>
                                </div>
                                <i class="bi bi-chevron-right quick-action-arrow"></i>
                            </a>
                        </div>

                        <div class="col-12 col-md-6">
                            <a href="#" class="quick-action-btn w-100">
                                <div class="quick-action-icon bg-info-soft text-info">
                                    <i class="fas fa-file-invoice"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">Generate Report</div>
                                    <div class="quick-action-desc">Monthly analytics report</div>
                                </div>
                                <i class="bi bi-chevron-right quick-action-arrow"></i>
                            </a>
                        </div>

                        <div class="col-12 col-md-6">
                            <a href="#" class="quick-action-btn w-100">
                                <div class="quick-action-icon bg-warning-soft text-warning">
                                    <i class="fas fa-calendar-plus"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">Schedule Meeting</div>
                                    <div class="quick-action-desc">Book team meetings</div>
                                </div>
                                <i class="bi bi-chevron-right quick-action-arrow"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Activities -->
        <div class="col-12 col-lg-4">
            <div class="card glassmorphism">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-stream text-primary"></i>
                        Recent Activities
                    </h5>
                    <a href="#" class="text-primary text-decoration-none small">View all</a>
                </div>
                <div class="card-body p-0">
                    {% if recent_employees %}
                    <div class="activity-list">
                        {% for employee in recent_employees|slice:":5" %}
                        <div class="activity-item {% if forloop.last %}border-0{% endif %}">
                            <div class="activity-icon bg-success-soft text-success">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">
                                    <a href="{% url 'employee_detail' employee.pk %}">
                                        {{ employee.person.first_name_en }} {{ employee.person.last_name_en }}
                                    </a>
                                    <span class="text-muted">joined</span>
                                </div>
                                <div class="activity-time">
                                    {% if employee.team %}
                                        <span class="badge badge-primary badge-pill">{{ employee.team }}</span>
                                    {% endif %}
                                    <small class="text-muted">{{ employee.created_at|timesince }} ago</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-inbox fs-1"></i>
                        <p class="mt-2 mb-0">No recent activities</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Additional Widgets Row -->
    <div class="row g-4">
        <!-- Team Performance -->
        <div class="col-12 col-lg-6">
            <div class="card glassmorphism">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy text-warning"></i>
                        Top Performing Teams
                    </h5>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        {% if team_stats %}
                        {% for team in team_stats|slice:":4" %}
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon bg-primary-soft text-primary">
                                    <i class="fas fa-users"></i>
                                </div>
                                <span class="badge badge-success">Active</span>
                            </div>
                            <div class="stat-value">{{ team.count }}</div>
                            <div class="stat-label">{{ team.team|default:"Unassigned" }}</div>
                            <div class="stat-progress">
                                <small class="text-muted">Performance Score</small>
                                <div class="progress-bar-wrapper">
                                    <div class="progress-bar" style="width: {% widthratio team.count 50 100 %}%"></div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Calendar & Weather Widget -->
        <div class="col-12 col-lg-6">
            <div class="row g-4">
                <!-- Calendar Widget -->
                <div class="col-12">
                    <div class="calendar-widget glassmorphism">
                        <h5 class="mb-3">
                            <i class="fas fa-calendar-alt text-primary"></i>
                            Upcoming Events
                        </h5>
                        <div class="list-group list-group-flush">
                            <div class="list-group-item bg-transparent border-0 px-0">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <div class="badge bg-primary-soft text-primary rounded-3 p-2">
                                            <i class="fas fa-briefcase"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1">Team Meeting</h6>
                                        <small class="text-muted">Today, 2:00 PM - Conference Room A</small>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item bg-transparent border-0 px-0">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <div class="badge bg-success-soft text-success rounded-3 p-2">
                                            <i class="fas fa-birthday-cake"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1">John's Birthday</h6>
                                        <small class="text-muted">Tomorrow - Don't forget!</small>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item bg-transparent border-0 px-0">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <div class="badge bg-info-soft text-info rounded-3 p-2">
                                            <i class="fas fa-graduation-cap"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1">Training Session</h6>
                                        <small class="text-muted">Friday, 10:00 AM - Online</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Weather Widget -->
                <div class="col-12">
                    <div class="weather-widget">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="mb-1">
                                    <i class="fas fa-cloud-sun"></i> Weather
                                </h5>
                                <div class="fs-3 fw-bold">24Â°C</div>
                                <small class="opacity-75">Partly Cloudy</small>
                            </div>
                            <div class="text-end">
                                <i class="fas fa-sun fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Animate counters with safety checks
        function animateValue(element, start, end, duration) {
            if (!element || isNaN(end)) return;
            
            const range = end - start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            let current = start;
            
            const timer = setInterval(function() {
                current += increment;
                element.textContent = current.toLocaleString();
                if (current == end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }
        
        // Animate all metric values on page load
        setTimeout(() => {
            document.querySelectorAll('.metric-value[data-count]').forEach(function(element) {
                const endValue = parseInt(element.getAttribute('data-count')) || 0;
                if (!isNaN(endValue)) {
                    animateValue(element, 0, endValue, 1000);
                }
            });
        }, 100);
        
        // Initialize Charts with proper checks and constraints
        if (typeof Chart !== 'undefined') {
            // Set default options for all charts
            Chart.defaults.responsive = true;
            Chart.defaults.maintainAspectRatio = false;
            
            // Initialize sparkline charts with fixed heights
            const sparklineOptions = {
                type: 'line',
                data: {
                    labels: ['', '', '', '', '', '', ''],
                    datasets: [{
                        data: [12, 19, 15, 25, 22, 30, 28],
                        borderColor: 'rgba(99, 102, 241, 0.5)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    animation: false // Disable animation for sparklines
                }
            };
            
            // Create sparklines
            ['sparkline1', 'sparkline2', 'sparkline3', 'sparkline4'].forEach((id) => {
                const ctx = document.getElementById(id);
                if (ctx) {
                    const data = Array.from({length: 7}, () => Math.floor(Math.random() * 30) + 10);
                    sparklineOptions.data.datasets[0].data = data;
                    new Chart(ctx, sparklineOptions);
                }
            });
            
            // Employee Growth Chart with fixed container
            const growthCtx = document.getElementById('employeeGrowthChart');
            if (growthCtx) {
                const gradient = growthCtx.getContext('2d').createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
                gradient.addColorStop(1, 'rgba(99, 102, 241, 0.01)');
                
                const totalEmployees = {{ total_employees|default:0 }};
                const activeEmployees = {{ active_employees|default:0 }};
                
                new Chart(growthCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Total Employees',
                            data: [120, 125, 128, 135, 142, 148, 155, 162, 168, 175, 180, totalEmployees || 185],
                            borderColor: '#6366f1',
                            backgroundColor: gradient,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#ffffff',
                            pointBorderColor: '#6366f1',
                            pointBorderWidth: 2
                        }, {
                            label: 'Active Employees',
                            data: [115, 118, 120, 128, 135, 140, 145, 150, 155, 160, 165, activeEmployees || 170],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#ffffff',
                            pointBorderColor: '#10b981',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#6366f1',
                                borderWidth: 1,
                                cornerRadius: 8,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + ' employees';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false,
                                    drawBorder: false
                                },
                                ticks: {
                                    font: { size: 11 },
                                    color: '#94a3b8'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    font: { size: 11 },
                                    color: '#94a3b8',
                                    callback: function(value) {
                                        return value + ' emp';
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }
            
            // Department Distribution Pie Chart with fixed container
            const pieCtx = document.getElementById('departmentChart');
            if (pieCtx) {
                new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Engineering', 'Sales', 'Marketing', 'HR', 'Finance', 'Operations'],
                        datasets: [{
                            data: [45, 25, 15, 10, 8, 12],
                            backgroundColor: [
                                '#6366f1',
                                '#10b981',
                                '#f59e0b',
                                '#ef4444',
                                '#8b5cf6',
                                '#06b6d4'
                            ],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#6366f1',
                                borderWidth: 1,
                                cornerRadius: 8,
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + ' employees';
                                    }
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 1000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }
        }
        
        // Real-time clock update
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            const clockElement = document.getElementById('live-clock');
            if (clockElement) {
                clockElement.textContent = timeString;
            }
        }
        
        // Update clock every second
        setInterval(updateClock, 1000);
        
        // Time period toggle for charts
        document.querySelectorAll('.btn-group button').forEach(button => {
            button.addEventListener('click', function() {
                this.parentElement.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
            });
        });
    });
</script>
{% endblock %}
