{% extends "base.html" %}
{% load static %}

{% block title %}My HR Portal{% endblock %}

{% block extra_css %}
<style>
    .info-tile {
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1rem;
        background: #fff;
        height: 100%;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .info-label { font-size: 0.85rem; color: #6c757d; }
    .info-value { font-weight: 600; color: #212529; }
    .section-title { font-weight: 700; color: #212529; margin-bottom: 0.75rem; }
    .pill-badge { border-radius: 999px; padding: 0.35rem 0.6rem; font-size: 0.8rem; }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid pt-3 pb-2 border-bottom bg-light">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'hr:dashboard' %}">HR & Administration</a></li>
            <li class="breadcrumb-item active">My HR Portal</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-1" style="font-weight: 700; color: #212529;">Welcome, {{ person.get_full_name_en|default:employee.employee_no }}</h2>
                <p class="mb-0 text-muted">Your personal HR profile, entitlements, and assigned services.</p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'hr:employee_detail' employee.pk %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-person-badge me-1"></i>View HR Record
                </a>
                <a href="{% url 'hr:my_documents_dashboard' %}" class="btn btn-primary btn-sm">
                    <i class="bi bi-cloud-upload me-1"></i>My Documents
                </a>
            </div>
        </div>
    </div>

    <!-- Profile snapshot -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="info-tile">
                <div class="info-label">Employee #</div>
                <div class="info-value">{{ employee.employee_no }}</div>
                <div class="text-muted small">{{ employee.department.name|default:"No department" }}</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="info-tile">
                <div class="info-label">Position</div>
                <div class="info-value">{{ employee.position.name|default:employee.job_title|default:"Unassigned" }}</div>
                <div class="text-muted small">Status: {{ employee.get_status_display }}</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="info-tile">
                <div class="info-label">Contract</div>
                <div class="info-value">{{ employee.get_contract_type_display }}</div>
                <div class="text-muted small">Ends {{ employee.contract_end_date|default:"N/A" }}</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="info-tile">
                {% with primary_email=emails|first primary_phone=phones|first %}
                    <div class="info-label">Contact</div>
                    <div class="info-value">{{ primary_email.email_address|default:"No email" }}</div>
                    <div class="text-muted small">{{ primary_phone.phone_number|default:"No phone" }}</div>
                {% endwith %}
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Personal details -->
        <div class="col-xl-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="section-title">Personal Details</h5>
                    <div class="mb-2"><span class="info-label">Nationality:</span> <span class="info-value">{{ person.primary_nationality_iso2|default:"-" }}</span></div>
                    <div class="mb-2"><span class="info-label">ID / Passport:</span> <span class="info-value">{{ person.national_id|default:person.iqama_number|default:"-" }}</span></div>
                    <div class="mb-2"><span class="info-label">Date of Birth:</span> <span class="info-value">{{ person.date_of_birth|default:"-" }}</span></div>
                    <div class="mb-2"><span class="info-label">Addresses:</span>
                        {% if addresses %}
                            <ul class="mb-0 ps-3">
                                {% for address in addresses %}
                                    <li class="small">{{ address.address_line1 }}{% if address.city %}, {{ address.city }}{% endif %}</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <span class="text-muted">No addresses on file.</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Leave and time -->
        <div class="col-xl-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="section-title mb-0">Leave Balances</h5>
                        <a href="{% url 'hr:my_leave_dashboard' %}" class="btn btn-sm btn-outline-primary">Leave dashboard</a>
                    </div>
                    {% if leave_balances %}
                        <div class="list-group list-group-flush">
                            {% for balance in leave_balances %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">{{ balance.leave_policy.name }}</div>
                                        <small class="text-muted">Year {{ balance.year }}</small>
                                    </div>
                                    <span class="badge bg-light text-dark pill-badge">{{ balance.available_balance }} days</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-muted">No leave balances yet.</div>
                    {% endif %}

                    <div class="mt-3">
                        <h6 class="mb-2">My leave requests</h6>
                        {% if active_leave_requests %}
                            <ul class="list-unstyled mb-0">
                                {% for leave in active_leave_requests %}
                                    <li class="mb-2">
                                        <div class="fw-semibold">{{ leave.leave_policy.name }} ({{ leave.total_days }} days)</div>
                                        <small class="text-muted">{{ leave.start_date }} → {{ leave.end_date }} • {{ leave.get_status_display }}</small>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="text-muted small">No active leave requests.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Training and compliance -->
        <div class="col-xl-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="section-title mb-0">Training & Compliance</h5>
                        <a href="{% url 'hr:my_training_dashboard' %}" class="btn btn-sm btn-outline-primary">My training</a>
                    </div>
                    <h6 class="mt-2">Upcoming training</h6>
                    {% if upcoming_training %}
                        <ul class="list-unstyled">
                            {% for item in upcoming_training %}
                                <li class="mb-2">
                                    <div class="fw-semibold">{{ item.training_session.program.name }}</div>
                                    <small class="text-muted">Starts {{ item.training_session.start_date }} • {{ item.training_session.location|default:"TBD" }}</small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="text-muted small">No upcoming training sessions.</div>
                    {% endif %}

                    <h6 class="mt-3">Expiring documents</h6>
                    {% if expiring_documents %}
                        <ul class="list-unstyled mb-0">
                            {% for doc in expiring_documents %}
                                <li class="mb-2 d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">{{ doc.title }}</div>
                                        <small class="text-muted">Expires {{ doc.expiry_date }}</small>
                                    </div>
                                    <span class="badge bg-warning text-dark pill-badge">Renew</span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="text-muted small">All documents are valid.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-1">
        <!-- Services and assets -->
        <div class="col-xl-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="section-title">Assigned Services</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="info-tile">
                                <div class="info-label">Vehicle</div>
                                {% if active_vehicle_assignment %}
                                    <div class="info-value">{{ active_vehicle_assignment.vehicle.vehicle_number }}</div>
                                    <div class="text-muted small">{{ active_vehicle_assignment.vehicle.make }} {{ active_vehicle_assignment.vehicle.model }}</div>
                                {% else %}
                                    <div class="text-muted">No vehicle assigned.</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-tile">
                                <div class="info-label">Parking</div>
                                {% if active_parking_assignment %}
                                    <div class="info-value">{{ active_parking_assignment.spot.zone.code }}-{{ active_parking_assignment.spot.spot_number }}</div>
                                    <div class="text-muted small">Valid from {{ active_parking_assignment.start_date }}</div>
                                {% else %}
                                    <div class="text-muted">No parking assigned.</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-tile">
                                <div class="info-label">SIM</div>
                                {% if active_sim_assignment %}
                                    <div class="info-value">{{ active_sim_assignment.sim.phone_number }}</div>
                                    <div class="text-muted small">{{ active_sim_assignment.sim.carrier }}</div>
                                {% else %}
                                    <div class="text-muted">No SIM assigned.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance snapshot -->
        <div class="col-xl-6">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="section-title mb-0">Attendance Snapshot</h5>
                        <a href="{% url 'hr:attendance_dashboard' %}" class="btn btn-sm btn-outline-primary">Attendance</a>
                    </div>
                    {% if latest_attendance_summary %}
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="info-tile">
                                    <div class="info-label">Month</div>
                                    <div class="info-value">{{ latest_attendance_summary.month }}/{{ latest_attendance_summary.year }}</div>
                                    <div class="text-muted small">Days Present: {{ latest_attendance_summary.days_present }}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-tile">
                                    <div class="info-label">On Leave</div>
                                    <div class="info-value">{{ latest_attendance_summary.days_on_leave }}</div>
                                    <div class="text-muted small">Absent: {{ latest_attendance_summary.days_absent }}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-tile">
                                    <div class="info-label">Overtime Hours</div>
                                    <div class="info-value">{{ latest_attendance_summary.total_overtime_hours }}</div>
                                    <div class="text-muted small">Late mins: {{ latest_attendance_summary.total_late_minutes }}</div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-muted">No attendance summaries available.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
