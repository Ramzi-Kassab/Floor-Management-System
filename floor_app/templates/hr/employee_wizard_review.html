{% extends "base.html" %}
{% load static %}

{% block title %}Employee Wizard - Review & Save{% endblock %}

{% block extra_css %}
<style>
    .wizard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    
    .wizard-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 3rem;
        position: relative;
    }
    
    .wizard-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
    }
    
    .wizard-step::before {
        content: '';
        position: absolute;
        top: 25px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: #28a745;
        z-index: -1;
    }
    
    .wizard-step:last-child::before {
        display: none;
    }
    
    .step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: white;
        border: 3px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .step-circle.active {
        background: #0d6efd;
        border-color: #0d6efd;
        color: white;
        transform: scale(1.1);
    }
    
    .step-circle.completed {
        background: #28a745;
        border-color: #28a745;
        color: white;
    }
    
    .review-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .review-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #0d6efd;
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .review-section-header h5 {
        color: #0d6efd;
        margin: 0;
    }
    
    .review-item {
        display: flex;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .review-item:last-child {
        border-bottom: none;
    }
    
    .review-label {
        flex: 0 0 200px;
        color: #6c757d;
        font-weight: 500;
    }
    
    .review-value {
        flex: 1;
        color: #212529;
    }
    
    .edit-section-btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .success-animation {
        display: none;
        text-align: center;
        padding: 3rem;
    }
    
    .success-animation.show {
        display: block;
    }
    
    .success-checkmark {
        width: 80px;
        height: 80px;
        margin: 0 auto 2rem;
        border-radius: 50%;
        background: #28a745;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: scaleIn 0.3s ease;
    }
    
    @keyframes scaleIn {
        from { transform: scale(0); }
        to { transform: scale(1); }
    }
    
    .summary-card {
        background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .profile-header {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1.5rem;
        background: white;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .profile-photo {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #fff;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .profile-photo-placeholder {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid pt-3 pb-2 border-bottom bg-light">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'hr:dashboard' %}">HR & Admin</a></li>
            <li class="breadcrumb-item active">Employee Wizard - Review</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Wizard Header -->
    <div class="wizard-header">
        <h2 class="mb-2">
            <i class="bi bi-magic me-2"></i>
            Employee Creation Wizard
        </h2>
        <p class="mb-0 opacity-75">Step 4: Review all information and save</p>
    </div>

    <!-- Wizard Steps -->
    <div class="wizard-steps">
        <div class="wizard-step">
            <div class="step-circle completed">
                <i class="bi bi-check"></i>
            </div>
            <div class="step-label">Person Details</div>
        </div>
        <div class="wizard-step">
            <div class="step-circle completed">
                <i class="bi bi-check"></i>
            </div>
            <div class="step-label">Contact Info</div>
        </div>
        <div class="wizard-step">
            <div class="step-circle completed">
                <i class="bi bi-check"></i>
            </div>
            <div class="step-label">Employee Details</div>
        </div>
        <div class="wizard-step">
            <div class="step-circle active">4</div>
            <div class="step-label">Review & Save</div>
        </div>
    </div>

    <!-- Main Review Content -->
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Profile Summary -->
            <div class="summary-card">
                <div class="profile-header">
                    <div id="profilePhoto"></div>
                    <div class="flex-grow-1">
                        <h3 id="fullName" class="mb-1">Loading...</h3>
                        <p class="mb-2 text-muted">
                            <i class="bi bi-hash me-1"></i>
                            <span id="employeeNumber"></span>
                        </p>
                        <div class="d-flex gap-3">
                            <span class="badge bg-primary">
                                <i class="bi bi-briefcase me-1"></i>
                                <span id="positionBadge"></span>
                            </span>
                            <span class="badge bg-success">
                                <i class="bi bi-building me-1"></i>
                                <span id="departmentBadge"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Sections -->
            <div id="reviewContent">
                <!-- Person Information -->
                <div class="review-section">
                    <div class="review-section-header">
                        <h5>
                            <i class="bi bi-person-circle me-2"></i>
                            Person Information
                        </h5>
                        <button class="btn btn-sm btn-outline-primary edit-section-btn" onclick="editSection(1)">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="review-item">
                                <span class="review-label">Full Name (English):</span>
                                <span class="review-value" id="reviewNameEn"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Full Name (Arabic):</span>
                                <span class="review-value" id="reviewNameAr"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">National ID:</span>
                                <span class="review-value" id="reviewNationalId"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Iqama Number:</span>
                                <span class="review-value" id="reviewIqama"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="review-item">
                                <span class="review-label">Date of Birth:</span>
                                <span class="review-value" id="reviewDob"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Gender:</span>
                                <span class="review-value" id="reviewGender"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Nationality:</span>
                                <span class="review-value" id="reviewNationality"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Marital Status:</span>
                                <span class="review-value" id="reviewMaritalStatus"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="review-section">
                    <div class="review-section-header">
                        <h5>
                            <i class="bi bi-telephone me-2"></i>
                            Contact Information
                        </h5>
                        <button class="btn btn-sm btn-outline-primary edit-section-btn" onclick="editSection(2)">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-muted mb-3">Phone Numbers</h6>
                            <div id="reviewPhones"></div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted mb-3">Email Addresses</h6>
                            <div id="reviewEmails"></div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-muted mb-3">Addresses</h6>
                            <div id="reviewAddresses"></div>
                        </div>
                    </div>
                </div>

                <!-- Employment Details -->
                <div class="review-section">
                    <div class="review-section-header">
                        <h5>
                            <i class="bi bi-briefcase me-2"></i>
                            Employment Details
                        </h5>
                        <button class="btn btn-sm btn-outline-primary edit-section-btn" onclick="editSection(3)">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="review-item">
                                <span class="review-label">Employee Number:</span>
                                <span class="review-value" id="reviewEmployeeNo"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Department:</span>
                                <span class="review-value" id="reviewDepartment"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Position:</span>
                                <span class="review-value" id="reviewPosition"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Reports To:</span>
                                <span class="review-value" id="reviewReportsTo"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Status:</span>
                                <span class="review-value" id="reviewStatus"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="review-item">
                                <span class="review-label">Contract Type:</span>
                                <span class="review-value" id="reviewContractType"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Hire Date:</span>
                                <span class="review-value" id="reviewHireDate"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Work Schedule:</span>
                                <span class="review-value" id="reviewWorkSchedule"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Monthly Salary:</span>
                                <span class="review-value" id="reviewSalary"></span>
                            </div>
                            <div class="review-item">
                                <span class="review-label">Leave Entitlements:</span>
                                <span class="review-value" id="reviewLeave"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow-sm">
                    <div class="card-footer bg-white">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                                <i class="bi bi-arrow-left me-2"></i>Previous Step
                            </button>
                            <button type="button" class="btn btn-success btn-lg" onclick="saveEmployee()">
                                <i class="bi bi-check-circle me-2"></i>
                                Create Employee
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success Animation (Hidden initially) -->
            <div id="successAnimation" class="success-animation">
                <div class="success-checkmark">
                    <i class="bi bi-check text-white display-3"></i>
                </div>
                <h3 class="text-success">Employee Created Successfully!</h3>
                <p class="text-muted mb-4">All information has been saved to the system.</p>
                <div class="d-flex justify-content-center gap-3">
                    <a href="{% url 'hr:employee_detail' 0 %}" id="viewEmployeeBtn" class="btn btn-primary">
                        <i class="bi bi-eye me-2"></i>View Employee
                    </a>
                    <a href="{% url 'hr:employee_wizard_start' %}" class="btn btn-success">
                        <i class="bi bi-plus-circle me-2"></i>Create Another
                    </a>
                    <a href="{% url 'hr:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-house me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let personData = null;
let contactData = null;
let employeeData = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadReviewData();
});

function loadReviewData() {
    // Get person ID and data from session
    const personId = sessionStorage.getItem('wizard_person_id');
    
    if (!personId) {
        alert('No data found. Redirecting to start.');
        window.location.href = '{% url "hr:employee_wizard_start" %}';
        return;
    }
    
    // Load person details
    fetch(`{% url "hr:person_detail_api" 0 %}`.replace('0', personId))
        .then(response => response.json())
        .then(person => {
            personData = person;
            displayPersonData(person);
        });
    
    // Load contact data
    fetch(`{% url "hr:person_contacts_api" 0 %}`.replace('0', personId))
        .then(response => response.json())
        .then(contacts => {
            contactData = contacts;
            displayContactData(contacts);
        });
    
    // Load employee data from session
    const empDataStr = sessionStorage.getItem('wizard_employee_data');
    if (empDataStr) {
        employeeData = JSON.parse(empDataStr);
        displayEmployeeData(employeeData);
    }
}

function displayPersonData(person) {
    // Profile photo
    document.getElementById('profilePhoto').innerHTML = person.photo ? 
        `<img src="${person.photo}" class="profile-photo">` :
        `<div class="profile-photo-placeholder">
            <i class="bi bi-person-fill"></i>
        </div>`;
    
    // Name and basic info
    document.getElementById('fullName').textContent = person.full_name_en;
    document.getElementById('reviewNameEn').textContent = person.full_name_en;
    document.getElementById('reviewNameAr').textContent = 
        `${person.first_name_ar || ''} ${person.middle_name_ar || ''} ${person.last_name_ar || ''}`.trim() || 'Not provided';
    
    // IDs
    document.getElementById('reviewNationalId').textContent = person.national_id;
    document.getElementById('reviewIqama').textContent = person.iqama_number || 'N/A';
    
    // Personal info
    document.getElementById('reviewDob').textContent = person.date_of_birth || 'Not provided';
    document.getElementById('reviewGender').textContent = person.gender;
    document.getElementById('reviewNationality').textContent = person.nationality_display;
    document.getElementById('reviewMaritalStatus').textContent = person.marital_status || 'Not specified';
}

function displayContactData(contacts) {
    // Phones
    let phonesHtml = '';
    if (contacts.phones && contacts.phones.length > 0) {
        contacts.phones.forEach(phone => {
            phonesHtml += `
                <div class="mb-2">
                    <strong>${phone.phone_e164}</strong>
                    ${phone.is_primary_hint ? '<span class="badge bg-primary ms-1">Primary</span>' : ''}
                    <br>
                    <small class="text-muted">${phone.kind} - ${phone.use}</small>
                </div>
            `;
        });
    } else {
        phonesHtml = '<span class="text-muted">No phones added</span>';
    }
    document.getElementById('reviewPhones').innerHTML = phonesHtml;
    
    // Emails
    let emailsHtml = '';
    if (contacts.emails && contacts.emails.length > 0) {
        contacts.emails.forEach(email => {
            emailsHtml += `
                <div class="mb-2">
                    <strong>${email.email}</strong>
                    ${email.is_primary_hint ? '<span class="badge bg-primary ms-1">Primary</span>' : ''}
                    <br>
                    <small class="text-muted">${email.kind}</small>
                </div>
            `;
        });
    } else {
        emailsHtml = '<span class="text-muted">No emails added</span>';
    }
    document.getElementById('reviewEmails').innerHTML = emailsHtml;
    
    // Addresses
    let addressesHtml = '';
    if (contacts.addresses && contacts.addresses.length > 0) {
        contacts.addresses.forEach(address => {
            addressesHtml += `
                <div class="mb-2">
                    <strong>${address.building_number}, ${address.street_name}</strong>
                    ${address.is_primary ? '<span class="badge bg-primary ms-1">Primary</span>' : ''}
                    <br>
                    <small class="text-muted">${address.district}, ${address.city}</small>
                </div>
            `;
        });
    } else {
        addressesHtml = '<span class="text-muted">No addresses added</span>';
    }
    document.getElementById('reviewAddresses').innerHTML = addressesHtml;
}

function displayEmployeeData(employee) {
    // Header badges
    document.getElementById('employeeNumber').textContent = employee.employee_no;
    document.getElementById('positionBadge').textContent = 'Position'; // Would need to fetch actual name
    document.getElementById('departmentBadge').textContent = 'Department'; // Would need to fetch actual name
    
    // Employment details
    document.getElementById('reviewEmployeeNo').textContent = employee.employee_no;
    document.getElementById('reviewDepartment').textContent = 'Loading...'; // Would fetch department name
    document.getElementById('reviewPosition').textContent = 'Loading...'; // Would fetch position name
    document.getElementById('reviewReportsTo').textContent = employee.report_to_id ? 'Loading...' : 'N/A';
    document.getElementById('reviewStatus').innerHTML = `<span class="badge bg-success">${employee.status}</span>`;
    
    document.getElementById('reviewContractType').textContent = employee.contract_type;
    document.getElementById('reviewHireDate').textContent = employee.hire_date;
    document.getElementById('reviewWorkSchedule').textContent = 
        `${employee.work_days_per_week} days/week, ${employee.hours_per_week} hours/week`;
    document.getElementById('reviewSalary').textContent = 
        employee.monthly_salary ? `SAR ${parseFloat(employee.monthly_salary).toLocaleString()}` : 'Not specified';
    document.getElementById('reviewLeave').textContent = 
        `Annual: ${employee.annual_leave_days}, Sick: ${employee.sick_leave_days}, Special: ${employee.special_leave_days}`;
}

function editSection(step) {
    // Navigate back to specific step
    switch(step) {
        case 1:
            window.location.href = '{% url "hr:employee_wizard_start" %}';
            break;
        case 2:
            window.location.href = '{% url "hr:employee_wizard_contact" %}';
            break;
        case 3:
            window.location.href = '{% url "hr:employee_wizard_employee" %}';
            break;
    }
}

function goBack() {
    window.location.href = '{% url "hr:employee_wizard_employee" %}';
}

function saveEmployee() {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    
    // Save employee
    fetch('{% url "hr:save_employee_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(employeeData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success animation
            document.getElementById('reviewContent').style.display = 'none';
            document.getElementById('successAnimation').classList.add('show');
            
            // Update view employee button link
            const viewBtn = document.getElementById('viewEmployeeBtn');
            viewBtn.href = viewBtn.href.replace('0', data.employee_id);
            
            // Clear session storage
            sessionStorage.removeItem('wizard_person_id');
            sessionStorage.removeItem('wizard_employee_data');
        } else {
            alert('Error saving employee: ' + (data.errors || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Create Employee';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving employee');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Create Employee';
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
