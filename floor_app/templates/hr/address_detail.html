{% extends "base.html" %}
{% load static %}

{% block title %}Address Details - HR Management{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="" />
<style>
    .detail-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #dee2e6;
        overflow: hidden;
    }

    .detail-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
    }

    .detail-header h3 {
        margin: 0;
        font-weight: 600;
    }

    .detail-body {
        padding: 1.5rem;
    }

    .info-section {
        margin-bottom: 1.5rem;
    }

    .info-section:last-child {
        margin-bottom: 0;
    }

    .section-title {
        color: #212529;
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #667eea;
    }

    .info-row {
        display: flex;
        margin-bottom: 0.75rem;
    }

    .info-label {
        width: 180px;
        color: #6c757d;
        font-weight: 500;
        font-size: 0.9375rem;
        flex-shrink: 0;
    }

    .info-value {
        color: #212529;
        font-size: 0.9375rem;
        word-break: break-word;
    }

    .map-container {
        background: white;
        border-radius: 12px;
        border: 1px solid #dee2e6;
        overflow: hidden;
    }

    .map-header {
        background: #343a40;
        color: white;
        padding: 1rem 1.25rem;
    }

    .map-header h5 {
        margin: 0;
        font-weight: 600;
    }

    #address-map {
        height: 450px;
        width: 100%;
    }

    .coordinates-box {
        background: #f8f9fa;
        padding: 1rem 1.25rem;
        border-top: 1px solid #dee2e6;
    }

    .coord-value {
        font-family: monospace;
        font-size: 0.9375rem;
        background: #e9ecef;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        display: inline-block;
    }

    .badge-primary-address {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: #212529;
        font-weight: 600;
    }

    .badge-gps {
        background: #198754;
        color: white;
    }

    .badge-no-gps {
        background: #6c757d;
        color: white;
    }

    .type-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8125rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .type-home {
        background: #d4edda;
        color: #155724;
    }

    .type-office {
        background: #cce5ff;
        color: #004085;
    }

    .type-billing {
        background: #f8d7da;
        color: #721c24;
    }

    .type-shipping {
        background: #d1ecf1;
        color: #0c5460;
    }

    .type-other {
        background: #e2e3e5;
        color: #383d41;
    }

    .action-buttons .btn {
        min-width: 120px;
    }

    .sticky-sidebar {
        position: sticky;
        top: 1rem;
    }

    .person-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .person-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid pt-3 pb-2 border-bottom bg-light">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'hr:dashboard' %}">HR & Administration</a></li>
            <li class="breadcrumb-item"><a href="{% url 'hr:address_list' %}">Addresses</a></li>
            <li class="breadcrumb-item active">Address Details</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 class="mb-2" style="color: #212529; font-weight: 700;">
                        <i class="bi bi-geo-alt-fill text-secondary me-2"></i>
                        Address Details
                    </h2>
                    <p class="mb-0" style="color: #495057;">
                        View complete address information and location
                    </p>
                </div>
                <div class="d-flex gap-2 action-buttons">
                    <a href="{% url 'hr:address_edit' address.pk %}" class="btn btn-primary">
                        <i class="bi bi-pencil me-2"></i>Edit Address
                    </a>
                    <a href="{% url 'hr:address_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Address Details -->
        <div class="col-lg-7">
            <div class="detail-card">
                <div class="detail-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3>
                            <i class="bi bi-building me-2"></i>
                            {{ address.address_line1|truncatechars:40 }}
                        </h3>
                        <div class="d-flex gap-2">
                            {% if address.is_primary_hint %}
                            <span class="badge badge-primary-address">
                                <i class="bi bi-star-fill me-1"></i>Primary
                            </span>
                            {% endif %}
                            {% if address.latitude and address.longitude %}
                            <span class="badge badge-gps">
                                <i class="bi bi-geo-alt-fill me-1"></i>GPS
                            </span>
                            {% else %}
                            <span class="badge badge-no-gps">
                                <i class="bi bi-geo-alt me-1"></i>No GPS
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="detail-body">
                    <!-- Person Info -->
                    <div class="info-section">
                        <h6 class="section-title">
                            <i class="bi bi-person me-2"></i>Person
                        </h6>
                        <div class="person-card">
                            <div class="d-flex align-items-center">
                                <div class="person-avatar me-3">
                                    {% if address.hr_person.photo %}
                                    <img src="{{ address.hr_person.photo.url }}" alt="Photo" class="rounded-circle" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                    {{ address.hr_person.first_name_en|first }}{{ address.hr_person.last_name_en|first }}
                                    {% endif %}
                                </div>
                                <div>
                                    <h5 class="mb-1" style="color: #212529; font-weight: 600;">
                                        {{ address.hr_person.get_full_name_en }}
                                    </h5>
                                    {% if address.hr_person.employee %}
                                    <small style="color: #6c757d;">
                                        <i class="bi bi-badge-id me-1"></i>{{ address.hr_person.employee.employee_no }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address Classification -->
                    <div class="info-section">
                        <h6 class="section-title">
                            <i class="bi bi-tag me-2"></i>Classification
                        </h6>
                        <div class="info-row">
                            <div class="info-label">Address Type:</div>
                            <div class="info-value">
                                {% if address.hr_kind == 'HOME' %}
                                <span class="type-badge type-home"><i class="bi bi-house me-1"></i>Home</span>
                                {% elif address.hr_kind == 'OFFICE' %}
                                <span class="type-badge type-office"><i class="bi bi-building me-1"></i>Office</span>
                                {% elif address.hr_kind == 'BILLING' %}
                                <span class="type-badge type-billing"><i class="bi bi-credit-card me-1"></i>Billing</span>
                                {% elif address.hr_kind == 'SHIPPING' %}
                                <span class="type-badge type-shipping"><i class="bi bi-truck me-1"></i>Shipping</span>
                                {% else %}
                                <span class="type-badge type-other"><i class="bi bi-tag me-1"></i>{{ address.hr_kind|default:"Other" }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Usage Type:</div>
                            <div class="info-value">{{ address.hr_use|default:"-" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Custom Label:</div>
                            <div class="info-value">{{ address.label|default:"-" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Address Format:</div>
                            <div class="info-value">{{ address.get_address_kind_display|default:"-" }}</div>
                        </div>
                    </div>

                    <!-- Full Address -->
                    <div class="info-section">
                        <h6 class="section-title">
                            <i class="bi bi-house me-2"></i>Full Address
                        </h6>
                        <div class="info-row">
                            <div class="info-label">Address Line 1:</div>
                            <div class="info-value">{{ address.address_line1 }}</div>
                        </div>
                        {% if address.address_line2 %}
                        <div class="info-row">
                            <div class="info-label">Address Line 2:</div>
                            <div class="info-value">{{ address.address_line2 }}</div>
                        </div>
                        {% endif %}
                        <div class="info-row">
                            <div class="info-label">City:</div>
                            <div class="info-value">{{ address.city|default:"-" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">State/Province:</div>
                            <div class="info-value">{{ address.state_region|default:"-" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Postal Code:</div>
                            <div class="info-value">{{ address.postal_code|default:"-" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Country:</div>
                            <div class="info-value">{{ address.get_country_iso2_display|default:address.country_iso2 }}</div>
                        </div>
                        {% if address.po_box %}
                        <div class="info-row">
                            <div class="info-label">P.O. Box:</div>
                            <div class="info-value">{{ address.po_box }}</div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Structured Address (Saudi National Address) -->
                    {% if address.street_name or address.building_number or address.neighborhood %}
                    <div class="info-section">
                        <h6 class="section-title">
                            <i class="bi bi-building me-2"></i>Saudi National Address (SPL)
                        </h6>
                        {% if address.street_name %}
                        <div class="info-row">
                            <div class="info-label">Street Name:</div>
                            <div class="info-value">{{ address.street_name }}</div>
                        </div>
                        {% endif %}
                        {% if address.building_number %}
                        <div class="info-row">
                            <div class="info-label">Building Number:</div>
                            <div class="info-value">{{ address.building_number }}</div>
                        </div>
                        {% endif %}
                        {% if address.unit_number %}
                        <div class="info-row">
                            <div class="info-label">Unit Number:</div>
                            <div class="info-value">{{ address.unit_number }}</div>
                        </div>
                        {% endif %}
                        {% if address.neighborhood %}
                        <div class="info-row">
                            <div class="info-label">Neighborhood:</div>
                            <div class="info-value">{{ address.neighborhood }}</div>
                        </div>
                        {% endif %}
                        {% if address.additional_number %}
                        <div class="info-row">
                            <div class="info-label">Additional Number:</div>
                            <div class="info-value">{{ address.additional_number }}</div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Accessibility Notes -->
                    {% if address.accessibility_notes %}
                    <div class="info-section">
                        <h6 class="section-title">
                            <i class="bi bi-info-circle me-2"></i>Accessibility Notes
                        </h6>
                        <div class="p-3 bg-light rounded">
                            {{ address.accessibility_notes|linebreaks }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Metadata -->
                    <div class="info-section">
                        <h6 class="section-title">
                            <i class="bi bi-clock-history me-2"></i>Record Information
                        </h6>
                        <div class="info-row">
                            <div class="info-label">Created:</div>
                            <div class="info-value">{{ address.created_at|date:"Y-m-d H:i" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Last Updated:</div>
                            <div class="info-value">{{ address.updated_at|date:"Y-m-d H:i" }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Verification:</div>
                            <div class="info-value">
                                {% if address.verification_status == 'VERIFIED' %}
                                <span class="badge bg-success">Verified</span>
                                {% elif address.verification_status == 'INVALID' %}
                                <span class="badge bg-danger">Invalid</span>
                                {% else %}
                                <span class="badge bg-warning text-dark">Unverified</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Map -->
        <div class="col-lg-5">
            <div class="sticky-sidebar">
                <div class="map-container">
                    <div class="map-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-map me-2"></i>Location Map</h5>
                            {% if address.latitude and address.longitude %}
                            <a href="https://maps.google.com/?q={{ address.latitude }},{{ address.longitude }}"
                               target="_blank"
                               class="btn btn-sm btn-light">
                                <i class="bi bi-box-arrow-up-right me-1"></i>Open in Google Maps
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    {% if address.latitude and address.longitude %}
                    <div id="address-map"></div>
                    <div class="coordinates-box">
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small fw-medium mb-1">Latitude</label>
                                <div class="coord-value">{{ address.latitude|floatformat:6 }}</div>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-medium mb-1">Longitude</label>
                                <div class="coord-value">{{ address.longitude|floatformat:6 }}</div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="p-5 text-center bg-light">
                        <i class="bi bi-geo-alt display-1" style="color: #dee2e6;"></i>
                        <h5 class="mt-3" style="color: #495057;">No GPS Coordinates</h5>
                        <p class="text-muted mb-3">
                            This address does not have GPS coordinates set.
                        </p>
                        <a href="{% url 'hr:address_edit' address.pk %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil me-2"></i>Add Coordinates
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Quick Actions -->
                <div class="mt-3">
                    <div class="detail-card">
                        <div class="detail-body">
                            <h6 class="mb-3" style="color: #212529; font-weight: 600;">Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <a href="{% url 'hr:address_edit' address.pk %}" class="btn btn-outline-primary">
                                    <i class="bi bi-pencil me-2"></i>Edit Address
                                </a>
                                {% if address.hr_person %}
                                <a href="{% url 'hr:person_detail' address.hr_person.pk %}" class="btn btn-outline-info">
                                    <i class="bi bi-person me-2"></i>View Person Profile
                                </a>
                                {% endif %}
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                    <i class="bi bi-trash me-2"></i>Delete Address
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this address?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'hr:address_delete' address.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Address</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if address.latitude and address.longitude %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize read-only map directly with Leaflet (simpler for view-only)
    const lat = {{ address.latitude }};
    const lng = {{ address.longitude }};

    const map = L.map('address-map').setView([lat, lng], 16);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    // Add marker
    const marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup('<strong>{{ address.address_line1|escapejs }}</strong><br>{{ address.city|escapejs }}, {{ address.country_iso2 }}').openPopup();

    // Fix map rendering
    setTimeout(function() {
        map.invalidateSize();
    }, 100);
});
</script>
{% endif %}
{% endblock %}
