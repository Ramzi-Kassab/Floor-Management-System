{% extends "base.html" %}
{% load static %}

{% block title %}Employee Wizard - Employee Details{% endblock %}

{% block extra_css %}
<style>
    .wizard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    
    .wizard-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 3rem;
        position: relative;
    }
    
    .wizard-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
    }
    
    .wizard-step::before {
        content: '';
        position: absolute;
        top: 25px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: #28a745;
        z-index: -1;
    }
    
    .wizard-step:last-child::before {
        display: none;
    }
    
    .wizard-step:nth-child(3)::before {
        background: #28a745;
    }
    
    .wizard-step:nth-child(4)::before {
        background: #dee2e6;
    }
    
    .step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: white;
        border: 3px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .step-circle.active {
        background: #0d6efd;
        border-color: #0d6efd;
        color: white;
        transform: scale(1.1);
    }
    
    .step-circle.completed {
        background: #28a745;
        border-color: #28a745;
        color: white;
    }
    
    .form-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        border-left: 4px solid #0d6efd;
    }
    
    .form-section h5 {
        color: #0d6efd;
        margin-bottom: 1.5rem;
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 25px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    .date-range-indicator {
        background: #fff3cd;
        border: 1px solid #ffc107;
        padding: 0.5rem;
        border-radius: 5px;
        font-size: 0.875rem;
    }
    
    .salary-input-group {
        position: relative;
    }
    
    .salary-input-group .currency-symbol {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-weight: bold;
    }
    
    .salary-input-group input {
        padding-left: 35px;
    }
    
    .department-selector {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .department-selector:hover {
        background: #e9ecef;
    }
    
    .position-card {
        border: 1px solid #dee2e6;
        padding: 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .position-card:hover {
        border-color: #0d6efd;
        background: #f8f9fa;
    }
    
    .position-card.selected {
        border-color: #0d6efd;
        background: #e3f2fd;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid pt-3 pb-2 border-bottom bg-light">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'hr:dashboard' %}">HR & Admin</a></li>
            <li class="breadcrumb-item active">Employee Wizard - Employee Details</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Wizard Header -->
    <div class="wizard-header">
        <h2 class="mb-2">
            <i class="bi bi-magic me-2"></i>
            Employee Creation Wizard
        </h2>
        <p class="mb-0 opacity-75">Step 3: Configure employee details and work arrangements</p>
    </div>

    <!-- Wizard Steps -->
    <div class="wizard-steps">
        <div class="wizard-step">
            <div class="step-circle completed">
                <i class="bi bi-check"></i>
            </div>
            <div class="step-label">Person Details</div>
        </div>
        <div class="wizard-step">
            <div class="step-circle completed">
                <i class="bi bi-check"></i>
            </div>
            <div class="step-label">Contact Info</div>
        </div>
        <div class="wizard-step">
            <div class="step-circle active">3</div>
            <div class="step-label">Employee Details</div>
        </div>
        <div class="wizard-step">
            <div class="step-circle">4</div>
            <div class="step-label">Review & Save</div>
        </div>
    </div>

    <!-- Person Summary Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div id="personPhoto"></div>
                </div>
                <div class="col">
                    <h5 class="mb-1" id="personName">Loading...</h5>
                    <small class="text-muted" id="personDetails"></small>
                </div>
                <div class="col-auto">
                    <div class="d-flex gap-2">
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>
                            Person Complete
                        </span>
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>
                            Contacts Complete
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Details Form -->
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <form id="employeeForm" class="needs-validation" novalidate>
                
                <!-- Basic Employee Information -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge text-primary me-2"></i>
                            Basic Employee Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-section">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Employee Number *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-hash"></i>
                                        </span>
                                        <input type="text" class="form-control" id="employeeNo" required placeholder="e.g., EMP001">
                                        <button class="btn btn-outline-secondary" type="button" onclick="generateEmployeeNo()">
                                            Auto Generate
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">Employee number is required</div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Employment Status *</label>
                                    <select class="form-select" id="status" required>
                                        <option value="ACTIVE" selected>Active</option>
                                        <option value="ON_PROBATION">On Probation</option>
                                        <option value="ON_LEAVE">On Leave</option>
                                        <option value="SUSPENDED">Suspended</option>
                                        <option value="UNDER_NOTICE">Under Notice</option>
                                        <option value="TERMINATED">Terminated</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Hire Date *</label>
                                    <input type="date" class="form-control" id="hireDate" required>
                                    <div class="invalid-feedback">Hire date is required</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Organization Assignment -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-diagram-3 text-success me-2"></i>
                            Organization Assignment
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-section">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Department *</label>
                                    <select class="form-select" id="department" required onchange="loadPositions()">
                                        <option value="">Select Department...</option>
                                        <!-- Departments will be loaded dynamically -->
                                    </select>
                                    <div class="invalid-feedback">Please select a department</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">Position/Job Title *</label>
                                    <select class="form-select" id="position" required>
                                        <option value="">Select Position...</option>
                                        <!-- Positions will be loaded based on department -->
                                    </select>
                                    <div class="invalid-feedback">Please select a position</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">Reports To</label>
                                    <select class="form-select" id="reportTo">
                                        <option value="">Select Supervisor...</option>
                                        <!-- Supervisors will be loaded dynamically -->
                                    </select>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">Cost Center</label>
                                    <input type="text" class="form-control" id="costCenter" placeholder="e.g., CC001">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employment Contract -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text text-warning me-2"></i>
                            Employment Contract
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-section">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Contract Type *</label>
                                    <select class="form-select" id="contractType" required onchange="handleContractTypeChange()">
                                        <option value="PERMANENT">Permanent Employee</option>
                                        <option value="FIXED_TERM">Fixed Term Contract</option>
                                        <option value="TEMPORARY">Temporary</option>
                                        <option value="PART_TIME">Part-Time</option>
                                        <option value="INTERN">Internship</option>
                                        <option value="CONSULTANT">Consultant</option>
                                        <option value="CONTRACTOR">Contractor</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Employment Category</label>
                                    <select class="form-select" id="employmentCategory">
                                        <option value="REGULAR">Regular</option>
                                        <option value="SEASONAL">Seasonal</option>
                                        <option value="PROJECT_BASED">Project-Based</option>
                                        <option value="RELIEF_STAFF">Relief Staff</option>
                                        <option value="CASUAL">Casual</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Probation Status</label>
                                    <select class="form-select" id="probationStatus">
                                        <option value="">Not Applicable</option>
                                        <option value="PENDING">Pending</option>
                                        <option value="PASSED">Passed</option>
                                        <option value="FAILED">Failed</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Contract Dates (shown for fixed-term contracts) -->
                            <div class="row g-3 mt-2" id="contractDatesRow" style="display:none;">
                                <div class="col-md-4">
                                    <label class="form-label">Contract Start Date</label>
                                    <input type="date" class="form-control" id="contractStartDate">
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Contract End Date</label>
                                    <input type="date" class="form-control" id="contractEndDate">
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Contract Renewal Date</label>
                                    <input type="date" class="form-control" id="contractRenewalDate">
                                </div>
                                
                                <div class="col-12">
                                    <div class="date-range-indicator">
                                        <i class="bi bi-calendar-range me-2"></i>
                                        <span id="contractDuration">Contract duration will be calculated automatically</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Probation Date -->
                            <div class="row g-3 mt-2">
                                <div class="col-md-4">
                                    <label class="form-label">Probation End Date</label>
                                    <input type="date" class="form-control" id="probationEndDate">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Work Schedule -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-clock text-info me-2"></i>
                            Work Schedule
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-section">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Work Days/Week</label>
                                    <input type="number" class="form-control" id="workDaysPerWeek" value="5" min="1" max="7">
                                </div>
                                
                                <div class="col-md-3">
                                    <label class="form-label">Hours/Week</label>
                                    <input type="number" class="form-control" id="hoursPerWeek" value="40" min="1" max="60">
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">Shift Pattern</label>
                                    <select class="form-select" id="shiftPattern">
                                        <option value="DAY">Day Shift</option>
                                        <option value="NIGHT">Night Shift</option>
                                        <option value="ROTATING">Rotating Shift</option>
                                        <option value="FLEXIBLE">Flexible</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compensation & Benefits -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-cash-stack text-success me-2"></i>
                            Compensation & Benefits
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-section">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Salary Grade</label>
                                    <input type="text" class="form-control" id="salaryGrade" placeholder="e.g., Grade A">
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Monthly Salary</label>
                                    <div class="salary-input-group">
                                        <span class="currency-symbol">SAR</span>
                                        <input type="number" class="form-control" id="monthlySalary" placeholder="0.00" step="0.01">
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Eligibility</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="benefitsEligible" checked>
                                        <label class="form-check-label" for="benefitsEligible">
                                            Benefits Eligible
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="overtimeEligible" checked>
                                        <label class="form-check-label" for="overtimeEligible">
                                            Overtime Eligible
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leave Entitlements -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check text-primary me-2"></i>
                            Leave Entitlements (Days/Year)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="form-section">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Annual Leave</label>
                                    <input type="number" class="form-control" id="annualLeaveDays" value="20" min="0">
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Sick Leave</label>
                                    <input type="number" class="form-control" id="sickLeaveDays" value="10" min="0">
                                </div>
                                
                                <div class="col-md-4">
                                    <label class="form-label">Special Leave</label>
                                    <input type="number" class="form-control" id="specialLeaveDays" value="3" min="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="card shadow-sm">
                    <div class="card-footer bg-white">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="goBack()">
                                <i class="bi bi-arrow-left me-2"></i>Previous Step
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveAndNext()">
                                Review & Save
                                <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let personId = null;
let departments = [];
let positions = [];
let supervisors = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    personId = sessionStorage.getItem('wizard_person_id');
    
    if (!personId) {
        alert('No person selected. Redirecting to first step.');
        window.location.href = '{% url "hr:employee_wizard_start" %}';
        return;
    }
    
    loadPersonDetails();
    loadDepartments();
    loadSupervisors();
});

function loadPersonDetails() {
    fetch(`{% url "hr:person_detail_api" 0 %}`.replace('0', personId))
        .then(response => response.json())
        .then(person => {
            // Update person summary
            document.getElementById('personPhoto').innerHTML = person.photo ? 
                `<img src="${person.photo}" class="rounded-circle" width="60" height="60">` :
                `<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:60px;height:60px;">
                    <i class="bi bi-person-fill"></i>
                </div>`;
            
            document.getElementById('personName').textContent = person.full_name_en;
            document.getElementById('personDetails').textContent = 
                `ID: ${person.national_id} | ${person.nationality_display} | DOB: ${person.date_of_birth}`;
        });
}

function loadDepartments() {
    fetch('{% url "hr:department_list_api" %}')
        .then(response => response.json())
        .then(data => {
            departments = data.departments;
            const select = document.getElementById('department');
            
            departments.forEach(dept => {
                const option = new Option(dept.name, dept.id);
                select.add(option);
            });
        });
}

function loadPositions() {
    const departmentId = document.getElementById('department').value;
    if (!departmentId) return;
    
    fetch(`{% url "hr:position_list_api" %}?department=${departmentId}`)
        .then(response => response.json())
        .then(data => {
            positions = data.positions;
            const select = document.getElementById('position');
            
            // Clear existing options
            select.innerHTML = '<option value="">Select Position...</option>';
            
            positions.forEach(pos => {
                const option = new Option(pos.title, pos.id);
                select.add(option);
            });
        });
}

function loadSupervisors() {
    fetch('{% url "hr:employee_list_api" %}?status=ACTIVE')
        .then(response => response.json())
        .then(data => {
            supervisors = data.employees;
            const select = document.getElementById('reportTo');
            
            supervisors.forEach(emp => {
                const option = new Option(`${emp.name} - ${emp.position}`, emp.id);
                select.add(option);
            });
        });
}

function generateEmployeeNo() {
    // Generate automatic employee number
    const timestamp = Date.now().toString().slice(-6);
    const prefix = 'EMP';
    document.getElementById('employeeNo').value = `${prefix}${timestamp}`;
}

function handleContractTypeChange() {
    const contractType = document.getElementById('contractType').value;
    const contractDatesRow = document.getElementById('contractDatesRow');
    
    if (contractType === 'FIXED_TERM' || contractType === 'TEMPORARY') {
        contractDatesRow.style.display = 'flex';
    } else {
        contractDatesRow.style.display = 'none';
    }
}

// Calculate contract duration
document.getElementById('contractStartDate').addEventListener('change', calculateDuration);
document.getElementById('contractEndDate').addEventListener('change', calculateDuration);

function calculateDuration() {
    const startDate = document.getElementById('contractStartDate').value;
    const endDate = document.getElementById('contractEndDate').value;
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const diffMonths = Math.floor(diffDays / 30);
        
        document.getElementById('contractDuration').textContent = 
            `Contract duration: ${diffMonths} months (${diffDays} days)`;
    }
}

function goBack() {
    window.location.href = '{% url "hr:employee_wizard_contact" %}';
}

function saveAndNext() {
    const form = document.getElementById('employeeForm');
    
    // Validate form
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        showAlert('Please fill all required fields', 'warning');
        return;
    }
    
    // Prepare employee data
    const employeeData = {
        person_id: personId,
        employee_no: document.getElementById('employeeNo').value,
        status: document.getElementById('status').value,
        hire_date: document.getElementById('hireDate').value,
        department_id: document.getElementById('department').value,
        position_id: document.getElementById('position').value,
        report_to_id: document.getElementById('reportTo').value,
        cost_center: document.getElementById('costCenter').value,
        contract_type: document.getElementById('contractType').value,
        employment_category: document.getElementById('employmentCategory').value,
        probation_status: document.getElementById('probationStatus').value,
        contract_start_date: document.getElementById('contractStartDate').value,
        contract_end_date: document.getElementById('contractEndDate').value,
        contract_renewal_date: document.getElementById('contractRenewalDate').value,
        probation_end_date: document.getElementById('probationEndDate').value,
        work_days_per_week: document.getElementById('workDaysPerWeek').value,
        hours_per_week: document.getElementById('hoursPerWeek').value,
        shift_pattern: document.getElementById('shiftPattern').value,
        salary_grade: document.getElementById('salaryGrade').value,
        monthly_salary: document.getElementById('monthlySalary').value,
        benefits_eligible: document.getElementById('benefitsEligible').checked,
        overtime_eligible: document.getElementById('overtimeEligible').checked,
        annual_leave_days: document.getElementById('annualLeaveDays').value,
        sick_leave_days: document.getElementById('sickLeaveDays').value,
        special_leave_days: document.getElementById('specialLeaveDays').value,
    };
    
    // Save to session storage for review
    sessionStorage.setItem('wizard_employee_data', JSON.stringify(employeeData));
    
    // Redirect to review page
    window.location.href = '{% url "hr:employee_wizard_review" %}';
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    setTimeout(() => {
        document.querySelector('.alert').remove();
    }, 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
