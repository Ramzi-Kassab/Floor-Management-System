{% extends "base.html" %}
{% load static %}

{% block title %}FAQ - Knowledge Center{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid py-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'knowledge:dashboard' %}">Knowledge Center</a></li>
            <li class="breadcrumb-item active">FAQ</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="h2 mb-2">
                    <i class="bi bi-question-circle me-2"></i>
                    Frequently Asked Questions
                </h1>
                <p class="text-muted">Find answers to common questions about procedures, policies, and systems</p>
            </div>

            <!-- Search -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <form method="get" class="d-flex">
                        <input type="text"
                               name="q"
                               class="form-control form-control-lg"
                               placeholder="Search FAQ..."
                               value="{{ query }}">
                        <button type="submit" class="btn btn-primary ms-2">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Search Results -->
            {% if search_results %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-search me-2"></i>
                        Search Results for "{{ query }}"
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="searchResults">
                        {% for entry in search_results %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="search-heading-{{ entry.pk }}">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#search-collapse-{{ entry.pk }}"
                                        aria-expanded="false"
                                        aria-controls="search-collapse-{{ entry.pk }}">
                                    {{ entry.question }}
                                </button>
                            </h2>
                            <div id="search-collapse-{{ entry.pk }}"
                                 class="accordion-collapse collapse"
                                 aria-labelledby="search-heading-{{ entry.pk }}"
                                 data-bs-parent="#searchResults">
                                <div class="accordion-body">
                                    {{ entry.answer|safe }}

                                    {% if entry.related_article %}
                                    <div class="mt-3">
                                        <a href="{% url 'knowledge:article_detail' entry.related_article.slug %}"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-journal-text me-1"></i>
                                            Read More: {{ entry.related_article.title|truncatechars:40 }}
                                        </a>
                                    </div>
                                    {% endif %}

                                    <!-- Helpfulness -->
                                    <div class="mt-3 pt-3 border-top">
                                        <small class="text-muted">Was this helpful?</small>
                                        <button type="button" class="btn btn-sm btn-outline-success ms-2 helpful-btn"
                                                data-faq-id="{{ entry.pk }}" data-helpful="true">
                                            <i class="bi bi-hand-thumbs-up"></i> Yes
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger helpful-btn"
                                                data-faq-id="{{ entry.pk }}" data-helpful="false">
                                            <i class="bi bi-hand-thumbs-down"></i> No
                                        </button>
                                        <small class="text-muted ms-2">
                                            {{ entry.helpful_count }} found this helpful
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="bi bi-search fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">No Results Found</h5>
                            <p class="text-muted">Try different keywords or browse the FAQ categories below.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="text-center mb-4">
                <a href="{% url 'knowledge:faq_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Clear Search
                </a>
            </div>
            {% endif %}

            <!-- FAQ Groups -->
            {% if groups and not search_results %}
            {% for group in groups %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        {% if group.icon %}
                        <i class="{{ group.icon }} me-2"></i>
                        {% else %}
                        <i class="bi bi-collection me-2"></i>
                        {% endif %}
                        {{ group.name }}
                    </h5>
                    {% if group.description %}
                    <small class="text-muted">{{ group.description }}</small>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="accordion" id="faqGroup{{ group.pk }}">
                        {% for entry in group.entries.all %}
                        {% if entry.is_published and not entry.is_deleted %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading-{{ entry.pk }}">
                                <button class="accordion-button collapsed" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapse-{{ entry.pk }}"
                                        aria-expanded="false"
                                        aria-controls="collapse-{{ entry.pk }}">
                                    {% if entry.is_featured %}
                                    <i class="bi bi-star-fill text-warning me-2"></i>
                                    {% endif %}
                                    {{ entry.question }}
                                </button>
                            </h2>
                            <div id="collapse-{{ entry.pk }}"
                                 class="accordion-collapse collapse"
                                 aria-labelledby="heading-{{ entry.pk }}"
                                 data-bs-parent="#faqGroup{{ group.pk }}">
                                <div class="accordion-body">
                                    {{ entry.answer|safe }}

                                    {% if entry.related_article %}
                                    <div class="mt-3">
                                        <a href="{% url 'knowledge:article_detail' entry.related_article.slug %}"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-journal-text me-1"></i>
                                            Learn More: {{ entry.related_article.title|truncatechars:40 }}
                                        </a>
                                    </div>
                                    {% endif %}

                                    <!-- Helpfulness -->
                                    <div class="mt-3 pt-3 border-top">
                                        <small class="text-muted">Was this helpful?</small>
                                        <button type="button" class="btn btn-sm btn-outline-success ms-2 helpful-btn"
                                                data-faq-id="{{ entry.pk }}" data-helpful="true">
                                            <i class="bi bi-hand-thumbs-up"></i> Yes
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger helpful-btn"
                                                data-faq-id="{{ entry.pk }}" data-helpful="false">
                                            <i class="bi bi-hand-thumbs-down"></i> No
                                        </button>
                                        <small class="text-muted ms-2 helpful-count" data-faq-id="{{ entry.pk }}">
                                            {{ entry.helpful_count }} found this helpful
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% empty %}
                        <p class="text-muted text-center py-3">No FAQs in this group yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5">
                <i class="bi bi-question-circle display-1 text-muted mb-3"></i>
                <h4 class="text-muted">No FAQs Available</h4>
                <p class="text-muted">FAQ content is being prepared. Check back soon!</p>
            </div>
            {% endfor %}
            {% endif %}

            <!-- Help Box -->
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body text-center">
                    <i class="bi bi-chat-dots fs-1 text-primary mb-3"></i>
                    <h5>Can't find what you're looking for?</h5>
                    <p class="text-muted">
                        If you can't find an answer to your question, please contact your supervisor or the relevant department.
                    </p>
                    <a href="{% url 'knowledge:search' %}" class="btn btn-primary">
                        <i class="bi bi-search me-2"></i>Global Search
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle helpful/not helpful clicks
    document.querySelectorAll('.helpful-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const faqId = this.dataset.faqId;
            const helpful = this.dataset.helpful;

            fetch(`{% url 'knowledge:faq_mark_helpful' 0 %}`.replace('0', faqId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `helpful=${helpful}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update count display
                    const countEl = document.querySelector(`.helpful-count[data-faq-id="${faqId}"]`);
                    if (countEl) {
                        countEl.textContent = `${data.helpful_count} found this helpful`;
                    }

                    // Show feedback
                    const parent = this.closest('.accordion-body');
                    parent.querySelectorAll('.helpful-btn').forEach(b => {
                        b.disabled = true;
                        b.classList.remove('btn-outline-success', 'btn-outline-danger');
                        b.classList.add('btn-secondary');
                    });

                    // Highlight the clicked button
                    this.classList.remove('btn-secondary');
                    this.classList.add(helpful === 'true' ? 'btn-success' : 'btn-danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });
});
</script>
{% endblock %}
