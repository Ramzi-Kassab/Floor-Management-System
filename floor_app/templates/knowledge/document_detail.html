{% extends "base.html" %}
{% load static %}

{% block title %}{{ document.title }} - Documents{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid py-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'knowledge:dashboard' %}">Knowledge Center</a></li>
            <li class="breadcrumb-item"><a href="{% url 'knowledge:document_list' %}">Documents</a></li>
            <li class="breadcrumb-item active">{{ document.title|truncatechars:30 }}</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- Document Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded p-3 me-3">
                                <i class="bi bi-file-earmark-text display-4 text-primary"></i>
                            </div>
                            <div>
                                <h1 class="h3 mb-1">{{ document.title }}</h1>
                                <p class="text-muted mb-0">Version {{ document.version }}</p>
                            </div>
                        </div>
                        <a href="{% url 'knowledge:document_download' document.public_id %}"
                           class="btn btn-primary btn-lg">
                            <i class="bi bi-download me-2"></i>Download
                        </a>
                    </div>

                    {% if document.is_expired %}
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>This document has expired.</strong>
                        Expired on {{ document.expires_at|date:"M d, Y" }}.
                    </div>
                    {% endif %}

                    {% if document.description %}
                    <div class="mt-3">
                        <h6 class="fw-bold">Description</h6>
                        <p class="text-muted">{{ document.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Preview (for images and PDFs) -->
            {% if document.file_type == 'IMAGE' %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Preview</h5>
                </div>
                <div class="card-body text-center">
                    <img src="{{ document.file.url }}" alt="{{ document.title }}"
                         class="img-fluid rounded" style="max-height: 600px;">
                </div>
            </div>
            {% elif document.file_type == 'PDF' %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Preview</h5>
                </div>
                <div class="card-body p-0">
                    <embed src="{{ document.file.url }}" type="application/pdf"
                           width="100%" height="600px" />
                </div>
            </div>
            {% elif document.file_type == 'VIDEO' %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-play-circle me-2"></i>Video Preview</h5>
                </div>
                <div class="card-body">
                    {% if document.external_url %}
                    <div class="ratio ratio-16x9">
                        <iframe src="{{ document.external_url }}" allowfullscreen></iframe>
                    </div>
                    {% else %}
                    <video controls class="w-100">
                        <source src="{{ document.file.url }}" type="{{ document.mime_type }}">
                        Your browser does not support the video tag.
                    </video>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Usage -->
            {% if articles_using or instructions_using %}
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Used In</h5>
                </div>
                <div class="card-body">
                    {% if articles_using %}
                    <h6 class="fw-bold mb-2">Articles</h6>
                    <div class="list-group mb-3">
                        {% for article in articles_using %}
                        <a href="{% url 'knowledge:article_detail' article.slug %}"
                           class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between">
                                <span>{{ article.title }}</span>
                                <span class="badge bg-secondary">{{ article.code }}</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if instructions_using %}
                    <h6 class="fw-bold mb-2">Instructions</h6>
                    <div class="list-group">
                        {% for inst in instructions_using %}
                        <a href="{% url 'knowledge:instruction_detail' inst.code %}"
                           class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between">
                                <span>{{ inst.title }}</span>
                                <span class="badge bg-warning">{{ inst.code }}</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- File Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>File Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tbody>
                            <tr>
                                <th class="text-muted">Filename</th>
                                <td><code>{{ document.filename }}</code></td>
                            </tr>
                            <tr>
                                <th class="text-muted">Type</th>
                                <td>
                                    <span class="badge bg-secondary">{{ document.get_file_type_display }}</span>
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Size</th>
                                <td>{{ document.file_size_display }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Version</th>
                                <td>{{ document.version }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Downloads</th>
                                <td>{{ document.download_count }}</td>
                            </tr>
                            {% if document.mime_type %}
                            <tr>
                                <th class="text-muted">MIME Type</th>
                                <td><small>{{ document.mime_type }}</small></td>
                            </tr>
                            {% endif %}
                            {% if document.checksum %}
                            <tr>
                                <th class="text-muted">SHA-256</th>
                                <td><small class="text-break">{{ document.checksum }}</small></td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Dates -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Dates</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tbody>
                            <tr>
                                <th class="text-muted">Uploaded</th>
                                <td>{{ document.created_at|date:"M d, Y H:i" }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">By</th>
                                <td>{{ document.created_by.get_full_name|default:document.created_by.username|default:"System" }}</td>
                            </tr>
                            {% if document.updated_at %}
                            <tr>
                                <th class="text-muted">Last Updated</th>
                                <td>{{ document.updated_at|date:"M d, Y H:i" }}</td>
                            </tr>
                            {% endif %}
                            {% if document.expires_at %}
                            <tr>
                                <th class="text-muted">Expires</th>
                                <td>
                                    {{ document.expires_at|date:"M d, Y" }}
                                    {% if document.is_expired %}
                                    <span class="badge bg-danger">Expired</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Source Information -->
            {% if document.source_system or document.external_url %}
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-link me-2"></i>Source</h5>
                </div>
                <div class="card-body">
                    {% if document.source_system %}
                    <p class="mb-2">
                        <strong>Source System:</strong><br>
                        {{ document.source_system }}
                    </p>
                    {% endif %}
                    {% if document.external_url %}
                    <p class="mb-0">
                        <strong>External Link:</strong><br>
                        <a href="{{ document.external_url }}" target="_blank" class="text-break">
                            {{ document.external_url }}
                            <i class="bi bi-box-arrow-up-right ms-1"></i>
                        </a>
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
