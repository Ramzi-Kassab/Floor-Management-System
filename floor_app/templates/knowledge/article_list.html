{% extends "base.html" %}
{% load static %}

{% block title %}Knowledge Articles - Floor Management System{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid py-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'knowledge:dashboard' %}">Knowledge Center</a></li>
            <li class="breadcrumb-item active">Articles</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="bi bi-journal-text me-2"></i>
                Knowledge Articles
            </h1>
            <p class="text-muted mb-0">Browse procedures, guidelines, policies, and documentation</p>
        </div>
        {% if perms.knowledge.add_article %}
        <a href="{% url 'knowledge:article_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>New Article
        </a>
        {% endif %}
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filters</h5>
                </div>
                <div class="card-body">
                    <form method="get" id="filterForm">
                        <!-- Search -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Search</label>
                            <div class="input-group">
                                <input type="text"
                                       name="q"
                                       class="form-control"
                                       placeholder="Search articles..."
                                       value="{{ current_filters.q }}">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Article Type -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Article Type</label>
                            <select name="type" class="form-select" onchange="this.form.submit()">
                                <option value="">All Types</option>
                                {% for value, label in article_types %}
                                <option value="{{ value }}" {% if current_filters.type == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Category -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Category</label>
                            <select name="category" class="form-select" onchange="this.form.submit()">
                                <option value="">All Categories</option>
                                {% for cat in categories %}
                                <option value="{{ cat.slug }}" {% if current_filters.category == cat.slug %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Tags -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tags</label>
                            <select name="tag" class="form-select" onchange="this.form.submit()">
                                <option value="">All Tags</option>
                                {% for tag in tags %}
                                <option value="{{ tag.slug }}" {% if current_filters.tag == tag.slug %}selected{% endif %}>
                                    {{ tag.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Clear Filters -->
                        {% if current_filters.q or current_filters.type or current_filters.category or current_filters.tag %}
                        <a href="{% url 'knowledge:article_list' %}" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-x-circle me-2"></i>Clear All Filters
                        </a>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- Articles Grid -->
        <div class="col-lg-9">
            <!-- Results Info -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <small class="text-muted">
                    Showing {{ page_obj.start_index|default:0 }}-{{ page_obj.end_index|default:0 }} of {{ page_obj.paginator.count }} articles
                </small>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary active" id="gridViewBtn">
                        <i class="bi bi-grid-3x3-gap"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="listViewBtn">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
            </div>

            <!-- Active Filters Tags -->
            {% if current_filters.q or current_filters.type or current_filters.category or current_filters.tag %}
            <div class="mb-3">
                {% if current_filters.q %}
                <span class="badge bg-primary me-1">
                    Search: {{ current_filters.q }}
                    <a href="?type={{ current_filters.type }}&category={{ current_filters.category }}&tag={{ current_filters.tag }}"
                       class="text-white ms-1"><i class="bi bi-x"></i></a>
                </span>
                {% endif %}
                {% if current_filters.type %}
                <span class="badge bg-info me-1">
                    Type: {{ current_filters.type }}
                    <a href="?q={{ current_filters.q }}&category={{ current_filters.category }}&tag={{ current_filters.tag }}"
                       class="text-white ms-1"><i class="bi bi-x"></i></a>
                </span>
                {% endif %}
                {% if current_filters.category %}
                <span class="badge bg-success me-1">
                    Category: {{ current_filters.category }}
                    <a href="?q={{ current_filters.q }}&type={{ current_filters.type }}&tag={{ current_filters.tag }}"
                       class="text-white ms-1"><i class="bi bi-x"></i></a>
                </span>
                {% endif %}
                {% if current_filters.tag %}
                <span class="badge bg-warning me-1">
                    Tag: {{ current_filters.tag }}
                    <a href="?q={{ current_filters.q }}&type={{ current_filters.type }}&category={{ current_filters.category }}"
                       class="text-white ms-1"><i class="bi bi-x"></i></a>
                </span>
                {% endif %}
            </div>
            {% endif %}

            <!-- Grid View -->
            <div id="gridView">
                {% if articles %}
                <div class="row g-4">
                    {% for article in articles %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 border-0 shadow-sm article-card">
                            <div class="card-body">
                                <!-- Type Badge -->
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge bg-{{ article.article_type|lower }}">
                                        {{ article.get_article_type_display }}
                                    </span>
                                    {% if article.is_pinned %}
                                    <i class="bi bi-pin-angle-fill text-danger"></i>
                                    {% elif article.is_featured %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                    {% endif %}
                                </div>

                                <!-- Title -->
                                <h5 class="card-title mb-2">
                                    <a href="{% url 'knowledge:article_detail' article.slug %}"
                                       class="text-decoration-none text-dark stretched-link">
                                        {{ article.title|truncatechars:60 }}
                                    </a>
                                </h5>

                                <!-- Code -->
                                <p class="text-muted small mb-2">
                                    <strong>{{ article.code }}</strong> | v{{ article.version }}
                                </p>

                                <!-- Summary -->
                                <p class="card-text text-muted small">
                                    {{ article.summary|truncatechars:120|default:"No summary available." }}
                                </p>

                                <!-- Category & Tags -->
                                <div class="mt-auto">
                                    {% if article.category %}
                                    <span class="badge bg-light text-dark me-1">
                                        <i class="bi bi-folder2 me-1"></i>{{ article.category.name }}
                                    </span>
                                    {% endif %}
                                    {% for tag in article.tags.all|slice:":3" %}
                                    <span class="badge bg-secondary">{{ tag.name }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="card-footer bg-light border-0">
                                <div class="d-flex justify-content-between align-items-center small text-muted">
                                    <span>
                                        <i class="bi bi-eye me-1"></i>{{ article.view_count }}
                                    </span>
                                    <span>
                                        <i class="bi bi-calendar3 me-1"></i>
                                        {{ article.published_at|date:"M d, Y"|default:"Draft" }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-journal-x display-1 text-muted mb-3"></i>
                    <h4 class="text-muted">No Articles Found</h4>
                    <p class="text-muted">
                        {% if current_filters.q or current_filters.type or current_filters.category %}
                        Try adjusting your filters or search terms.
                        {% else %}
                        No articles have been published yet.
                        {% endif %}
                    </p>
                    {% if current_filters.q or current_filters.type or current_filters.category %}
                    <a href="{% url 'knowledge:article_list' %}" class="btn btn-outline-primary">
                        Clear Filters
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- List View (hidden by default) -->
            <div id="listView" style="display: none;">
                {% if articles %}
                <div class="list-group">
                    {% for article in articles %}
                    <a href="{% url 'knowledge:article_detail' article.slug %}"
                       class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <div>
                                <h6 class="mb-1">
                                    {% if article.is_pinned %}
                                    <i class="bi bi-pin-angle-fill text-danger me-1"></i>
                                    {% elif article.is_featured %}
                                    <i class="bi bi-star-fill text-warning me-1"></i>
                                    {% endif %}
                                    {{ article.title }}
                                </h6>
                                <p class="mb-1 text-muted small">{{ article.summary|truncatechars:200 }}</p>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-{{ article.article_type|lower }}">
                                        {{ article.get_article_type_display }}
                                    </span>
                                    <span class="badge bg-secondary">{{ article.code }}</span>
                                    {% if article.category %}
                                    <span class="badge bg-light text-dark">{{ article.category.name }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted d-block">
                                    {{ article.published_at|date:"M d, Y"|default:"Draft" }}
                                </small>
                                <small class="text-muted">
                                    <i class="bi bi-eye"></i> {{ article.view_count }}
                                </small>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Article pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ current_filters.q }}&type={{ current_filters.type }}&category={{ current_filters.category }}&tag={{ current_filters.tag }}">
                            <i class="bi bi-chevron-left"></i> Previous
                        </a>
                    </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}&q={{ current_filters.q }}&type={{ current_filters.type }}&category={{ current_filters.category }}&tag={{ current_filters.tag }}">
                                {{ num }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ current_filters.q }}&type={{ current_filters.type }}&category={{ current_filters.category }}&tag={{ current_filters.tag }}">
                            Next <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Article Type Badge Colors */
.badge.bg-procedure { background-color: #3b82f6 !important; }
.badge.bg-work_instruction { background-color: #10b981 !important; }
.badge.bg-guideline { background-color: #6366f1 !important; }
.badge.bg-policy { background-color: #8b5cf6 !important; }
.badge.bg-faq { background-color: #f59e0b !important; }
.badge.bg-checklist { background-color: #06b6d4 !important; }
.badge.bg-template { background-color: #ec4899 !important; }
.badge.bg-reference { background-color: #64748b !important; }
.badge.bg-safety { background-color: #ef4444 !important; }
.badge.bg-quality { background-color: #14b8a6 !important; }
.badge.bg-technical { background-color: #f97316 !important; }
.badge.bg-training { background-color: #84cc16 !important; }

/* Article Card Hover */
.article-card {
    transition: transform 0.2s, box-shadow 0.2s;
}
.article-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    const gridView = document.getElementById('gridView');
    const listView = document.getElementById('listView');

    // View toggle
    gridViewBtn.addEventListener('click', function() {
        gridView.style.display = 'block';
        listView.style.display = 'none';
        gridViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
        localStorage.setItem('articleViewPreference', 'grid');
    });

    listViewBtn.addEventListener('click', function() {
        gridView.style.display = 'none';
        listView.style.display = 'block';
        listViewBtn.classList.add('active');
        gridViewBtn.classList.remove('active');
        localStorage.setItem('articleViewPreference', 'list');
    });

    // Restore preference
    const savedView = localStorage.getItem('articleViewPreference');
    if (savedView === 'list') {
        listViewBtn.click();
    }
});
</script>
{% endblock %}
