{% extends "base.html" %}
{% load static %}

{% block title %}{{ instruction.code }} - Instruction Details{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid py-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'knowledge:dashboard' %}">Knowledge Center</a></li>
            <li class="breadcrumb-item"><a href="{% url 'knowledge:instruction_list' %}">Instructions</a></li>
            <li class="breadcrumb-item active">{{ instruction.code }}</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Header Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex gap-2">
                            {% if instruction.status == 'ACTIVE' %}
                            <span class="badge bg-success fs-6">Active</span>
                            {% elif instruction.status == 'DRAFT' %}
                            <span class="badge bg-secondary fs-6">Draft</span>
                            {% elif instruction.status == 'APPROVED' %}
                            <span class="badge bg-primary fs-6">Approved</span>
                            {% elif instruction.status == 'INACTIVE' %}
                            <span class="badge bg-warning fs-6">Inactive</span>
                            {% else %}
                            <span class="badge bg-light text-dark fs-6">{{ instruction.get_status_display }}</span>
                            {% endif %}

                            {% if instruction.priority == 'CRITICAL' %}
                            <span class="badge bg-danger fs-6">Critical</span>
                            {% elif instruction.priority == 'MANDATORY' %}
                            <span class="badge bg-purple fs-6">Mandatory</span>
                            {% elif instruction.priority == 'HIGH' %}
                            <span class="badge bg-warning fs-6">High Priority</span>
                            {% endif %}

                            {% if instruction.is_default %}
                            <span class="badge bg-dark fs-6">Default</span>
                            {% endif %}
                            {% if instruction.is_temporary %}
                            <span class="badge bg-warning text-dark fs-6">Temporary</span>
                            {% endif %}
                        </div>

                        <div class="btn-group">
                            {% if perms.knowledge.change_instructionrule %}
                            <a href="{% url 'knowledge:instruction_edit' instruction.pk %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-pencil me-1"></i>Edit
                            </a>
                            {% endif %}
                            {% if perms.knowledge.can_activate_instruction %}
                            <form method="POST" action="{% url 'knowledge:instruction_activate' instruction.pk %}" class="d-inline">
                                {% csrf_token %}
                                {% if instruction.status == 'ACTIVE' %}
                                <button type="submit" class="btn btn-outline-warning btn-sm">
                                    <i class="bi bi-pause me-1"></i>Deactivate
                                </button>
                                {% else %}
                                <button type="submit" class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-play me-1"></i>Activate
                                </button>
                                {% endif %}
                            </form>
                            {% endif %}
                        </div>
                    </div>

                    <h1 class="h3 mb-1">
                        <i class="bi bi-lightning-fill text-warning me-2"></i>
                        {{ instruction.code }}
                    </h1>
                    <h2 class="h5 text-muted mb-3">{{ instruction.title }}</h2>

                    {% if instruction.description %}
                    <p class="mb-0">{{ instruction.description }}</p>
                    {% endif %}

                    {% if instruction.short_description %}
                    <div class="alert alert-info mt-3 mb-0">
                        <strong>Quick Summary:</strong> {{ instruction.short_description }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Conditions Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>
                        Conditions (IF)
                    </h5>
                </div>
                <div class="card-body">
                    {% if conditions %}
                    <div class="conditions-list">
                        {% regroup conditions by condition_group as grouped_conditions %}
                        {% for group in grouped_conditions %}
                        {% if not forloop.first %}
                        <div class="text-center my-2">
                            <span class="badge bg-warning text-dark px-3 py-2">OR</span>
                        </div>
                        {% endif %}
                        <div class="condition-group p-3 border rounded mb-2 bg-light">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-secondary me-2">Group {{ group.grouper }}</span>
                                <small class="text-muted">Conditions in this group are joined with AND</small>
                            </div>
                            {% for condition in group.list %}
                            <div class="condition-item d-flex align-items-center p-2 bg-white rounded mb-1">
                                <span class="badge bg-info me-2">{{ condition.order }}</span>
                                <code class="me-2">
                                    {% if condition.target_model %}
                                    {{ condition.target_model }}.
                                    {% endif %}
                                    {{ condition.field_name }}
                                </code>
                                <span class="badge bg-secondary me-2">{{ condition.get_operator_display }}</span>
                                <code class="text-success">{{ condition.compare_value }}</code>
                            </div>
                            {% if not forloop.last %}
                            <div class="text-center">
                                <small class="text-muted">AND</small>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-info-circle me-2"></i>
                        No conditions defined (will always trigger).
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Actions (THEN)
                    </h5>
                </div>
                <div class="card-body">
                    {% if actions %}
                    <div class="actions-list">
                        {% for action in actions %}
                        <div class="action-item d-flex align-items-start p-3 bg-light rounded mb-2">
                            <span class="badge bg-success me-3">{{ action.order }}</span>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <strong>{{ action.get_action_type_display }}</strong>
                                    {% if action.stop_on_failure %}
                                    <span class="badge bg-danger">Stop on Failure</span>
                                    {% endif %}
                                </div>
                                {% if action.message %}
                                <p class="mb-1 mt-1">
                                    <i class="bi bi-chat-text me-1"></i>{{ action.message }}
                                </p>
                                {% endif %}
                                {% if action.parameters %}
                                <div class="mt-2">
                                    <small class="text-muted">Parameters:</small>
                                    <pre class="bg-white p-2 rounded mt-1 mb-0"><code>{{ action.parameters|pprint }}</code></pre>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-info-circle me-2"></i>
                        No actions defined.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Execution Logs -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Recent Execution Log
                    </h5>
                    <span class="badge bg-primary">{{ instruction.trigger_count }} total triggers</span>
                </div>
                <div class="card-body p-0">
                    {% if recent_logs %}
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Context</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in recent_logs %}
                                <tr>
                                    <td>
                                        <small>{{ log.executed_at|date:"M d, H:i:s" }}</small>
                                    </td>
                                    <td>{{ log.triggered_by.username|default:"System" }}</td>
                                    <td>
                                        <small class="text-muted">
                                            {{ log.context_summary|default:"N/A" }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if log.was_successful %}
                                        <span class="badge bg-success">Success</span>
                                        {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3 text-muted">
                        No execution logs yet.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Info -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <th class="text-muted">Code</th>
                            <td><strong>{{ instruction.code }}</strong></td>
                        </tr>
                        <tr>
                            <th class="text-muted">Type</th>
                            <td>{{ instruction.get_instruction_type_display }}</td>
                        </tr>
                        <tr>
                            <th class="text-muted">Priority</th>
                            <td>{{ instruction.get_priority_display }}</td>
                        </tr>
                        <tr>
                            <th class="text-muted">Status</th>
                            <td>{{ instruction.get_status_display }}</td>
                        </tr>
                        <tr>
                            <th class="text-muted">Exec Order</th>
                            <td>{{ instruction.execution_order }}</td>
                        </tr>
                        {% if instruction.owner_department %}
                        <tr>
                            <th class="text-muted">Department</th>
                            <td>{{ instruction.owner_department.name }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Validity -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Validity</h5>
                </div>
                <div class="card-body">
                    {% if instruction.is_temporary %}
                    <div class="alert alert-warning mb-3">
                        <strong>Temporary Instruction</strong>
                    </div>
                    {% endif %}

                    <table class="table table-sm table-borderless mb-0">
                        {% if instruction.valid_from %}
                        <tr>
                            <th class="text-muted">Valid From</th>
                            <td>{{ instruction.valid_from|date:"M d, Y" }}</td>
                        </tr>
                        {% endif %}
                        {% if instruction.valid_until %}
                        <tr>
                            <th class="text-muted">Valid Until</th>
                            <td>
                                {{ instruction.valid_until|date:"M d, Y" }}
                                {% if instruction.is_expired %}
                                <span class="badge bg-danger">Expired</span>
                                {% elif instruction.days_until_expiry <= 7 %}
                                <span class="badge bg-warning">{{ instruction.days_until_expiry }}d left</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th class="text-muted">Created</th>
                            <td>{{ instruction.created_at|date:"M d, Y" }}</td>
                        </tr>
                        {% if instruction.updated_at %}
                        <tr>
                            <th class="text-muted">Last Updated</th>
                            <td>{{ instruction.updated_at|date:"M d, Y" }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Target Scopes -->
            {% if scopes %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-bullseye me-2"></i>Target Scopes</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for scope in scopes %}
                    <div class="list-group-item">
                        <strong>{{ scope.scope_type }}</strong>
                        <br>
                        <small class="text-muted">{{ scope.scope_value }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Related Article -->
            {% if instruction.source_article %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Source Article</h5>
                </div>
                <div class="card-body">
                    <a href="{% url 'knowledge:article_detail' instruction.source_article.slug %}"
                       class="text-decoration-none">
                        <strong>{{ instruction.source_article.title }}</strong><br>
                        <small class="text-muted">{{ instruction.source_article.code }}</small>
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Attachments -->
            {% if instruction.attachments.all %}
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-paperclip me-2"></i>Attachments</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for doc in instruction.attachments.all %}
                    <a href="{% url 'knowledge:document_download' doc.public_id %}"
                       class="list-group-item list-group-item-action">
                        <i class="bi bi-file-earmark me-2"></i>{{ doc.title }}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.badge.bg-purple { background-color: #7c3aed !important; }
.condition-item code {
    font-size: 0.9rem;
}
</style>
{% endblock %}
