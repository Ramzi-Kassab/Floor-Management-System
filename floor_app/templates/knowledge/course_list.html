{% extends "base.html" %}
{% load static %}

{% block title %}Training Courses - Floor Management System{% endblock %}

{% block breadcrumbs %}
<div class="container-fluid py-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'knowledge:dashboard' %}">Knowledge Center</a></li>
            <li class="breadcrumb-item"><a href="{% url 'knowledge:training_dashboard' %}">Training</a></li>
            <li class="breadcrumb-item active">Courses</li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="bi bi-book me-2"></i>
                Training Courses
            </h1>
            <p class="text-muted mb-0">Browse available training programs</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <input type="text" name="q" class="form-control" placeholder="Search courses..."
                           value="{{ request.GET.q }}">
                </div>
                <div class="col-md-2">
                    <select name="type" class="form-select" onchange="this.form.submit()">
                        <option value="">All Types</option>
                        {% for value, label in course_types %}
                        <option value="{{ value }}" {% if request.GET.type == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="difficulty" class="form-select" onchange="this.form.submit()">
                        <option value="">All Levels</option>
                        {% for value, label in difficulties %}
                        <option value="{{ value }}" {% if request.GET.difficulty == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="mandatory" class="form-select" onchange="this.form.submit()">
                        <option value="">All Courses</option>
                        <option value="yes" {% if request.GET.mandatory == 'yes' %}selected{% endif %}>Mandatory</option>
                        <option value="no" {% if request.GET.mandatory == 'no' %}selected{% endif %}>Optional</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search me-1"></i>Search
                    </button>
                </div>
                <div class="col-md-1">
                    {% if request.GET.q or request.GET.type or request.GET.difficulty or request.GET.mandatory %}
                    <a href="{% url 'knowledge:course_list' %}" class="btn btn-outline-secondary w-100">
                        Clear
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Course Grid -->
    {% if courses %}
    <div class="row g-4">
        {% for course in courses %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm course-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="badge bg-{{ course.course_type|lower }} fs-6">
                            {{ course.get_course_type_display }}
                        </span>
                        <div>
                            {% if course.is_mandatory %}
                            <span class="badge bg-danger">Mandatory</span>
                            {% endif %}
                        </div>
                    </div>

                    <h5 class="card-title">
                        <a href="{% url 'knowledge:course_detail' course.code %}"
                           class="text-decoration-none text-dark stretched-link">
                            {{ course.title }}
                        </a>
                    </h5>

                    <p class="text-muted small mb-2">{{ course.code }}</p>

                    <p class="card-text text-muted">
                        {{ course.description|truncatechars:150|default:"No description available" }}
                    </p>

                    <div class="mt-auto">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-{{ course.difficulty_level|lower }}">
                                {{ course.get_difficulty_level_display }}
                            </span>
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>{{ course.estimated_duration }} hours
                            </small>
                        </div>

                        {% if course.grants_qualification %}
                        <div class="alert alert-success py-1 px-2 mb-2">
                            <small>
                                <i class="bi bi-award me-1"></i>
                                Grants: {{ course.grants_qualification.name }}
                            </small>
                        </div>
                        {% endif %}

                        {% if course.owner_department %}
                        <small class="text-muted d-block">
                            <i class="bi bi-building me-1"></i>{{ course.owner_department.name }}
                        </small>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer bg-light border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            {{ course.lessons.count }} lessons
                        </small>
                        {% if course.validity_period_days %}
                        <small class="text-muted">
                            Valid for {{ course.validity_period_days }} days
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}&type={{ request.GET.type }}&difficulty={{ request.GET.difficulty }}&mandatory={{ request.GET.mandatory }}">Previous</a>
            </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}&q={{ request.GET.q }}&type={{ request.GET.type }}&difficulty={{ request.GET.difficulty }}&mandatory={{ request.GET.mandatory }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}&type={{ request.GET.type }}&difficulty={{ request.GET.difficulty }}&mandatory={{ request.GET.mandatory }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="text-center py-5">
        <i class="bi bi-book display-1 text-muted mb-3"></i>
        <h4 class="text-muted">No Courses Found</h4>
        <p class="text-muted">
            {% if request.GET.q or request.GET.type or request.GET.difficulty %}
            No courses match your search criteria.
            {% else %}
            No training courses are currently available.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
.course-card { transition: transform 0.2s, box-shadow 0.2s; }
.course-card:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important; }
.badge.bg-online { background-color: #3b82f6 !important; }
.badge.bg-instructor_led { background-color: #10b981 !important; }
.badge.bg-blended { background-color: #8b5cf6 !important; }
.badge.bg-self_paced { background-color: #f59e0b !important; }
.badge.bg-workshop { background-color: #ef4444 !important; }
.badge.bg-beginner { background-color: #22c55e !important; }
.badge.bg-intermediate { background-color: #eab308 !important; }
.badge.bg-advanced { background-color: #ef4444 !important; }
.badge.bg-expert { background-color: #7c3aed !important; }
</style>
{% endblock %}
