{% extends 'base.html' %}
{% load static %}

{% block title %}Grid Editor - {{ session.serial_unit.serial_number }}{% endblock %}

{% block extra_css %}
<style>
    .grid-legend {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1.5rem;
        margin-bottom: 0.5rem;
    }
    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        margin-right: 0.5rem;
        border: 1px solid #dee2e6;
    }
    .legend-code {
        font-weight: 600;
        margin-right: 0.25rem;
    }
    .grid-table {
        font-size: 0.9rem;
    }
    .grid-table th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 10;
    }
    .grid-row {
        transition: background-color 0.3s ease;
    }
    .grid-row:hover {
        background-color: #f0f0f0 !important;
    }
    .grid-row[data-code="X"] { background-color: #ffcccc; }
    .grid-row[data-code="O"] { background-color: #ccffcc; }
    .grid-row[data-code="S"] { background-color: #ffffcc; }
    .grid-row[data-code="R"] { background-color: #cce5ff; }
    .grid-row[data-code="L"] { background-color: #e2e3e5; }

    .code-select {
        font-weight: 600;
    }
    .code-select option[value="X"] { background-color: #ffcccc; }
    .code-select option[value="O"] { background-color: #ccffcc; }
    .code-select option[value="S"] { background-color: #ffffcc; }
    .code-select option[value="R"] { background-color: #cce5ff; }
    .code-select option[value="L"] { background-color: #e2e3e5; }

    .feature-checkbox {
        width: 1.2rem;
        height: 1.2rem;
    }
    .feature-label {
        font-size: 0.85rem;
        font-weight: 500;
    }
    .fin-number-input {
        width: 70px;
    }
    .pocket-input {
        width: 90px;
    }
    .notes-textarea {
        min-height: 60px;
        resize: vertical;
    }
    .drag-handle {
        cursor: grab;
        color: #6c757d;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
    }
    .summary-stat {
        text-align: center;
        padding: 0.5rem;
    }
    .summary-stat .value {
        font-size: 2rem;
        font-weight: 700;
    }
    .summary-stat .label {
        font-size: 0.85rem;
        opacity: 0.9;
    }
    .auto-save-indicator {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
    }
    .saving-indicator {
        display: none;
    }
    .saving-indicator.active {
        display: inline-block;
    }
    .btn-add-row {
        border-style: dashed;
    }
    .section-header {
        background: #e9ecef;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="py-2 px-4 bg-light">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{% url 'evaluation:dashboard' %}">Evaluation</a></li>
        <li class="breadcrumb-item"><a href="{% url 'evaluation:session_list' %}">Sessions</a></li>
        <li class="breadcrumb-item"><a href="{% url 'evaluation:session_detail' session.public_id %}">{{ session.serial_unit.serial_number }}</a></li>
        <li class="breadcrumb-item active">Grid Editor</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Auto-save indicator -->
    <div class="auto-save-indicator">
        <span class="badge bg-success saving-indicator" id="savingIndicator">
            <i class="bi bi-arrow-repeat spin me-1"></i> Saving...
        </span>
        <span class="badge bg-success" id="savedIndicator" style="display: none;">
            <i class="bi bi-check-circle me-1"></i> Saved
        </span>
    </div>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>
                Grid Editor
            </h2>
            <p class="text-muted mb-0">
                Session: <strong>{{ session.serial_unit.serial_number }}</strong> |
                MAT: <strong>{{ session.mat_revision }}</strong> |
                Status: <span class="badge bg-{% if session.status == 'DRAFT' %}warning{% elif session.status == 'APPROVED' %}success{% else %}info{% endif %}">{{ session.get_status_display }}</span>
            </p>
        </div>
        <div class="d-flex gap-2">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoSaveToggle" checked>
                <label class="form-check-label" for="autoSaveToggle">Auto-save</label>
            </div>
            <button class="btn btn-primary" id="saveGridBtn">
                <i class="bi bi-save me-1"></i> Save Grid
            </button>
            <a href="{% url 'evaluation:session_detail' session.public_id %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back
            </a>
        </div>
    </div>

    <!-- Legends -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="grid-legend">
                <h6 class="mb-3"><i class="bi bi-palette me-2"></i>Cutter Codes</h6>
                <div>
                    {% for code in cutter_codes %}
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: {{ code.color_code }};"></div>
                        <span class="legend-code">{{ code.code }}</span>
                        <span class="text-muted">{{ code.name }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="grid-legend">
                <h6 class="mb-3"><i class="bi bi-tag me-2"></i>Feature Codes</h6>
                <div>
                    {% for code in feature_codes %}
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: {{ code.color_code }};"></div>
                        <span class="legend-code">{{ code.code }}</span>
                        <span class="text-muted">{{ code.name }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Grid Table -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-table me-2"></i>Evaluation Grid</h5>
            <button class="btn btn-success btn-sm" id="addRowBtn">
                <i class="bi bi-plus-circle me-1"></i> Add Row
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered grid-table mb-0" id="gridTable">
                    <thead class="table-light">
                        <tr>
                            <th width="40"><i class="bi bi-grip-vertical"></i></th>
                            <th width="80">Blade #</th>
                            <th width="120">Section</th>
                            <th width="80">Position</th>
                            <th width="100">Primary/Secondary</th>
                            <th width="200">Cutter Item</th>
                            <th width="100">Cutter Code</th>
                            <th width="180">Features</th>
                            <th width="80">Fin #</th>
                            <th width="100">Pocket Dia</th>
                            <th width="100">Pocket Depth</th>
                            <th width="100">Cutter Exp</th>
                            <th width="100">Wear Flat</th>
                            <th width="100">Back Rake</th>
                            <th width="100">Side Rake</th>
                            <th>Notes</th>
                            <th width="60">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="gridBody">
                        {% for cell in cells %}
                        <tr class="grid-row" data-cell-id="{{ cell.id }}" data-code="{{ cell.cutter_code.code|default:'' }}">
                            <td class="drag-handle text-center">
                                <i class="bi bi-grip-vertical"></i>
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm blade-input"
                                       value="{{ cell.blade_number }}" min="1" required
                                       data-field="blade_number" tabindex="1">
                            </td>
                            <td>
                                <select class="form-select form-select-sm section-select" data-field="section" tabindex="2">
                                    {% for section in sections %}
                                    <option value="{{ section.id }}" {% if cell.section_id == section.id %}selected{% endif %}>
                                        {{ section.code }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm position-input"
                                       value="{{ cell.position_index }}" min="1" required
                                       data-field="position_index" tabindex="3">
                            </td>
                            <td>
                                <select class="form-select form-select-sm primary-select" data-field="is_primary" tabindex="4">
                                    <option value="true" {% if cell.is_primary %}selected{% endif %}>Primary</option>
                                    <option value="false" {% if not cell.is_primary %}selected{% endif %}>Secondary</option>
                                </select>
                            </td>
                            <td>
                                <select class="form-select form-select-sm cutter-item-select" data-field="cutter_item" tabindex="5">
                                    <option value="">-- Select Cutter --</option>
                                    {% for item in cutter_items %}
                                    <option value="{{ item.id }}" {% if cell.cutter_item_id == item.id %}selected{% endif %}>
                                        {{ item.part_number }} - {{ item.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select class="form-select form-select-sm code-select" data-field="cutter_code" tabindex="6">
                                    <option value="">--</option>
                                    {% for code in cutter_codes %}
                                    <option value="{{ code.id }}" data-code="{{ code.code }}"
                                            {% if cell.cutter_code_id == code.id %}selected{% endif %}>
                                        {{ code.code }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input feature-checkbox" type="checkbox"
                                               id="v_{{ cell.id }}" data-field="has_fin_build_up"
                                               {% if cell.has_fin_build_up %}checked{% endif %} tabindex="7">
                                        <label class="form-check-label feature-label" for="v_{{ cell.id }}">V</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input feature-checkbox" type="checkbox"
                                               id="p_{{ cell.id }}" data-field="has_pocket_damage"
                                               {% if cell.has_pocket_damage %}checked{% endif %} tabindex="8">
                                        <label class="form-check-label feature-label" for="p_{{ cell.id }}">P</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input feature-checkbox" type="checkbox"
                                               id="i_{{ cell.id }}" data-field="has_impact_arrestor_issue"
                                               {% if cell.has_impact_arrestor_issue %}checked{% endif %} tabindex="9">
                                        <label class="form-check-label feature-label" for="i_{{ cell.id }}">I</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input feature-checkbox" type="checkbox"
                                               id="b_{{ cell.id }}" data-field="has_body_build_up"
                                               {% if cell.has_body_build_up %}checked{% endif %} tabindex="10">
                                        <label class="form-check-label feature-label" for="b_{{ cell.id }}">B</label>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm fin-number-input"
                                       value="{{ cell.fin_number|default:'' }}" min="1"
                                       data-field="fin_number" tabindex="11"
                                       {% if not cell.has_fin_build_up %}disabled style="display:none;"{% endif %}>
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm pocket-input"
                                       value="{{ cell.pocket_diameter|default:'' }}" step="0.001"
                                       data-field="pocket_diameter" placeholder="mm" tabindex="12">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm pocket-input"
                                       value="{{ cell.pocket_depth|default:'' }}" step="0.001"
                                       data-field="pocket_depth" placeholder="mm" tabindex="13">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm pocket-input"
                                       value="{{ cell.cutter_exposure|default:'' }}" step="0.001"
                                       data-field="cutter_exposure" placeholder="mm" tabindex="14">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm pocket-input"
                                       value="{{ cell.wear_flat_length|default:'' }}" step="0.001"
                                       data-field="wear_flat_length" placeholder="mm" tabindex="15">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm pocket-input"
                                       value="{{ cell.back_rake_angle|default:'' }}" step="0.01"
                                       data-field="back_rake_angle" placeholder="deg" tabindex="16">
                            </td>
                            <td>
                                <input type="number" class="form-control form-control-sm pocket-input"
                                       value="{{ cell.side_rake_angle|default:'' }}" step="0.01"
                                       data-field="side_rake_angle" placeholder="deg" tabindex="17">
                            </td>
                            <td>
                                <textarea class="form-control form-control-sm notes-textarea"
                                          data-field="notes" rows="2" tabindex="18">{{ cell.notes }}</textarea>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-outline-danger btn-sm delete-row-btn" title="Delete Row">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="emptyRow">
                            <td colspan="17" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No cells added yet. Click "Add Row" to start.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-card mb-4">
        <h5 class="mb-3"><i class="bi bi-bar-chart-fill me-2"></i>Evaluation Summary</h5>
        <div class="row">
            <div class="col-md-2">
                <div class="summary-stat">
                    <div class="value" id="totalCount">{{ session.total_cells }}</div>
                    <div class="label">Total Cells</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="summary-stat">
                    <div class="value" id="replaceCount">{{ session.replace_count }}</div>
                    <div class="label">Replace (X)</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="summary-stat">
                    <div class="value" id="okCount">{{ session.ok_count }}</div>
                    <div class="label">OK (O)</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="summary-stat">
                    <div class="value" id="brazeCount">{{ session.braze_count }}</div>
                    <div class="label">Braze (S)</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="summary-stat">
                    <div class="value" id="rotateCount">{{ session.rotate_count }}</div>
                    <div class="label">Rotate (R)</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="summary-stat">
                    <div class="value" id="lostCount">{{ session.lost_count }}</div>
                    <div class="label">Lost (L)</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Row Template (hidden) -->
<template id="newRowTemplate">
    <tr class="grid-row" data-cell-id="new" data-code="">
        <td class="drag-handle text-center">
            <i class="bi bi-grip-vertical"></i>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm blade-input"
                   value="1" min="1" required data-field="blade_number" tabindex="1">
        </td>
        <td>
            <select class="form-select form-select-sm section-select" data-field="section" tabindex="2">
                {% for section in sections %}
                <option value="{{ section.id }}">{{ section.code }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm position-input"
                   value="1" min="1" required data-field="position_index" tabindex="3">
        </td>
        <td>
            <select class="form-select form-select-sm primary-select" data-field="is_primary" tabindex="4">
                <option value="true">Primary</option>
                <option value="false">Secondary</option>
            </select>
        </td>
        <td>
            <select class="form-select form-select-sm cutter-item-select" data-field="cutter_item" tabindex="5">
                <option value="">-- Select Cutter --</option>
                {% for item in cutter_items %}
                <option value="{{ item.id }}">{{ item.part_number }} - {{ item.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <select class="form-select form-select-sm code-select" data-field="cutter_code" tabindex="6">
                <option value="">--</option>
                {% for code in cutter_codes %}
                <option value="{{ code.id }}" data-code="{{ code.code }}">{{ code.code }}</option>
                {% endfor %}
            </select>
        </td>
        <td>
            <div class="d-flex flex-wrap gap-2">
                <div class="form-check">
                    <input class="form-check-input feature-checkbox" type="checkbox"
                           data-field="has_fin_build_up" tabindex="7">
                    <label class="form-check-label feature-label">V</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input feature-checkbox" type="checkbox"
                           data-field="has_pocket_damage" tabindex="8">
                    <label class="form-check-label feature-label">P</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input feature-checkbox" type="checkbox"
                           data-field="has_impact_arrestor_issue" tabindex="9">
                    <label class="form-check-label feature-label">I</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input feature-checkbox" type="checkbox"
                           data-field="has_body_build_up" tabindex="10">
                    <label class="form-check-label feature-label">B</label>
                </div>
            </div>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm fin-number-input"
                   min="1" data-field="fin_number" tabindex="11" disabled style="display:none;">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm pocket-input"
                   step="0.001" data-field="pocket_diameter" placeholder="mm" tabindex="12">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm pocket-input"
                   step="0.001" data-field="pocket_depth" placeholder="mm" tabindex="13">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm pocket-input"
                   step="0.001" data-field="cutter_exposure" placeholder="mm" tabindex="14">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm pocket-input"
                   step="0.001" data-field="wear_flat_length" placeholder="mm" tabindex="15">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm pocket-input"
                   step="0.01" data-field="back_rake_angle" placeholder="deg" tabindex="16">
        </td>
        <td>
            <input type="number" class="form-control form-control-sm pocket-input"
                   step="0.01" data-field="side_rake_angle" placeholder="deg" tabindex="17">
        </td>
        <td>
            <textarea class="form-control form-control-sm notes-textarea"
                      data-field="notes" rows="2" tabindex="18"></textarea>
        </td>
        <td class="text-center">
            <button class="btn btn-outline-danger btn-sm delete-row-btn" title="Delete Row">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sessionId = '{{ session.public_id }}';
    const csrfToken = '{{ csrf_token }}';
    const saveCellUrl = '{% url "evaluation:save_cell" session.public_id %}';
    const deleteCellUrl = '{% url "evaluation:delete_cell" session.public_id %}';
    const createCellUrl = '{% url "evaluation:create_cell" session.public_id %}';

    let autoSaveEnabled = true;
    let saveTimeout = null;
    let pendingChanges = {};

    // Initialize Sortable for drag-and-drop reordering
    const gridBody = document.getElementById('gridBody');
    const sortable = Sortable.create(gridBody, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'bg-light',
        onEnd: function(evt) {
            updateOrderAfterDrag();
        }
    });

    // Auto-save toggle
    document.getElementById('autoSaveToggle').addEventListener('change', function() {
        autoSaveEnabled = this.checked;
    });

    // Save Grid button
    document.getElementById('saveGridBtn').addEventListener('click', function() {
        saveAllChanges();
    });

    // Add Row button
    document.getElementById('addRowBtn').addEventListener('click', function() {
        addNewRow();
    });

    // Event delegation for grid inputs
    gridBody.addEventListener('change', function(e) {
        const row = e.target.closest('.grid-row');
        if (!row) return;

        const field = e.target.dataset.field;
        if (!field) return;

        // Handle code color change
        if (field === 'cutter_code') {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const code = selectedOption.dataset.code || '';
            row.dataset.code = code;
            updateRowColor(row);
        }

        // Handle V checkbox - show/hide fin number
        if (field === 'has_fin_build_up') {
            const finInput = row.querySelector('[data-field="fin_number"]');
            if (e.target.checked) {
                finInput.disabled = false;
                finInput.style.display = '';
                finInput.focus();
            } else {
                finInput.disabled = true;
                finInput.style.display = 'none';
                finInput.value = '';
            }
        }

        // Queue change for auto-save
        if (autoSaveEnabled) {
            queueChange(row, field, e.target);
        }
    });

    // Handle input events for text fields
    gridBody.addEventListener('input', function(e) {
        if (e.target.tagName === 'TEXTAREA' ||
            (e.target.tagName === 'INPUT' && e.target.type === 'number')) {
            const row = e.target.closest('.grid-row');
            const field = e.target.dataset.field;
            if (row && field && autoSaveEnabled) {
                queueChange(row, field, e.target);
            }
        }
    });

    // Delete row button
    gridBody.addEventListener('click', function(e) {
        if (e.target.closest('.delete-row-btn')) {
            const row = e.target.closest('.grid-row');
            if (row) {
                deleteRow(row);
            }
        }
    });

    // Keyboard navigation
    gridBody.addEventListener('keydown', function(e) {
        if (e.key === 'Tab' && !e.shiftKey) {
            const currentRow = e.target.closest('.grid-row');
            const currentTabIndex = parseInt(e.target.getAttribute('tabindex'));

            // If last field in row, move to next row
            if (currentTabIndex === 18) {
                const nextRow = currentRow.nextElementSibling;
                if (nextRow && nextRow.classList.contains('grid-row')) {
                    e.preventDefault();
                    const firstInput = nextRow.querySelector('[tabindex="1"]');
                    if (firstInput) firstInput.focus();
                }
            }
        }
    });

    function updateRowColor(row) {
        const code = row.dataset.code;
        row.style.backgroundColor = '';

        const colors = {
            'X': '#ffcccc',
            'O': '#ccffcc',
            'S': '#ffffcc',
            'R': '#cce5ff',
            'L': '#e2e3e5'
        };

        if (colors[code]) {
            row.style.backgroundColor = colors[code];
        }
    }

    function queueChange(row, field, element) {
        const cellId = row.dataset.cellId;

        if (!pendingChanges[cellId]) {
            pendingChanges[cellId] = {};
        }

        let value;
        if (element.type === 'checkbox') {
            value = element.checked;
        } else if (element.tagName === 'SELECT' && field === 'is_primary') {
            value = element.value === 'true';
        } else {
            value = element.value;
        }

        pendingChanges[cellId][field] = value;

        // Debounce save
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveAllChanges();
        }, 1000);
    }

    function saveAllChanges() {
        const cellIds = Object.keys(pendingChanges);
        if (cellIds.length === 0) return;

        showSavingIndicator();

        const promises = cellIds.map(cellId => {
            const data = pendingChanges[cellId];

            if (cellId === 'new') {
                return createNewCell(data);
            } else {
                return saveCellData(cellId, data);
            }
        });

        Promise.all(promises)
            .then(() => {
                pendingChanges = {};
                updateSummary();
                showSavedIndicator();
            })
            .catch(error => {
                console.error('Save error:', error);
                alert('Error saving changes. Please try again.');
            });
    }

    function saveCellData(cellId, data) {
        return fetch(saveCellUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                cell_id: cellId,
                ...data
            })
        }).then(response => response.json());
    }

    function createNewCell(data) {
        return fetch(createCellUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        }).then(response => response.json())
          .then(result => {
              // Update row with new cell ID
              const newRows = gridBody.querySelectorAll('[data-cell-id="new"]');
              if (newRows.length > 0 && result.cell_id) {
                  newRows[0].dataset.cellId = result.cell_id;
              }
              return result;
          });
    }

    function addNewRow() {
        const template = document.getElementById('newRowTemplate');
        const clone = template.content.cloneNode(true);
        const emptyRow = document.getElementById('emptyRow');

        if (emptyRow) {
            emptyRow.remove();
        }

        gridBody.appendChild(clone);

        // Focus first input of new row
        const newRow = gridBody.lastElementChild;
        const firstInput = newRow.querySelector('[tabindex="1"]');
        if (firstInput) firstInput.focus();

        updateSummary();
    }

    function deleteRow(row) {
        const cellId = row.dataset.cellId;

        if (confirm('Are you sure you want to delete this row?')) {
            if (cellId !== 'new') {
                fetch(deleteCellUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ cell_id: cellId })
                }).then(response => {
                    if (response.ok) {
                        row.remove();
                        updateSummary();
                    }
                });
            } else {
                row.remove();
                delete pendingChanges['new'];
            }
        }
    }

    function updateOrderAfterDrag() {
        const rows = gridBody.querySelectorAll('.grid-row');
        const orderData = [];

        rows.forEach((row, index) => {
            const cellId = row.dataset.cellId;
            if (cellId !== 'new') {
                orderData.push({
                    cell_id: cellId,
                    order: index
                });
            }
        });

        // Send order update to server
        fetch('{% url "evaluation:update_cell_order" session.public_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ order_data: orderData })
        });
    }

    function updateSummary() {
        const rows = gridBody.querySelectorAll('.grid-row');
        let total = rows.length;
        let counts = { X: 0, O: 0, S: 0, R: 0, L: 0 };

        rows.forEach(row => {
            const code = row.dataset.code;
            if (code && counts.hasOwnProperty(code)) {
                counts[code]++;
            }
        });

        document.getElementById('totalCount').textContent = total;
        document.getElementById('replaceCount').textContent = counts.X;
        document.getElementById('okCount').textContent = counts.O;
        document.getElementById('brazeCount').textContent = counts.S;
        document.getElementById('rotateCount').textContent = counts.R;
        document.getElementById('lostCount').textContent = counts.L;
    }

    function showSavingIndicator() {
        document.getElementById('savingIndicator').classList.add('active');
        document.getElementById('savedIndicator').style.display = 'none';
    }

    function showSavedIndicator() {
        document.getElementById('savingIndicator').classList.remove('active');
        document.getElementById('savedIndicator').style.display = 'inline-block';

        setTimeout(() => {
            document.getElementById('savedIndicator').style.display = 'none';
        }, 2000);
    }
});
</script>
<style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .spin {
        animation: spin 1s linear infinite;
    }
</style>
{% endblock %}
