{% extends "base.html" %}
{% load static %}

{% block title %}Extraction History{% endblock %}

{% block extra_css %}
<style>
    .timeline-item { border-left: 3px solid #dee2e6; padding-left: 1.5rem; padding-bottom: 2rem; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: -8px; top: 0; width: 13px; height: 13px; border-radius: 50%; background: white; border: 3px solid #0d6efd; }
    .timeline-item.success::before { border-color: #28a745; }
    .timeline-item.error::before { border-color: #dc3545; }
    .timeline-item.pending::before { border-color: #ffc107; }
    .extraction-card { transition: all 0.3s; border-left: 4px solid transparent; }
    .extraction-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }
    .extraction-card.success { border-left-color: #28a745; }
    .extraction-card.error { border-left-color: #dc3545; }
    .extraction-card.pending { border-left-color: #ffc107; }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-clock-history me-2"></i>Extraction History</h2>
        <a href="{% url 'data_extraction:upload' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>New Extraction
        </a>
    </div>

    <!-- Statistics Dashboard -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="fs-3 fw-bold text-primary">{{ stats.total_extractions }}</div>
                            <div class="small text-muted">Total Extractions</div>
                        </div>
                        <i class="bi bi-file-earmark-arrow-up fs-1 text-primary opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="fs-3 fw-bold text-success">{{ stats.successful_imports }}</div>
                            <div class="small text-muted">Successful</div>
                        </div>
                        <i class="bi bi-check-circle fs-1 text-success opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="fs-3 fw-bold text-danger">{{ stats.failed_extractions }}</div>
                            <div class="small text-muted">Failed</div>
                        </div>
                        <i class="bi bi-x-circle fs-1 text-danger opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="fs-3 fw-bold text-info">{{ stats.total_rows_imported }}</div>
                            <div class="small text-muted">Rows Imported</div>
                        </div>
                        <i class="bi bi-table fs-1 text-info opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0" id="searchExtractions" placeholder="Search by filename...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterStatus">
                        <option value="">All Statuses</option>
                        <option value="success">Successful</option>
                        <option value="error">Failed</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterType">
                        <option value="">All Types</option>
                        <option value="employee">Employee Data</option>
                        <option value="inventory">Inventory Items</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="filterDate">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- View Toggle -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <span class="text-muted">{{ extractions|length }} extractions found</span>
        </div>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary active" data-view="grid">
                <i class="bi bi-grid"></i>
            </button>
            <button class="btn btn-outline-secondary" data-view="timeline">
                <i class="bi bi-list-ul"></i>
            </button>
        </div>
    </div>

    <!-- Grid View -->
    <div id="gridView" class="row g-4 mb-4">
        {% for extraction in extractions %}
        <div class="col-md-6 col-lg-4 extraction-item" data-status="{{ extraction.status }}" data-type="{{ extraction.extraction_type }}" data-date="{{ extraction.created_at|date:'Y-m-d' }}">
            <div class="card border-0 shadow-sm extraction-card {{ extraction.status }} h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="mb-1"><i class="bi bi-file-earmark-spreadsheet me-2"></i>{{ extraction.file_name }}</h6>
                            <small class="text-muted">{{ extraction.created_at|date:"M d, Y h:i A" }}</small>
                        </div>
                        <span class="badge bg-{% if extraction.status == 'success' %}success{% elif extraction.status == 'error' %}danger{% elif extraction.status == 'pending' %}warning{% else %}primary{% endif %}">
                            {{ extraction.get_status_display }}
                        </span>
                    </div>

                    <div class="mb-3">
                        <div class="small text-muted mb-1">Extraction Type</div>
                        <span class="badge bg-light text-dark">{{ extraction.get_extraction_type_display }}</span>
                    </div>

                    <div class="stats-grid mb-3">
                        <div>
                            <div class="fs-5 fw-bold">{{ extraction.total_rows }}</div>
                            <div class="small text-muted">Total</div>
                        </div>
                        <div>
                            <div class="fs-5 fw-bold text-success">{{ extraction.valid_rows }}</div>
                            <div class="small text-muted">Valid</div>
                        </div>
                        <div>
                            <div class="fs-5 fw-bold text-danger">{{ extraction.error_rows }}</div>
                            <div class="small text-muted">Errors</div>
                        </div>
                        <div>
                            <div class="fs-5 fw-bold text-warning">{{ extraction.warning_rows }}</div>
                            <div class="small text-muted">Warnings</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <small class="text-muted">Performed by</small>
                        <div><strong>{{ extraction.created_by.get_full_name }}</strong></div>
                    </div>

                    <div class="d-flex gap-2">
                        <a href="{% url 'data_extraction:results' extraction.id %}" class="btn btn-sm btn-primary flex-fill">
                            <i class="bi bi-eye me-1"></i>View Results
                        </a>
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadExtraction({{ extraction.id }})">
                            <i class="bi bi-download"></i>
                        </button>
                        {% if extraction.status == 'error' %}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteExtraction({{ extraction.id }})">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted d-block mb-3"></i>
                    <h5 class="text-muted">No extractions yet</h5>
                    <p class="text-muted">Start by uploading an Excel or CSV file</p>
                    <a href="{% url 'data_extraction:upload' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>Upload File
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Timeline View -->
    <div id="timelineView" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                {% for extraction in extractions %}
                <div class="timeline-item {{ extraction.status }}" data-status="{{ extraction.status }}" data-type="{{ extraction.extraction_type }}" data-date="{{ extraction.created_at|date:'Y-m-d' }}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h6 class="mb-1">
                                <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                                {{ extraction.file_name }}
                            </h6>
                            <small class="text-muted">{{ extraction.created_at|date:"M d, Y h:i A" }} by {{ extraction.created_by.get_full_name }}</small>
                        </div>
                        <span class="badge bg-{% if extraction.status == 'success' %}success{% elif extraction.status == 'error' %}danger{% elif extraction.status == 'pending' %}warning{% else %}primary{% endif %}">
                            {{ extraction.get_status_display }}
                        </span>
                    </div>
                    <div class="d-flex gap-4 mb-2">
                        <span class="small"><strong>{{ extraction.total_rows }}</strong> total rows</span>
                        <span class="small text-success"><strong>{{ extraction.valid_rows }}</strong> valid</span>
                        <span class="small text-danger"><strong>{{ extraction.error_rows }}</strong> errors</span>
                    </div>
                    <a href="{% url 'data_extraction:results' extraction.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye me-1"></i>View Details
                    </a>
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted d-block mb-3"></i>
                    <h5 class="text-muted">No extractions yet</h5>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// View toggle
document.querySelectorAll('[data-view]').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('[data-view]').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        const view = this.dataset.view;
        document.getElementById('gridView').style.display = view === 'grid' ? 'flex' : 'none';
        document.getElementById('timelineView').style.display = view === 'timeline' ? 'block' : 'none';
    });
});

// Search functionality
document.getElementById('searchExtractions')?.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    filterItems();
});

// Filter by status
document.getElementById('filterStatus')?.addEventListener('change', filterItems);
document.getElementById('filterType')?.addEventListener('change', filterItems);
document.getElementById('filterDate')?.addEventListener('change', filterItems);

function filterItems() {
    const query = document.getElementById('searchExtractions').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const typeFilter = document.getElementById('filterType').value;
    const dateFilter = document.getElementById('filterDate').value;

    document.querySelectorAll('.extraction-item, .timeline-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        const status = item.dataset.status;
        const type = item.dataset.type;
        const date = new Date(item.dataset.date);
        const today = new Date();

        let showItem = true;

        // Text search
        if (query && !text.includes(query)) showItem = false;

        // Status filter
        if (statusFilter && status !== statusFilter) showItem = false;

        // Type filter
        if (typeFilter && type !== typeFilter) showItem = false;

        // Date filter
        if (dateFilter === 'today' && date.toDateString() !== today.toDateString()) showItem = false;
        if (dateFilter === 'week') {
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            if (date < weekAgo) showItem = false;
        }
        if (dateFilter === 'month') {
            const monthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            if (date < monthAgo) showItem = false;
        }

        item.style.display = showItem ? '' : 'none';
    });
}

function downloadExtraction(id) {
    window.location.href = `/api/data-extraction/${id}/download/`;
}

function deleteExtraction(id) {
    if (confirm('Are you sure you want to delete this extraction?')) {
        fetch(`/api/data-extraction/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
