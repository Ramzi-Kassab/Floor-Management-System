{% extends 'base.html' %}
{% load static %}

{% block title %}Initialize Leave Balances - Floor Management System{% endblock %}

{% block extra_css %}
<style>
    .init-container {
        max-width: 900px;
        margin: 2rem auto;
    }
    .init-card {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .info-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    .selection-box {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    .employee-item, .policy-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: white;
        border-radius: 6px;
        border-left: 3px solid #dee2e6;
    }
    .employee-item:hover, .policy-item:hover {
        border-left-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="init-container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-gear"></i> Initialize Leave Balances</h1>
                <p class="text-muted">Set up leave balances for employees</p>
            </div>
            <a href="{% url 'hr:leave_balance_dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Balances
            </a>
        </div>

        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}

        <!-- Info Box -->
        <div class="info-box">
            <h5 class="mb-3"><i class="bi bi-info-circle"></i> Initialization Process</h5>
            <p class="mb-0">
                This wizard helps you create initial leave balances for employees. Select the year, employees, and leave policies below.
                The system will create balance records with opening balances based on each policy's annual entitlement.
            </p>
        </div>

        <!-- Initialization Form -->
        <div class="init-card">
            <form method="post" id="initForm">
                {% csrf_token %}

                <!-- Year Selection -->
                <div class="mb-4">
                    <label class="form-label">
                        <strong><i class="bi bi-calendar"></i> Select Year</strong>
                        <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" name="year" required>
                        {% for y in years %}
                            <option value="{{ y }}" {% if forloop.first %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Year for which to initialize balances</small>
                </div>

                <!-- Employee Selection -->
                <div class="selection-box">
                    <label class="form-label mb-3">
                        <strong><i class="bi bi-people"></i> Select Employees</strong>
                        <span class="text-danger">*</span>
                    </label>

                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllEmployees()">
                            <i class="bi bi-check-square"></i> Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllEmployees()">
                            <i class="bi bi-square"></i> Deselect All
                        </button>
                    </div>

                    <div style="max-height: 300px; overflow-y: auto;">
                        {% if employees %}
                            {% for employee in employees %}
                            <div class="employee-item">
                                <div class="form-check">
                                    <input class="form-check-input employee-checkbox" type="checkbox"
                                           name="employees" value="{{ employee.id }}" id="emp{{ employee.id }}">
                                    <label class="form-check-label" for="emp{{ employee.id }}">
                                        <strong>{{ employee.get_full_name }}</strong>
                                        <span class="text-muted">({{ employee.employee_no }})</span>
                                        {% if employee.department %}
                                            <br><small class="text-muted">{{ employee.department.name }}</small>
                                        {% endif %}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> No active employees found. Please add employees first.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Policy Selection -->
                <div class="selection-box">
                    <label class="form-label mb-3">
                        <strong><i class="bi bi-file-text"></i> Select Leave Policies</strong>
                        <span class="text-danger">*</span>
                    </label>

                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllPolicies()">
                            <i class="bi bi-check-square"></i> Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllPolicies()">
                            <i class="bi bi-square"></i> Deselect All
                        </button>
                    </div>

                    <div style="max-height: 300px; overflow-y: auto;">
                        {% if policies %}
                            {% for policy in policies %}
                            <div class="policy-item">
                                <div class="form-check">
                                    <input class="form-check-input policy-checkbox" type="checkbox"
                                           name="policies" value="{{ policy.id }}" id="pol{{ policy.id }}">
                                    <label class="form-check-label" for="pol{{ policy.id }}">
                                        <strong>{{ policy.name }}</strong>
                                        <span class="badge bg-secondary">{{ policy.get_leave_type_display }}</span>
                                        <br>
                                        <small class="text-muted">
                                            {{ policy.annual_entitlement_days }} days/year |
                                            {% if policy.is_paid %}Paid{% else %}Unpaid{% endif %}
                                        </small>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> No active leave policies found. Please create policies first.
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> <strong>Note:</strong>
                    Existing balances for the selected year, employees, and policies will be skipped.
                    Only missing balance records will be created.
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'hr:leave_balance_dashboard' %}" class="btn btn-outline-secondary btn-lg">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle"></i> Initialize Balances
                    </button>
                </div>
            </form>
        </div>

        <!-- Help Box -->
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-question-circle"></i> Initialization Guide</h6>
            </div>
            <div class="card-body">
                <h6>What happens during initialization?</h6>
                <ul>
                    <li><strong>Balance Creation:</strong> Creates leave balance records for selected employees and policies</li>
                    <li><strong>Opening Balance:</strong> Sets to policy's annual entitlement days</li>
                    <li><strong>Accrual Type:</strong>
                        <ul>
                            <li><strong>Upfront:</strong> Full annual entitlement available immediately</li>
                            <li><strong>Monthly:</strong> Starts at 0, accrues monthly</li>
                        </ul>
                    </li>
                    <li><strong>Duplicate Prevention:</strong> Skips if balance already exists</li>
                </ul>

                <h6 class="mt-3">Best Practices:</h6>
                <ul class="mb-0">
                    <li>Initialize balances at the start of each calendar year</li>
                    <li>Include all relevant leave policies (Annual, Sick, etc.)</li>
                    <li>For new employees, initialize balances for current year upon hiring</li>
                    <li>Review and adjust balances manually if needed after initialization</li>
                    <li>Use filters in the balance dashboard to verify initialization</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Employee selection helpers
    function selectAllEmployees() {
        document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = true);
    }

    function deselectAllEmployees() {
        document.querySelectorAll('.employee-checkbox').forEach(cb => cb.checked = false);
    }

    // Policy selection helpers
    function selectAllPolicies() {
        document.querySelectorAll('.policy-checkbox').forEach(cb => cb.checked = true);
    }

    function deselectAllPolicies() {
        document.querySelectorAll('.policy-checkbox').forEach(cb => cb.checked = false);
    }

    // Form validation
    document.getElementById('initForm').addEventListener('submit', function(e) {
        const employeesChecked = document.querySelectorAll('.employee-checkbox:checked').length;
        const policiesChecked = document.querySelectorAll('.policy-checkbox:checked').length;

        if (employeesChecked === 0) {
            e.preventDefault();
            alert('Please select at least one employee');
            return false;
        }

        if (policiesChecked === 0) {
            e.preventDefault();
            alert('Please select at least one leave policy');
            return false;
        }

        // Confirmation
        const message = `Initialize leave balances for ${employeesChecked} employee(s) with ${policiesChecked} policy/policies?`;
        if (!confirm(message)) {
            e.preventDefault();
            return false;
        }
    });
</script>
{% endblock %}
