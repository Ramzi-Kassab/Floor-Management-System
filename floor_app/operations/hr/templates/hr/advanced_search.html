{% extends 'base.html' %}
{% load static %}

{% block title %}Advanced Employee Search - HR{% endblock %}

{% block extra_css %}
<style>
    .search-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .filter-tag {
        display: inline-block;
        padding: 0.5rem 1rem;
        background: #667eea;
        color: white;
        border-radius: 20px;
        margin: 0.25rem;
        font-size: 0.9rem;
    }
    .filter-tag .remove {
        cursor: pointer;
        margin-left: 0.5rem;
        opacity: 0.8;
    }
    .filter-tag .remove:hover {
        opacity: 1;
    }
    .result-card {
        background: white;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border-radius: 10px;
        border-left: 5px solid #667eea;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        transition: all 0.3s;
    }
    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .saved-search {
        cursor: pointer;
        padding: 0.75rem 1rem;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
    }
    .saved-search:hover {
        background: #f8f9fa;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="search-panel">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h1><i class="fas fa-search"></i> Advanced Employee Search</h1>
                <p class="mb-0">Build complex queries with multiple filters</p>
            </div>
            <div>
                <a href="{% url 'hr:employee_list' %}" class="btn btn-light">
                    <i class="fas fa-arrow-left"></i> Simple Search
                </a>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#saveSearchModal">
                    <i class="fas fa-save"></i> Save Search
                </button>
            </div>
        </div>

        <!-- Active Filters -->
        <div id="activeFilters" class="mb-0">
            <small class="opacity-75">Active Filters:</small>
            <div id="filterTags" class="mt-2">
                <span class="filter-tag">All Employees</span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Filter Sidebar -->
        <div class="col-md-3">
            <!-- Saved Searches -->
            <div class="filter-section">
                <h6 class="mb-3"><i class="fas fa-star"></i> Saved Searches</h6>
                <div class="saved-search" onclick="loadSavedSearch('active-it')">
                    <strong>Active IT Department</strong>
                    <br><small class="text-muted">47 employees</small>
                </div>
                <div class="saved-search" onclick="loadSavedSearch('new-hires')">
                    <strong>New Hires (Last 30 Days)</strong>
                    <br><small class="text-muted">12 employees</small>
                </div>
                <div class="saved-search" onclick="loadSavedSearch('expiring-docs')">
                    <strong>Expiring Documents</strong>
                    <br><small class="text-muted">23 employees</small>
                </div>
                <button class="btn btn-sm btn-outline-primary w-100 mt-2">
                    <i class="fas fa-folder-open"></i> Manage Saved Searches
                </button>
            </div>

            <!-- Quick Filters -->
            <div class="filter-section">
                <h6 class="mb-3"><i class="fas fa-bolt"></i> Quick Filters</h6>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="activeOnly" onchange="toggleFilter('status', 'active')">
                    <label class="form-check-label" for="activeOnly">Active Only</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="onLeave" onchange="toggleFilter('leave', 'true')">
                    <label class="form-check-label" for="onLeave">Currently on Leave</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="newHires" onchange="toggleFilter('new', '30days')">
                    <label class="form-check-label" for="newHires">New Hires (30 days)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="expiringDocs" onchange="toggleFilter('docs', 'expiring')">
                    <label class="form-check-label" for="expiringDocs">Expiring Documents</label>
                </div>
            </div>
        </div>

        <!-- Main Search Area -->
        <div class="col-md-9">
            <!-- Advanced Filters -->
            <div class="filter-section">
                <h5 class="mb-3"><i class="fas fa-sliders-h"></i> Advanced Filters</h5>
                <form id="searchForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="department" multiple size="5">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Position</label>
                            <select class="form-select" name="position" multiple size="5">
                                <option value="">All Positions</option>
                                {% for pos in positions %}
                                <option value="{{ pos.id }}">{{ pos.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Employment Type</label>
                            <select class="form-select" name="employment_type">
                                <option value="">All Types</option>
                                <option value="full_time">Full Time</option>
                                <option value="part_time">Part Time</option>
                                <option value="contract">Contract</option>
                                <option value="intern">Intern</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Hire Date From</label>
                            <input type="date" class="form-control" name="hire_date_from">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Hire Date To</label>
                            <input type="date" class="form-control" name="hire_date_to">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Age Range</label>
                            <select class="form-select" name="age_range">
                                <option value="">Any Age</option>
                                <option value="18-25">18-25</option>
                                <option value="26-35">26-35</option>
                                <option value="36-45">36-45</option>
                                <option value="46-55">46-55</option>
                                <option value="56+">56+</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Gender</label>
                            <select class="form-select" name="gender">
                                <option value="">Any</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Skills (comma separated)</label>
                            <input type="text" class="form-control" name="skills" placeholder="Python, Java, Leadership">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Certifications</label>
                            <input type="text" class="form-control" name="certifications" placeholder="PMP, AWS, CISSP">
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                            <button type="button" class="btn btn-info" onclick="exportResults()">
                                <i class="fas fa-download"></i> Export Results
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Results -->
            <div class="filter-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Results
                        <span class="badge bg-primary">{{ results.count|default:0 }}</span>
                    </h5>
                    <div>
                        <select class="form-select form-select-sm" style="width: auto; display: inline-block;">
                            <option>Sort by: Name</option>
                            <option>Sort by: Department</option>
                            <option>Sort by: Hire Date</option>
                            <option>Sort by: Position</option>
                        </select>
                    </div>
                </div>

                {% if results %}
                    {% for employee in results %}
                    <div class="result-card">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px; font-size: 1.5rem;">
                                    {{ employee.person.first_name.0 }}{{ employee.person.last_name.0 }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-1">
                                    {{ employee.person.first_name }} {{ employee.person.last_name }}
                                    <small class="text-muted">({{ employee.employee_number }})</small>
                                </h6>
                                <p class="mb-0 text-muted">
                                    <i class="fas fa-briefcase"></i> {{ employee.position.title|default:"No Position" }}
                                    <br>
                                    <i class="fas fa-building"></i> {{ employee.department.name|default:"No Department" }}
                                </p>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Hire Date</small>
                                <br><strong>{{ employee.hire_date|date:"M d, Y" }}</strong>
                            </div>
                            <div class="col-md-2 text-end">
                                <a href="{% url 'hr:employee_detail' employee.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">No Results Found</h5>
                        <p class="text-muted">Try adjusting your search criteria</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Save Search Modal -->
<div class="modal fade" id="saveSearchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Save Search</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Search Name</label>
                    <input type="text" class="form-control" placeholder="e.g., Active IT Developers">
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="makePublic">
                    <label class="form-check-label" for="makePublic">
                        Share with team (make public)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Save Search</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleFilter(type, value) {
    // Add filter tag
    const tag = document.createElement('span');
    tag.className = 'filter-tag';
    tag.innerHTML = `${type}: ${value} <span class="remove" onclick="this.parentElement.remove()">Ã—</span>`;
    document.getElementById('filterTags').appendChild(tag);
}

function resetFilters() {
    document.getElementById('searchForm').reset();
    document.getElementById('filterTags').innerHTML = '<span class="filter-tag">All Employees</span>';
}

function loadSavedSearch(searchId) {
    alert('Loading saved search: ' + searchId);
}

function exportResults() {
    window.location.href = '{% url "hr:export_employees" %}?format=csv';
}

document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    // Submit search via AJAX
    console.log('Searching...');
});
</script>
{% endblock %}
