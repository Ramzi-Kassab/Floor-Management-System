# HR RBAC (Role-Based Access Control) System

## Overview

This document describes the design and implementation of the Role-Based Access Control system for the HR module. The system automatically creates Django User accounts for employees, assigns them to groups based on their job positions, and manages permissions accordingly.

## Architecture

### Components

1. **Position Model** (`models/position.py`)
   - Links to Django auth.Group via `auth_group` ForeignKey
   - Can specify additional permissions via `permission_codenames` field
   - Serves as the primary RBAC mapping point

2. **HREmployee Model** (`models/employee.py`)
   - Has OneToOneField to Django User
   - Linked to Position (determines RBAC)
   - User is automatically created/managed via signals

3. **Signals Module** (`signals.py`)
   - Listens to HREmployee post_save events
   - Creates Django User automatically on Employee creation
   - Syncs User groups when Position changes
   - Deactivates User when Employee is terminated

4. **Audit Log** (`models/audit_log.py`)
   - Records all security-relevant changes
   - Tracks User creation, group changes, permission updates
   - Provides compliance and debugging trail

5. **Management Command** (`management/commands/setup_hr_rbac.py`)
   - Bootstraps Groups and Permissions
   - Links Positions to Groups
   - Creates sample departments and positions

## User Account Creation Flow

```
Employee Created (via wizard or API)
        ↓
    post_save Signal Triggered
        ↓
    EmployeeUserService.create_user_for_employee()
        ↓
    1. Generate unique username (first.last or first.last_N)
    2. Get primary email from Person's emails
    3. Check for duplicate email conflicts
    4. Create Django User with:
       - Username from person name
       - Email from primary business email
       - Random secure password
       - first_name and last_name from Person
       - is_active=True
       - is_staff=False
       - is_superuser=False
    5. Link User to Employee
    6. Log USER_CREATED audit entry
        ↓
    EmployeeUserService.sync_user_groups()
        ↓
    1. Get Group from Employee's Position
    2. Add User to appropriate Group(s)
    3. Remove from outdated Groups
    4. Log GROUP_ADDED/GROUP_REMOVED entries
```

## RBAC Groups and Permissions

### Default Groups

| Group Name | Description | Key Permissions |
|------------|-------------|-----------------|
| `hr_managers` | Full HR module access | All CRUD on People, Employees, Phones, Emails, Addresses, Departments, Positions |
| `hr_officers` | Create and edit employee data | Add/Change on People, Employees, Contacts; View on Departments, Positions |
| `production_supervisors` | View HR data for team management | View all HR models |
| `department_managers` | Department-level access | View all + Change employees |
| `employees` | View own profile only | View (restricted to self via logic) |
| `administrators` | System administration | All permissions including User/Group management |

### Permission Categories

1. **Model Permissions** (auto-generated by Django):
   - `add_hrpeople`, `change_hrpeople`, `delete_hrpeople`, `view_hrpeople`
   - `add_hremployee`, `change_hremployee`, `delete_hremployee`, `view_hremployee`
   - etc.

2. **Custom Permissions** (created by setup command):
   - `can_export_employees` - Export employee data
   - `can_import_employees` - Import employee data
   - `can_view_salaries` - View salary information
   - `can_modify_salaries` - Modify salary information
   - `can_terminate_employees` - Terminate employees
   - `can_view_audit_logs` - View HR audit logs

## Position to Group Mapping

When an Employee is assigned a Position, the system:

1. Checks `Position.auth_group` field
2. Adds User to that Group
3. Removes User from previous Position's Group
4. Applies any additional permissions from `Position.permission_codenames`

### Example Mappings

```
Position: "HR Manager"
  → auth_group: hr_managers
  → Permissions: Full HR CRUD

Position: "Production Operator"
  → auth_group: employees
  → Permissions: View own profile

Position: "System Administrator"
  → auth_group: administrators
  → Permissions: Full system access
```

## Setup Instructions

### 1. Run Migrations

```bash
python manage.py makemigrations hr
python manage.py migrate
```

### 2. Setup RBAC Groups and Permissions

```bash
# Create groups with permissions
python manage.py setup_hr_rbac

# Create sample departments and positions with group links
python manage.py setup_hr_rbac --create-sample-data

# Link existing positions to groups based on name patterns
python manage.py setup_hr_rbac --link-positions
```

### 3. Verify Setup

Check Django admin to see:
- Groups with assigned permissions
- Positions with linked Groups
- Custom permissions created

## Password Management

### Initial Password

When a User is created:
1. A random 16-character secure password is generated
2. Contains lowercase, uppercase, digits, and special characters
3. Audit log records that password reset is required

### Password Reset Strategy

Current implementation:
- Password is logged (in production, should be emailed or use reset token)
- Audit log marks `PASSWORD_RESET` required
- User should reset on first login

**Recommended Enhancement:**
- Use Django's password reset token system
- Send email with reset link
- Force password change on first login

## Audit Logging

All security-relevant actions are logged to `hr_audit_log`:

| Action | When Triggered |
|--------|---------------|
| `USER_CREATED` | New User account created |
| `USER_LINKED` | Existing User linked to Employee |
| `USER_DEACTIVATED` | User account deactivated |
| `GROUP_ADDED` | User added to Group |
| `GROUP_REMOVED` | User removed from Group |
| `PERMISSION_ADDED` | Permission added to User |
| `PERMISSION_REMOVED` | Permission removed from User |
| `POSITION_CHANGED` | Employee Position changed |
| `PASSWORD_RESET` | Password reset required |

### Audit Log Structure

```python
{
    'timestamp': datetime,
    'action': 'USER_CREATED',
    'employee': HREmployee,
    'affected_user': User,
    'performed_by': User,  # Admin who made the change
    'details': '{"username": "john.doe", "email": "john@company.com"}',
    'ip_address': '192.168.1.1',
    'user_agent': 'Mozilla/5.0...'
}
```

## View Protection

### Using Decorators

```python
from floor_app.operations.hr.decorators import (
    hr_permission_required,
    hr_manager_required,
    own_profile_only
)

@hr_permission_required('hr.add_hremployee')
def create_employee(request):
    # Only users with add_hremployee permission
    pass

@hr_manager_required
def delete_employee(request):
    # Only HR Managers and superusers
    pass

@own_profile_only
def view_profile(request, pk):
    # Users can only view their own profile (unless HR/admin)
    pass
```

## Extending the System

### Adding New Roles/Groups

1. **Add group to management command** (`setup_hr_rbac.py`):

```python
groups_config = {
    'new_role': {
        'description': 'New Role Description',
        'permissions': [
            'view_hrpeople',
            'view_hremployee',
            # Add required permissions
        ],
        'position_patterns': ['New Position Title'],
    },
}
```

2. **Run setup command**:
```bash
python manage.py setup_hr_rbac
```

3. **Create Position with this Group** in admin or via script

### Adding New Permissions

1. **Define in model Meta**:
```python
class HREmployee(models.Model):
    class Meta:
        permissions = [
            ('can_new_action', 'Can perform new action'),
        ]
```

2. **Run migrations**:
```bash
python manage.py makemigrations
python manage.py migrate
```

3. **Assign to Groups** via admin or management command

### Adding Department-Based Permissions

To restrict users to their own department:

```python
from floor_app.operations.hr.decorators import login_required

@login_required
def department_view(request, dept_id):
    # Check if user's employee belongs to this department
    if hasattr(request.user, 'hr_employee'):
        if request.user.hr_employee.department_id != dept_id:
            if not request.user.groups.filter(name='hr_managers').exists():
                raise PermissionDenied
    # Continue with view
```

## Best Practices

1. **Always use signals** for User/Group management (not direct view code)
2. **Check permissions** at both view and template level
3. **Log all changes** to audit trail
4. **Test RBAC** with E2E tests after changes
5. **Review audit logs** periodically for security
6. **Keep Groups minimal** - use Position-based mapping
7. **Document custom permissions** clearly

## Security Considerations

1. **Password Security**
   - Use Django's password validators
   - Enforce password rotation policy
   - Implement MFA for sensitive roles

2. **Session Security**
   - Set appropriate session timeout
   - Force re-authentication for sensitive actions

3. **Data Protection**
   - Salary info only visible to authorized roles
   - Personal data (ID, Iqama) requires view permission
   - Audit all data exports

4. **Access Reviews**
   - Regularly review group memberships
   - Check for orphaned User accounts
   - Monitor audit logs for anomalies

## Testing

Run the E2E tests to verify RBAC:

```bash
python manage.py test floor_app.operations.hr.tests.test_employee_creation_e2e
```

Tests cover:
- Complete employee creation flow
- Automatic User creation
- Group assignment based on Position
- Position change updates groups
- Duplicate email handling
- Employee termination deactivates User
- Username uniqueness

## Future Enhancements

1. **Multi-Factor Authentication** for HR managers
2. **Time-based access** (e.g., after-hours restrictions)
3. **IP-based restrictions** for sensitive operations
4. **Data masking** for sensitive fields
5. **Self-service portal** for employees to update their own info
6. **Approval workflows** for permission requests
7. **Automatic group cleanup** for terminated employees
8. **Integration with corporate LDAP/AD**

---

## Quick Reference

### Files Modified/Created

- `models/position.py` - Added auth_group and permission_codenames fields
- `models/audit_log.py` - **NEW** - Audit logging model
- `models/__init__.py` - Added HRAuditLog import
- `signals.py` - **NEW** - User creation and group sync signals
- `apps.py` - **NEW** - App config to register signals
- `__init__.py` - Set default_app_config
- `decorators.py` - **NEW** - Permission decorators
- `management/commands/setup_hr_rbac.py` - **NEW** - RBAC setup command
- `migrations/0026_...` - **NEW** - Add RBAC fields
- `templates/hr/employee_detail.html` - Added User/Permission info section
- `views_employee_wizard.py` - Added missing API endpoints

### Management Commands

```bash
# Setup RBAC system
python manage.py setup_hr_rbac

# With sample data
python manage.py setup_hr_rbac --create-sample-data

# Link existing positions
python manage.py setup_hr_rbac --link-positions
```

### Key Classes

- `EmployeeUserService` - Service layer for User management
- `HRAuditLog` - Audit trail model
- `setup_hr_rbac.Command` - Management command

---

*Document Version: 1.0*
*Last Updated: 2025*
