{% extends "base.html" %}
{% load static %}

{% block title %}Meetings - Meeting Management{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<style>
    .meeting-card {
        transition: all 0.3s ease;
        border-left: 4px solid #dee2e6;
    }
    .meeting-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    .meeting-card.status-PENDING {
        border-left-color: #ffc107;
    }
    .meeting-card.status-APPROVED {
        border-left-color: #0dcaf0;
    }
    .meeting-card.status-CONFIRMED {
        border-left-color: #198754;
    }
    .meeting-card.status-COMPLETED {
        border-left-color: #6c757d;
    }
    .meeting-card.status-CANCELLED {
        border-left-color: #dc3545;
    }
    .calendar-view {
        background: white;
        border-radius: 8px;
        padding: 20px;
    }
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .timeline-item {
        position: relative;
        padding-left: 30px;
        margin-bottom: 20px;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #0d6efd;
    }
    .timeline-item::after {
        content: '';
        position: absolute;
        left: 13px;
        top: 20px;
        width: 2px;
        height: calc(100% + 10px);
        background: #dee2e6;
    }
    .timeline-item:last-child::after {
        display: none;
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <h2><i class="bi bi-calendar-event"></i> Meetings</h2>
            <p class="text-muted">View and manage all meetings</p>
        </div>
        <div class="col-lg-4 text-end">
            <a href="{% url 'meetings:meeting_scheduler' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Schedule New Meeting
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6 class="card-title">Today's Meetings</h6>
                    <h2>{{ stats.today_count|default:0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6 class="card-title">Upcoming</h6>
                    <h2>{{ stats.upcoming_count|default:0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h6 class="card-title">Pending Approval</h6>
                    <h2>{{ stats.pending_count|default:0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h6 class="card-title">This Month</h6>
                    <h2>{{ stats.month_count|default:0 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <form method="get" id="filterForm">
            <div class="row g-3">
                <div class="col-md-2">
                    <label for="status_filter" class="form-label">Status</label>
                    <select class="form-select" id="status_filter" name="status">
                        <option value="">All Status</option>
                        <option value="PENDING">Pending</option>
                        <option value="APPROVED">Approved</option>
                        <option value="CONFIRMED">Confirmed</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="CANCELLED">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="type_filter" class="form-label">Type</label>
                    <select class="form-select" id="type_filter" name="type">
                        <option value="">All Types</option>
                        <option value="INTERNAL">Internal</option>
                        <option value="CLIENT">Client</option>
                        <option value="TRAINING">Training</option>
                        <option value="INTERVIEW">Interview</option>
                        <option value="WORKSHOP">Workshop</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="room_filter" class="form-label">Room</label>
                    <select class="form-select" id="room_filter" name="room">
                        <option value="">All Rooms</option>
                        {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="date_from" class="form-label">From Date</label>
                    <input type="date" class="form-control" id="date_from" name="date_from">
                </div>
                <div class="col-md-2">
                    <label for="date_to" class="form-label">To Date</label>
                    <input type="date" class="form-control" id="date_to" name="date_to">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- View Toggle -->
    <div class="mb-3">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" id="listViewBtn">
                <i class="bi bi-list-ul"></i> List View
            </button>
            <button type="button" class="btn btn-outline-primary" id="calendarViewBtn">
                <i class="bi bi-calendar3"></i> Calendar View
            </button>
            <button type="button" class="btn btn-outline-primary" id="timelineViewBtn">
                <i class="bi bi-clock-history"></i> Timeline View
            </button>
        </div>
    </div>

    <!-- List View -->
    <div id="listView">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">All Meetings</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Meeting #</th>
                                        <th>Title</th>
                                        <th>Room</th>
                                        <th>Date & Time</th>
                                        <th>Organizer</th>
                                        <th>Attendees</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for meeting in meetings %}
                                    <tr>
                                        <td><strong>{{ meeting.booking_number }}</strong></td>
                                        <td>
                                            <div>{{ meeting.title }}</div>
                                            <small class="text-muted">
                                                <span class="badge bg-secondary">{{ meeting.get_meeting_type_display }}</span>
                                            </small>
                                        </td>
                                        <td>
                                            <i class="bi bi-door-open"></i> {{ meeting.room.name }}
                                            <br><small class="text-muted">{{ meeting.room.building }}</small>
                                        </td>
                                        <td>
                                            <i class="bi bi-calendar"></i> {{ meeting.start_time|date:"M d, Y" }}
                                            <br><small><i class="bi bi-clock"></i> {{ meeting.start_time|date:"g:i A" }} - {{ meeting.end_time|date:"g:i A" }}</small>
                                        </td>
                                        <td>{{ meeting.organizer.get_full_name|default:meeting.booked_by.get_full_name }}</td>
                                        <td>
                                            <span class="badge bg-info">
                                                <i class="bi bi-people"></i> {{ meeting.expected_attendees }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if meeting.status == 'PENDING' %}
                                                <span class="badge bg-warning text-dark">Pending</span>
                                            {% elif meeting.status == 'APPROVED' %}
                                                <span class="badge bg-info">Approved</span>
                                            {% elif meeting.status == 'CONFIRMED' %}
                                                <span class="badge bg-success">Confirmed</span>
                                            {% elif meeting.status == 'IN_PROGRESS' %}
                                                <span class="badge bg-primary">In Progress</span>
                                            {% elif meeting.status == 'COMPLETED' %}
                                                <span class="badge bg-secondary">Completed</span>
                                            {% elif meeting.status == 'CANCELLED' %}
                                                <span class="badge bg-danger">Cancelled</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'meetings:meeting_detail' meeting.id %}" class="btn btn-outline-primary" title="View">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <a href="{% url 'meetings:meeting_edit' meeting.id %}" class="btn btn-outline-secondary" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                {% if meeting.status == 'CONFIRMED' %}
                                                <button class="btn btn-outline-success" title="Check-in" onclick="checkIn({{ meeting.id }})">
                                                    <i class="bi bi-check-circle"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
                                            <p class="text-muted mt-2">No meetings found</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                {% if meetings.has_other_pages %}
                <nav class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if meetings.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ meetings.previous_page_number }}">Previous</a>
                        </li>
                        {% endif %}

                        {% for num in meetings.paginator.page_range %}
                        <li class="page-item {% if meetings.number == num %}active{% endif %}">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                        {% endfor %}

                        {% if meetings.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ meetings.next_page_number }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Calendar View -->
    <div id="calendarView" class="d-none">
        <div class="card shadow-sm">
            <div class="card-body calendar-view">
                <div id="fullCalendar"></div>
            </div>
        </div>
    </div>

    <!-- Timeline View -->
    <div id="timelineView" class="d-none">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">Meeting Timeline</h5>
            </div>
            <div class="card-body">
                {% for meeting in meetings %}
                <div class="timeline-item">
                    <div class="card meeting-card status-{{ meeting.status }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6>{{ meeting.title }}</h6>
                                    <p class="text-muted mb-1">
                                        <i class="bi bi-clock"></i> {{ meeting.start_time|date:"M d, Y g:i A" }} - {{ meeting.end_time|date:"g:i A" }}
                                    </p>
                                    <p class="text-muted mb-0">
                                        <i class="bi bi-door-open"></i> {{ meeting.room.name }}
                                        <i class="bi bi-people ms-2"></i> {{ meeting.expected_attendees }} attendees
                                    </p>
                                </div>
                                <span class="badge bg-{{ meeting.status|lower }}">{{ meeting.get_status_display }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted text-center">No meetings in timeline</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View Toggle
    const listViewBtn = document.getElementById('listViewBtn');
    const calendarViewBtn = document.getElementById('calendarViewBtn');
    const timelineViewBtn = document.getElementById('timelineViewBtn');
    const listView = document.getElementById('listView');
    const calendarView = document.getElementById('calendarView');
    const timelineView = document.getElementById('timelineView');

    listViewBtn.addEventListener('click', function() {
        showView('list');
    });

    calendarViewBtn.addEventListener('click', function() {
        showView('calendar');
        if (!window.calendarRendered) {
            renderCalendar();
            window.calendarRendered = true;
        }
    });

    timelineViewBtn.addEventListener('click', function() {
        showView('timeline');
    });

    function showView(view) {
        // Hide all views
        listView.classList.add('d-none');
        calendarView.classList.add('d-none');
        timelineView.classList.add('d-none');

        // Remove active class from all buttons
        listViewBtn.classList.remove('active');
        calendarViewBtn.classList.remove('active');
        timelineViewBtn.classList.remove('active');

        // Show selected view
        if (view === 'list') {
            listView.classList.remove('d-none');
            listViewBtn.classList.add('active');
        } else if (view === 'calendar') {
            calendarView.classList.remove('d-none');
            calendarViewBtn.classList.add('active');
        } else if (view === 'timeline') {
            timelineView.classList.remove('d-none');
            timelineViewBtn.classList.add('active');
        }
    }

    function renderCalendar() {
        const calendarEl = document.getElementById('fullCalendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            events: '/api/meetings/calendar/',
            eventClick: function(info) {
                window.location.href = `/meetings/${info.event.id}/`;
            },
            eventDidMount: function(info) {
                info.el.title = info.event.extendedProps.description;
            }
        });
        calendar.render();
    }

    // Check-in function
    window.checkIn = function(meetingId) {
        if (confirm('Check in to this meeting?')) {
            fetch(`/api/meetings/${meetingId}/check-in/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Checked in successfully');
                    location.reload();
                } else {
                    alert('Check-in failed: ' + data.message);
                }
            });
        }
    };
});
</script>
{% endblock %}
