{% extends "base.html" %}
{% load static %}

{% block title %}Production Routing - Floor Management System{% endblock %}

{% block extra_css %}
<style>
    .routing-header {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }
    .job-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
    }
    .job-info-item {
        padding-bottom: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }
    .job-info-label {
        color: #64748b;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .job-info-value {
        color: #1e293b;
        font-size: 1rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }
    .progress-section {
        margin-bottom: 2rem;
    }
    .progress-bar {
        height: 8px;
        border-radius: 4px;
    }
    .progress-label {
        font-size: 0.875rem;
        color: #64748b;
        margin-top: 0.5rem;
    }
    .routing-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    .routing-table table {
        margin-bottom: 0;
    }
    .routing-table thead {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
    }
    .routing-table th {
        padding: 1rem;
        color: #64748b;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }
    .routing-table td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #e2e8f0;
    }
    .routing-table tbody tr:hover {
        background: #f8fafc;
    }
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        font-size: 0.813rem;
        font-weight: 500;
    }
    .status-pending {
        background: #fef3c7;
        color: #92400e;
    }
    .status-in-progress {
        background: #dbeafe;
        color: #0c4a6e;
    }
    .status-completed {
        background: #dcfce7;
        color: #166534;
    }
    .status-skipped {
        background: #f3f4f6;
        color: #374151;
    }
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .action-buttons .btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.813rem;
    }
    .routing-footer {
        margin-top: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<nav class="container-fluid mt-4" aria-label="breadcrumb">
    <ol class="breadcrumb bg-transparent px-0 mb-3">
        <li class="breadcrumb-item"><a href="{% url 'production:dashboard' %}">Production</a></li>
        <li class="breadcrumb-item"><a href="{% url 'production:jobcard_list' %}">Job Cards</a></li>
        <li class="breadcrumb-item active">Production Routing</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Production Routing</h1>
            <p class="text-muted mb-0">Manage job card production routing steps</p>
        </div>
    </div>

    <!-- Job Card Information Header -->
    <div class="routing-header">
        <h5 class="mb-3">Job Card Information</h5>
        <div class="job-info-grid">
            <div class="job-info-item">
                <div class="job-info-label">Job Card Number</div>
                <div class="job-info-value">{{ job_card.job_card_number }}</div>
            </div>
            <div class="job-info-item">
                <div class="job-info-label">Bit Design</div>
                <div class="job-info-value">{{ job_card.bit_design_revision.design.name }}</div>
            </div>
            <div class="job-info-item">
                <div class="job-info-label">Quantity</div>
                <div class="job-info-value">{{ job_card.quantity }}</div>
            </div>
            <div class="job-info-item">
                <div class="job-info-label">Status</div>
                <div class="job-info-value">
                    <span class="badge bg-primary">{{ job_card.get_status_display }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Routing Completion Progress</h6>
            <span class="progress-percentage">
                {% if total_steps %}
                    {{ completion_percentage }}%
                {% else %}
                    0%
                {% endif %}
            </span>
        </div>
        <div class="progress">
            <div class="progress-bar bg-success" role="progressbar"
                 style="width: {% if total_steps %}{{ completion_percentage }}{% else %}0{% endif %}%;"
                 aria-valuenow="{% if total_steps %}{{ completion_percentage }}{% else %}0{% endif %}"
                 aria-valuemin="0" aria-valuemax="100">
            </div>
        </div>
        <div class="progress-label">
            {% if total_steps %}
                {{ completed_steps }} of {{ total_steps }} steps completed
            {% else %}
                No steps defined yet
            {% endif %}
        </div>
    </div>

    <!-- Routing Steps Table -->
    <div class="routing-table mb-4">
        <table class="table">
            <thead>
                <tr>
                    <th>Sequence</th>
                    <th>Operation</th>
                    <th>Status</th>
                    <th>Operator</th>
                    <th>Started</th>
                    <th>Ended</th>
                    <th>Duration (hrs)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if routing_steps %}
                    {% for step in routing_steps %}
                    <tr>
                        <td>
                            <strong>{{ step.sequence }}</strong>
                        </td>
                        <td>{{ step.operation.name }}</td>
                        <td>
                            <span class="status-badge status-{{ step.status|lower }}">
                                {% if step.status == 'PENDING' %}
                                    <i class="bi bi-clock"></i>
                                {% elif step.status == 'IN_PROGRESS' %}
                                    <i class="bi bi-play-circle"></i>
                                {% elif step.status == 'COMPLETED' %}
                                    <i class="bi bi-check-circle"></i>
                                {% elif step.status == 'SKIPPED' %}
                                    <i class="bi bi-skip-forward-circle"></i>
                                {% endif %}
                                {{ step.get_status_display }}
                            </span>
                        </td>
                        <td>{{ step.operator.get_full_name|default:"—" }}</td>
                        <td>
                            {% if step.started_at %}
                                {{ step.started_at|date:"Y-m-d H:i" }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>
                            {% if step.ended_at %}
                                {{ step.ended_at|date:"Y-m-d H:i" }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>
                            {% if step.duration_hours %}
                                {{ step.duration_hours }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                {% if step.status == 'PENDING' %}
                                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#startStepModal" data-step-id="{{ step.id }}">
                                        <i class="bi bi-play"></i> Start
                                    </button>
                                {% elif step.status == 'IN_PROGRESS' %}
                                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#completeStepModal" data-step-id="{{ step.id }}">
                                        <i class="bi bi-check"></i> Complete
                                    </button>
                                    <button class="btn btn-sm btn-warning">
                                        <i class="bi bi-skip-forward"></i> Skip
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            No routing steps defined yet.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Footer Actions -->
    <div class="routing-footer">
        <a href="{% url 'production:routing_add_step' job_card.id %}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> Add Step
        </a>
        <div>
            <a href="{% url 'production:jobcard_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Job Cards
            </a>
        </div>
    </div>
</div>

<!-- Start Step Modal -->
<div class="modal fade" id="startStepModal" tabindex="-1" aria-labelledby="startStepModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="startStepModalLabel">Start Routing Step</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="startStepForm">
                    <div class="mb-3">
                        <label for="operatorSelect" class="form-label">Operator <span class="text-danger">*</span></label>
                        <select class="form-select" id="operatorSelect" name="operator" required>
                            <option value="">Select an operator...</option>
                            {% for operator in operators %}
                            <option value="{{ operator.id }}">{{ operator.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <input type="hidden" id="stepIdInput" name="step_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="startStepForm" class="btn btn-primary">Start Step</button>
            </div>
        </div>
    </div>
</div>

<!-- Complete Step Modal -->
<div class="modal fade" id="completeStepModal" tabindex="-1" aria-labelledby="completeStepModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeStepModalLabel">Complete Routing Step</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="completeStepForm">
                    <div class="mb-3">
                        <label for="resultNotes" class="form-label">Result Notes</label>
                        <textarea class="form-control" id="resultNotes" name="result_notes" rows="4" placeholder="Enter any notes about the completed step..."></textarea>
                    </div>
                    <input type="hidden" id="completeStepIdInput" name="step_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="completeStepForm" class="btn btn-success">Complete Step</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Start Step Modal
        const startStepModal = document.getElementById('startStepModal');
        if (startStepModal) {
            startStepModal.addEventListener('show.bs.modal', function(e) {
                const button = e.relatedTarget;
                const stepId = button.getAttribute('data-step-id');
                document.getElementById('stepIdInput').value = stepId;
            });
        }

        // Handle Complete Step Modal
        const completeStepModal = document.getElementById('completeStepModal');
        if (completeStepModal) {
            completeStepModal.addEventListener('show.bs.modal', function(e) {
                const button = e.relatedTarget;
                const stepId = button.getAttribute('data-step-id');
                document.getElementById('completeStepIdInput').value = stepId;
            });
        }

        // Form submission handlers (would need corresponding backend endpoints)
        const startStepForm = document.getElementById('startStepForm');
        if (startStepForm) {
            startStepForm.addEventListener('submit', function(e) {
                e.preventDefault();
                // Handle form submission
                console.log('Start step submitted');
            });
        }

        const completeStepForm = document.getElementById('completeStepForm');
        if (completeStepForm) {
            completeStepForm.addEventListener('submit', function(e) {
                e.preventDefault();
                // Handle form submission
                console.log('Complete step submitted');
            });
        }
    });
</script>
{% endblock %}
