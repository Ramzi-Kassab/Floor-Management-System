{% extends "base.html" %}

{% block title %}QR Code Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-qr-code"></i> QR Code: {{ qcode.token_short }}</h1>
        <div>
            <a href="{% url 'qrcodes:list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- QR Code Image -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">QR Code Image</h5>
                </div>
                <div class="card-body text-center">
                    <img src="{% url 'qrcodes:image' token=qcode.token format='png' %}"
                         alt="QR Code" class="img-fluid mb-3" style="max-width: 250px;">
                    <div class="d-grid gap-2">
                        <a href="{% url 'qrcodes:image' token=qcode.token format='png' %}"
                           class="btn btn-outline-primary" download>
                            <i class="bi bi-download"></i> Download PNG
                        </a>
                        <a href="{% url 'qrcodes:image' token=qcode.token format='svg' %}"
                           class="btn btn-outline-primary" download>
                            <i class="bi bi-download"></i> Download SVG
                        </a>
                        <a href="{% url 'qrcodes:label_image' token=qcode.token %}"
                           class="btn btn-outline-primary" download>
                            <i class="bi bi-tag"></i> Download with Label
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- QCode Details -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Token</dt>
                        <dd class="col-sm-9"><code>{{ qcode.token }}</code></dd>

                        <dt class="col-sm-3">Type</dt>
                        <dd class="col-sm-9">{{ qcode.get_qcode_type_display }}</dd>

                        <dt class="col-sm-3">Label</dt>
                        <dd class="col-sm-9">{{ qcode.label|default:"-" }}</dd>

                        <dt class="col-sm-3">Description</dt>
                        <dd class="col-sm-9">{{ qcode.description|default:"-" }}</dd>

                        <dt class="col-sm-3">Status</dt>
                        <dd class="col-sm-9">
                            {% if qcode.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Code Format</dt>
                        <dd class="col-sm-9">{{ qcode.get_code_format_display }}</dd>

                        <dt class="col-sm-3">Version</dt>
                        <dd class="col-sm-9">{{ qcode.version }}</dd>

                        <dt class="col-sm-3">Target Object</dt>
                        <dd class="col-sm-9">{{ qcode.content_type }} #{{ qcode.object_id }}</dd>

                        <dt class="col-sm-3">Scan Count</dt>
                        <dd class="col-sm-9">{{ qcode.scan_count }}</dd>

                        <dt class="col-sm-3">Last Scanned</dt>
                        <dd class="col-sm-9">
                            {% if qcode.last_scanned_at %}
                            {{ qcode.last_scanned_at|date:"M d, Y H:i" }}
                            {% if qcode.last_scanned_by %}
                            by {{ qcode.last_scanned_by }}
                            {% endif %}
                            {% else %}
                            <span class="text-muted">Never scanned</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Created</dt>
                        <dd class="col-sm-9">
                            {{ qcode.created_at|date:"M d, Y H:i" }}
                            {% if qcode.created_by %}by {{ qcode.created_by }}{% endif %}
                        </dd>

                        {% if not qcode.is_active %}
                        <dt class="col-sm-3">Deactivated</dt>
                        <dd class="col-sm-9">
                            {{ qcode.deactivated_at|date:"M d, Y H:i" }}
                            {% if qcode.deactivated_by %}by {{ qcode.deactivated_by }}{% endif %}
                            {% if qcode.deactivation_reason %}
                            <br><small class="text-muted">Reason: {{ qcode.deactivation_reason }}</small>
                            {% endif %}
                        </dd>
                        {% endif %}
                    </dl>

                    <!-- Actions -->
                    <hr>
                    <div class="d-flex gap-2">
                        {% if qcode.is_active %}
                        <a href="{% url 'qrcodes:deactivate' token=qcode.token %}" class="btn btn-warning">
                            <i class="bi bi-x-circle"></i> Deactivate
                        </a>
                        {% else %}
                        <a href="{% url 'qrcodes:reactivate' token=qcode.token %}" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Reactivate
                        </a>
                        {% endif %}
                        <a href="{% url 'qrcodes:regenerate' token=qcode.token %}" class="btn btn-danger">
                            <i class="bi bi-arrow-repeat"></i> Regenerate Token
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Scans -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Scans</h5>
        </div>
        <div class="card-body">
            {% if recent_scans %}
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action</th>
                            <th>User</th>
                            <th>Device</th>
                            <th>IP</th>
                            <th>Status</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scan in recent_scans %}
                        <tr>
                            <td>{{ scan.scan_timestamp|date:"M d, H:i:s" }}</td>
                            <td>{{ scan.get_action_type_display }}</td>
                            <td>{{ scan.scanner_display_name }}</td>
                            <td>{{ scan.get_scanner_device_type_display }}</td>
                            <td><code>{{ scan.scanner_ip|default:"-" }}</code></td>
                            <td>
                                {% if scan.success %}
                                <span class="badge bg-success">OK</span>
                                {% else %}
                                <span class="badge bg-danger">Failed</span>
                                {% endif %}
                            </td>
                            <td><small>{{ scan.message|truncatechars:50 }}</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No scan history available.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
