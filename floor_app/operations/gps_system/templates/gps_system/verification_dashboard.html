{% extends "base.html" %}
{% load static %}

{% block title %}GPS Verification Dashboard{% endblock %}

{% block extra_css %}
<style>
    #verificationMap { height: 450px; border-radius: 12px; }
    .zone-card { border-left: 4px solid #0d6efd; cursor: pointer; transition: all 0.3s ease; }
    .zone-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
    .verification-badge { padding: 0.5rem 1rem; border-radius: 8px; font-weight: 500; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-geo-alt-fill text-primary me-2"></i>GPS Verification Dashboard</h2>
                    <p class="text-muted mb-0">Monitor location verification and GPS zones</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'gps_system:zone_form' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>Create Zone
                    </a>
                    <a href="{% url 'gps_system:verification_request' %}" class="btn btn-success">
                        <i class="bi bi-geo me-2"></i>Request Verification
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fs-4 fw-bold text-primary">{{ total_zones }}</div>
                            <div class="text-muted small">GPS Zones</div>
                        </div>
                        <i class="bi bi-map text-primary opacity-25" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fs-4 fw-bold text-success">{{ verified_today }}</div>
                            <div class="text-muted small">Verified Today</div>
                        </div>
                        <i class="bi bi-check-circle text-success opacity-25" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fs-4 fw-bold text-warning">{{ pending_verifications }}</div>
                            <div class="text-muted small">Pending</div>
                        </div>
                        <i class="bi bi-clock text-warning opacity-25" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fs-4 fw-bold text-danger">{{ failed_verifications }}</div>
                            <div class="text-muted small">Failed</div>
                        </div>
                        <i class="bi bi-x-circle text-danger opacity-25" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Map -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-map me-2"></i>GPS Zones Map</h5>
                </div>
                <div class="card-body p-0">
                    <div id="verificationMap"></div>
                </div>
            </div>
        </div>

        <!-- Active Zones -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Active GPS Zones</h6>
                </div>
                <div class="card-body p-0" style="max-height: 450px; overflow-y: auto;">
                    {% for zone in active_zones %}
                    <div class="zone-card p-3 border-bottom" onclick="focusZone({{ zone.id }}, {{ zone.latitude }}, {{ zone.longitude }})">
                        <div class="fw-semibold">{{ zone.name }}</div>
                        <div class="small text-muted">{{ zone.description|truncatewords:10 }}</div>
                        <div class="mt-2 d-flex gap-2">
                            <span class="badge bg-primary-subtle text-primary">Radius: {{ zone.radius }}m</span>
                            <span class="badge bg-success-subtle text-success">{{ zone.verifications_today }} verifications today</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-map fs-2"></i>
                        <p class="mb-0 mt-2">No zones configured</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Verifications -->
    <div class="card border-0 shadow-sm mt-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Verifications</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Employee</th>
                            <th>Zone</th>
                            <th>Coordinates</th>
                            <th>Status</th>
                            <th>Distance</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for verification in recent_verifications %}
                        <tr>
                            <td><strong>{{ verification.employee.person.get_full_name_en }}</strong></td>
                            <td>{{ verification.zone.name }}</td>
                            <td class="small"><code>{{ verification.latitude }}, {{ verification.longitude }}</code></td>
                            <td>
                                {% if verification.is_verified %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle me-1"></i>Verified
                                </span>
                                {% else %}
                                <span class="badge bg-danger">
                                    <i class="bi bi-x-circle me-1"></i>Failed
                                </span>
                                {% endif %}
                            </td>
                            <td>{{ verification.distance_from_zone }}m</td>
                            <td>{{ verification.created_at|timesince }} ago</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewOnMap({{ verification.latitude }}, {{ verification.longitude }})">
                                    <i class="bi bi-geo-alt"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">No recent verifications</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Initialize map
var map = L.map('verificationMap').setView([24.7136, 46.6753], 10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// Add zone circles
{% for zone in active_zones %}
var circle = L.circle([{{ zone.latitude }}, {{ zone.longitude }}], {
    color: '{% if zone.is_active %}#0d6efd{% else %}#6c757d{% endif %}',
    fillColor: '{% if zone.is_active %}#0d6efd{% else %}#6c757d{% endif %}',
    fillOpacity: 0.2,
    radius: {{ zone.radius }}
}).addTo(map);

circle.bindPopup('<strong>{{ zone.name }}</strong><br>Radius: {{ zone.radius }}m');
{% endfor %}

function focusZone(id, lat, lng) {
    map.setView([lat, lng], 15);
}

function viewOnMap(lat, lng) {
    map.setView([lat, lng], 16);
    L.marker([lat, lng]).addTo(map).openPopup();
}
</script>
{% endblock %}
