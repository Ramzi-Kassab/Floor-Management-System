{% extends "base.html" %}
{% load static %}

{% block title %}{% if zone %}Edit{% else %}Create{% endif %} GPS Zone{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #zoneMap { height: 400px; border-radius: 12px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h4 class="mb-0"><i class="bi bi-map-fill me-2"></i>{% if zone %}Edit{% else %}Create{% endif %} GPS Zone</h4>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Zone Name</label>
                            <input type="text" class="form-control" name="name" value="{{ zone.name }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="2">{{ zone.description }}</textarea>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Latitude</label>
                                <input type="number" step="0.000001" class="form-control" name="latitude" id="latitude" value="{{ zone.latitude }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Longitude</label>
                                <input type="number" step="0.000001" class="form-control" name="longitude" id="longitude" value="{{ zone.longitude }}" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Radius (meters)</label>
                            <input type="number" class="form-control" name="radius" id="radius" value="{{ zone.radius|default:100 }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Location on Map</label>
                            <div id="zoneMap"></div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="is_active" id="isActive" {% if zone.is_active or not zone %}checked{% endif %}>
                            <label class="form-check-label" for="isActive">Active</label>
                        </div>
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'gps_system:zone_list' %}" class="btn btn-outline-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>Save Zone
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
var map = L.map('zoneMap').setView([24.7136, 46.6753], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

var marker = null;
var circle = null;

map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    updateMarker(lat, lng);
});

function updateMarker(lat, lng) {
    if (marker) map.removeLayer(marker);
    if (circle) map.removeLayer(circle);

    marker = L.marker([lat, lng]).addTo(map);
    const radius = parseInt(document.getElementById('radius').value || 100);
    circle = L.circle([lat, lng], { radius: radius, color: '#0d6efd', fillOpacity: 0.2 }).addTo(map);
}

document.getElementById('radius').addEventListener('input', function() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    if (lat && lng) updateMarker(lat, lng);
});
</script>
{% endblock %}
