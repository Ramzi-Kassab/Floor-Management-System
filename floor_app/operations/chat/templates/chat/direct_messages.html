{% extends "base.html" %}
{% load static %}

{% block title %}Direct Messages{% endblock %}

{% block extra_css %}
<style>
    .dm-container { display: flex; height: calc(100vh - 200px); }
    .contacts-sidebar { width: 320px; border-right: 1px solid #dee2e6; background: #f8f9fa; overflow-y: auto; }
    .dm-main { flex: 1; display: flex; flex-direction: column; background: white; }
    .contact-item { padding: 1rem; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: all 0.2s; }
    .contact-item:hover { background: white; }
    .contact-item.active { background: white; border-left: 4px solid #0d6efd; }
    .contact-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.2rem; margin-right: 12px; }
    .contact-info { flex: 1; min-width: 0; }
    .contact-name { font-weight: 600; margin-bottom: 2px; }
    .contact-status { font-size: 0.75rem; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .online-indicator { width: 10px; height: 10px; border-radius: 50%; background: #28a745; border: 2px solid white; position: absolute; bottom: 2px; right: 2px; }
    .dm-header { padding: 1rem 1.5rem; border-bottom: 1px solid #dee2e6; background: white; }
    .messages-area { flex: 1; overflow-y: auto; padding: 1.5rem; background: #f8f9fa; }
    .message-bubble { max-width: 70%; margin-bottom: 1rem; }
    .message-bubble.own { margin-left: auto; }
    .message-bubble.other { margin-right: auto; }
    .message-content { padding: 0.75rem 1rem; border-radius: 1rem; }
    .message-bubble.own .message-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px; }
    .message-bubble.other .message-content { background: white; border: 1px solid #dee2e6; border-bottom-left-radius: 4px; }
    .message-time { font-size: 0.7rem; padding: 0 0.5rem; margin-top: 4px; opacity: 0.7; }
    .message-input-area { padding: 1rem 1.5rem; border-top: 1px solid #dee2e6; background: white; }
    .message-input { display: flex; gap: 12px; align-items: center; }
    .message-input input { flex: 1; border: 1px solid #dee2e6; border-radius: 24px; padding: 0.75rem 1.25rem; }
    .typing-indicator { padding: 0.5rem 1rem; color: #6c757d; font-size: 0.85rem; font-style: italic; }
    .unread-badge { background: #dc3545; color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; font-weight: 600; }
    .search-box { padding: 1rem; border-bottom: 1px solid #dee2e6; }
    .search-box input { width: 100%; border: 1px solid #dee2e6; border-radius: 20px; padding: 0.5rem 1rem; font-size: 0.9rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4"><i class="bi bi-chat-text me-2"></i>Direct Messages</h2>

    <div class="card border-0 shadow-sm">
        <div class="dm-container">
            <!-- Contacts Sidebar -->
            <div class="contacts-sidebar">
                <div class="search-box">
                    <input type="text" id="searchContacts" placeholder="Search contacts..." class="form-control">
                </div>

                <div id="contactsList">
                    {% for contact in contacts %}
                    <div class="contact-item {% if contact.id == active_contact.id %}active{% endif %}"
                         onclick="location.href='{% url 'chat:direct_message' contact.id %}'">
                        <div class="d-flex align-items-center">
                            <div class="position-relative">
                                <div class="contact-avatar">
                                    {{ contact.get_full_name|slice:":1"|upper }}
                                </div>
                                {% if contact.is_online %}
                                <div class="online-indicator"></div>
                                {% endif %}
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">{{ contact.get_full_name }}</div>
                                <div class="contact-status">
                                    {% if contact.last_message %}
                                        {{ contact.last_message|truncatechars:40 }}
                                    {% else %}
                                        No messages yet
                                    {% endif %}
                                </div>
                            </div>
                            {% if contact.unread_count > 0 %}
                            <span class="unread-badge">{{ contact.unread_count }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-person-x fs-1 d-block mb-2"></i>
                        No contacts yet
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Direct Message Area -->
            <div class="dm-main">
                {% if active_contact %}
                <!-- DM Header -->
                <div class="dm-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="position-relative me-3">
                                <div class="contact-avatar" style="width: 40px; height: 40px; font-size: 1rem;">
                                    {{ active_contact.get_full_name|slice:":1"|upper }}
                                </div>
                                {% if active_contact.is_online %}
                                <div class="online-indicator"></div>
                                {% endif %}
                            </div>
                            <div>
                                <h5 class="mb-0">{{ active_contact.get_full_name }}</h5>
                                <small class="text-muted">
                                    {% if active_contact.is_online %}
                                        <i class="bi bi-circle-fill text-success" style="font-size: 0.5rem;"></i> Online
                                    {% else %}
                                        Last seen {{ active_contact.last_seen|timesince }} ago
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#"><i class="bi bi-person-circle me-2"></i>View Profile</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-bell-slash me-2"></i>Mute</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-archive me-2"></i>Archive</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash me-2"></i>Delete Chat</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="messages-area" id="messagesArea">
                    {% for message in messages %}
                    <div class="message-bubble {% if message.sender == request.user %}own{% else %}other{% endif %}">
                        <div class="message-content">
                            {{ message.content }}
                        </div>
                        <div class="message-time text-{% if message.sender == request.user %}end{% else %}start{% endif %}">
                            {{ message.created_at|date:"h:i A" }}
                            {% if message.sender == request.user %}
                                {% if message.is_read %}
                                    <i class="bi bi-check-all text-primary"></i>
                                {% else %}
                                    <i class="bi bi-check"></i>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    {{ active_contact.get_full_name }} is typing...
                </div>

                <!-- Message Input -->
                <div class="message-input-area">
                    <form method="post" id="messageForm" class="message-input">
                        {% csrf_token %}
                        <button type="button" class="btn btn-light rounded-circle" data-bs-toggle="dropdown">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-paperclip me-2"></i>Attach File</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-image me-2"></i>Send Image</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-camera-video me-2"></i>Send Video</a></li>
                        </ul>
                        <input type="text" name="message" id="messageInput" placeholder="Type a message..." required autocomplete="off">
                        <button type="submit" class="btn btn-primary rounded-circle">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                </div>
                {% else %}
                <!-- No Contact Selected -->
                <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                    <div class="text-center">
                        <i class="bi bi-chat-text fs-1 d-block mb-3" style="font-size: 4rem;"></i>
                        <h5>Select a contact to start messaging</h5>
                        <p>Choose from your contacts on the left</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-scroll to bottom
const messagesArea = document.getElementById('messagesArea');
if (messagesArea) {
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

// Send message via AJAX
document.getElementById('messageForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) return;

    fetch('{% url "chat:send_dm" active_contact.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            input.value = '';
            location.reload(); // In production, append message via JS instead
        }
    });
});

// Search contacts
document.getElementById('searchContacts')?.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    document.querySelectorAll('.contact-item').forEach(item => {
        const name = item.querySelector('.contact-name').textContent.toLowerCase();
        item.style.display = name.includes(query) ? 'block' : 'none';
    });
});

// Auto-refresh for new messages (every 5 seconds)
{% if active_contact %}
setInterval(() => {
    // In production, use WebSockets instead
    location.reload();
}, 5000);
{% endif %}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
