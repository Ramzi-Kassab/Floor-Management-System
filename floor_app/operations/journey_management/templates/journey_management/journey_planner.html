{% extends "base.html" %}
{% load static %}

{% block title %}Journey Planner{% endblock %}

{% block extra_css %}
<style>
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }
    .step {
        flex: 1;
        text-align: center;
        position: relative;
    }
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        border: 3px solid #e9ecef;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #6c757d;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 2;
    }
    .step.active .step-circle {
        background: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }
    .step.completed .step-circle {
        background: #198754;
        border-color: #198754;
        color: white;
    }
    .step-label {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .step.active .step-label {
        color: #0d6efd;
        font-weight: bold;
    }
    .step-connector {
        position: absolute;
        top: 20px;
        left: 50%;
        right: -50%;
        height: 3px;
        background: #e9ecef;
        z-index: 1;
    }
    .step.completed .step-connector {
        background: #198754;
    }
    .step:last-child .step-connector {
        display: none;
    }
    .form-section {
        display: none;
    }
    .form-section.active {
        display: block;
    }
    .waypoint-item {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
    }
    .risk-info-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    @media (max-width: 768px) {
        .step-label {
            font-size: 0.75rem;
        }
        .step-circle {
            width: 30px;
            height: 30px;
            font-size: 0.875rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-2"><i class="bi bi-map-fill"></i> Journey Planner</h2>
            <p class="text-muted">Plan and submit a new field operations journey</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="{% url 'journey_management:journey_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-connector"></div>
            <div class="step-label">Journey Details</div>
        </div>
        <div class="step" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-connector"></div>
            <div class="step-label">Route & Waypoints</div>
        </div>
        <div class="step" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-connector"></div>
            <div class="step-label">Vehicle & Personnel</div>
        </div>
        <div class="step" data-step="4">
            <div class="step-circle">4</div>
            <div class="step-connector"></div>
            <div class="step-label">Risk Assessment</div>
        </div>
        <div class="step" data-step="5">
            <div class="step-circle">5</div>
            <div class="step-label">Review & Submit</div>
        </div>
    </div>

    <!-- Journey Planning Form -->
    <form method="post" id="journeyPlanForm" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Step 1: Journey Details -->
        <div class="form-section active" data-section="1">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Step 1: Journey Details</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="title" class="form-label">Journey Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label for="purpose_category" class="form-label">Purpose Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="purpose_category" name="purpose_category" required>
                                <option value="">Select purpose...</option>
                                <option value="SITE_VISIT">Site Visit</option>
                                <option value="CLIENT_MEETING">Client Meeting</option>
                                <option value="INSPECTION">Inspection</option>
                                <option value="DELIVERY">Delivery</option>
                                <option value="TRAINING">Training</option>
                                <option value="MAINTENANCE">Maintenance</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="planned_departure_time" class="form-label">Planned Departure <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="planned_departure_time" name="planned_departure_time" required>
                        </div>
                        <div class="col-md-6">
                            <label for="planned_return_time" class="form-label">Planned Return <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="planned_return_time" name="planned_return_time" required>
                        </div>
                        <div class="col-md-6">
                            <label for="estimated_cost" class="form-label">Estimated Cost</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="estimated_cost" name="estimated_cost" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Route & Waypoints -->
        <div class="form-section" data-section="2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Step 2: Route & Waypoints</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="departure_location" class="form-label">Departure Location <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="departure_location" name="departure_location" required>
                            <small class="text-muted">Starting point of journey</small>
                        </div>
                        <div class="col-md-6">
                            <label for="destination" class="form-label">Destination <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="destination" name="destination" required>
                            <small class="text-muted">Final destination</small>
                        </div>
                        <div class="col-md-6">
                            <label for="estimated_distance_km" class="form-label">Estimated Distance (km)</label>
                            <input type="number" class="form-control" id="estimated_distance_km" name="estimated_distance_km" step="0.1" min="0">
                        </div>
                        <div class="col-12">
                            <label for="route_description" class="form-label">Route Description</label>
                            <textarea class="form-control" id="route_description" name="route_description" rows="3" placeholder="Describe the planned route..."></textarea>
                        </div>
                    </div>

                    <hr>

                    <h6 class="mb-3">Waypoints/Stops (Optional)</h6>
                    <div id="waypointsContainer"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="addWaypointBtn">
                        <i class="bi bi-plus-circle"></i> Add Waypoint
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Vehicle & Personnel -->
        <div class="form-section" data-section="3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Step 3: Vehicle & Personnel</h5>
                </div>
                <div class="card-body">
                    <h6 class="mb-3">Vehicle Information</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="vehicle_type" class="form-label">Vehicle Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="vehicle_type" name="vehicle_type" required>
                                <option value="">Select vehicle type...</option>
                                <option value="COMPANY_VEHICLE">Company Vehicle</option>
                                <option value="RENTAL">Rental Vehicle</option>
                                <option value="PERSONAL">Personal Vehicle</option>
                                <option value="PUBLIC_TRANSPORT">Public Transport</option>
                                <option value="FLIGHT">Flight</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="vehicle_number" class="form-label">Vehicle Number/ID</label>
                            <input type="text" class="form-control" id="vehicle_number" name="vehicle_number" placeholder="License plate or ID">
                        </div>
                    </div>

                    <hr>

                    <h6 class="mb-3">Emergency Contact</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="emergency_contact_name" class="form-label">Contact Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="emergency_contact_name" name="emergency_contact_name" required>
                        </div>
                        <div class="col-md-4">
                            <label for="emergency_contact_phone" class="form-label">Contact Phone <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="emergency_contact_phone" name="emergency_contact_phone" required>
                        </div>
                        <div class="col-md-4">
                            <label for="emergency_contact_relationship" class="form-label">Relationship</label>
                            <input type="text" class="form-control" id="emergency_contact_relationship" name="emergency_contact_relationship" placeholder="e.g., Spouse, Manager">
                        </div>
                        <div class="col-12">
                            <label for="medical_conditions" class="form-label">Medical Conditions</label>
                            <textarea class="form-control" id="medical_conditions" name="medical_conditions" rows="2" placeholder="Any medical conditions to be aware of..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Risk Assessment -->
        <div class="form-section" data-section="4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Step 4: Risk Assessment</h5>
                </div>
                <div class="card-body">
                    <div class="risk-info-box">
                        <p class="mb-0"><strong><i class="bi bi-info-circle"></i> Important:</strong> Complete risk assessment is required for all field journeys to ensure safety.</p>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="risk_level" class="form-label">Overall Risk Level <span class="text-danger">*</span></label>
                            <select class="form-select" id="risk_level" name="risk_level" required>
                                <option value="LOW">Low Risk</option>
                                <option value="MEDIUM">Medium Risk</option>
                                <option value="HIGH">High Risk</option>
                                <option value="CRITICAL">Critical Risk</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="risk_assessment" class="form-label">Risk Assessment</label>
                            <textarea class="form-control" id="risk_assessment" name="risk_assessment" rows="4" placeholder="Describe identified risks and potential hazards..."></textarea>
                        </div>
                        <div class="col-12">
                            <label for="mitigation_measures" class="form-label">Mitigation Measures</label>
                            <textarea class="form-control" id="mitigation_measures" name="mitigation_measures" rows="4" placeholder="Describe measures taken to mitigate identified risks..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: Review & Submit -->
        <div class="form-section" data-section="5">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Step 5: Review & Submit</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Please review all details before submitting. You can save as draft and edit later.
                    </div>

                    <div id="reviewSummary">
                        <!-- Summary will be populated by JavaScript -->
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-12">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="confirmAccuracy" required>
                                <label class="form-check-label" for="confirmAccuracy">
                                    I confirm that all information provided is accurate and complete
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="card mt-3">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                        <i class="bi bi-arrow-left"></i> Previous
                    </button>
                    <div class="ms-auto">
                        <button type="button" class="btn btn-outline-secondary me-2" id="saveDraftBtn">
                            <i class="bi bi-save"></i> Save as Draft
                        </button>
                        <button type="button" class="btn btn-primary" id="nextBtn">
                            Next <i class="bi bi-arrow-right"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                            <i class="bi bi-check-circle"></i> Submit for Approval
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
const totalSteps = 5;
let waypointCount = 0;

// Step Navigation
document.getElementById('nextBtn').addEventListener('click', function() {
    if (validateStep(currentStep)) {
        if (currentStep < totalSteps) {
            currentStep++;
            showStep(currentStep);
        }
    }
});

document.getElementById('prevBtn').addEventListener('click', function() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
});

function showStep(step) {
    // Hide all sections
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });

    // Show current section
    document.querySelector(`[data-section="${step}"]`).classList.add('active');

    // Update step indicator
    document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 < step) {
            stepEl.classList.add('completed');
        } else if (index + 1 === step) {
            stepEl.classList.add('active');
        }
    });

    // Update buttons
    document.getElementById('prevBtn').style.display = step === 1 ? 'none' : 'inline-block';
    document.getElementById('nextBtn').style.display = step === totalSteps ? 'none' : 'inline-block';
    document.getElementById('submitBtn').style.display = step === totalSteps ? 'inline-block' : 'none';

    // If on review step, populate summary
    if (step === totalSteps) {
        populateReview();
    }

    // Scroll to top
    window.scrollTo(0, 0);
}

function validateStep(step) {
    const section = document.querySelector(`[data-section="${step}"]`);
    const requiredFields = section.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });

    if (!isValid) {
        alert('Please fill in all required fields');
    }

    return isValid;
}

function populateReview() {
    const summary = document.getElementById('reviewSummary');
    const formData = new FormData(document.getElementById('journeyPlanForm'));

    let html = '<div class="row g-3">';
    html += '<div class="col-md-6"><strong>Journey Title:</strong><br>' + formData.get('title') + '</div>';
    html += '<div class="col-md-6"><strong>Purpose:</strong><br>' + document.getElementById('purpose_category').selectedOptions[0].text + '</div>';
    html += '<div class="col-md-6"><strong>From:</strong><br>' + formData.get('departure_location') + '</div>';
    html += '<div class="col-md-6"><strong>To:</strong><br>' + formData.get('destination') + '</div>';
    html += '<div class="col-md-6"><strong>Departure:</strong><br>' + formData.get('planned_departure_time') + '</div>';
    html += '<div class="col-md-6"><strong>Return:</strong><br>' + formData.get('planned_return_time') + '</div>';
    html += '<div class="col-md-6"><strong>Vehicle:</strong><br>' + document.getElementById('vehicle_type').selectedOptions[0].text + '</div>';
    html += '<div class="col-md-6"><strong>Risk Level:</strong><br>' + document.getElementById('risk_level').selectedOptions[0].text + '</div>';
    html += '</div>';

    summary.innerHTML = html;
}

// Add Waypoint functionality
document.getElementById('addWaypointBtn').addEventListener('click', function() {
    waypointCount++;
    const container = document.getElementById('waypointsContainer');

    const waypointHtml = `
        <div class="waypoint-item" data-waypoint="${waypointCount}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Waypoint ${waypointCount}</h6>
                <button type="button" class="btn btn-sm btn-outline-danger remove-waypoint">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="text" class="form-control form-control-sm" name="waypoint_${waypointCount}_location" placeholder="Location name">
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control form-control-sm" name="waypoint_${waypointCount}_purpose" placeholder="Purpose of stop">
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', waypointHtml);
});

// Remove waypoint
document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-waypoint')) {
        e.target.closest('.waypoint-item').remove();
    }
});

// Save as Draft
document.getElementById('saveDraftBtn').addEventListener('click', function() {
    const form = document.getElementById('journeyPlanForm');
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'save_as_draft';
    input.value = '1';
    form.appendChild(input);
    form.submit();
});

// Remove invalid class on input
document.querySelectorAll('input, select, textarea').forEach(field => {
    field.addEventListener('input', function() {
        this.classList.remove('is-invalid');
    });
});
</script>
{% endblock %}
